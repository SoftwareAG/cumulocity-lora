var NavigatorNodeComponent_1;
import * as tslib_1 from "tslib";
// tslint:disable-next-line:max-line-length
import { Component, ComponentFactoryResolver, Input, QueryList, ViewChild, ViewChildren, ViewContainerRef, Output, EventEmitter, OnDestroy, HostListener } from '@angular/core';
import { RouterLinkActive } from '@angular/router';
import { NavigatorIconComponent } from './navigator-icon.component';
import { NavigatorService } from './navigator.service';
import { PopoverConfirmComponent } from '../modal/popover-confirm.component';
let NavigatorNodeComponent = NavigatorNodeComponent_1 = class NavigatorNodeComponent {
    constructor(componentFactoryResolver, navigator) {
        this.componentFactoryResolver = componentFactoryResolver;
        this.navigator = navigator;
        this.nodeClick = new EventEmitter();
    }
    ngAfterViewInit() {
        this.childrenNodes.forEach((n) => n.parentNode = this);
        this.viewInitTimeout = setTimeout(() => {
            this.updateIcon();
            this.openOnFirstUrl();
            this.expandParentIfActive();
            this.node.confirm = this.confirm;
        });
    }
    openOnFirstUrl() {
        if (this.navigator.openOnFirstUrl(this.node) && !this.node.open) {
            this.expandCollapse(true);
        }
    }
    get expandTitle() {
        return !this.node.open ? 'Expand' : 'Collapse';
    }
    click(from = 'link', $event) {
        let open;
        if (from === 'expander') {
            if ($event) {
                $event.stopPropagation();
                $event.preventDefault();
            }
            open = !this.node.open;
        }
        else {
            open = this.routerLinkActive && this.routerLinkActive.isActive ? true : !this.node.open;
        }
        if (open !== this.node.open) {
            this.expandCollapse(open, false, { [from]: true, $event });
        }
        this.nodeClick.emit(from);
    }
    expandCollapse(open, recursive, forNode = {}) {
        this.node.open = open;
        // Also close children
        if (recursive) {
            this.childrenNodes.forEach((n) => n.expandCollapse(open, recursive));
        }
        forNode.open = open;
        this.node.click(forNode);
    }
    ngOnDestroy() {
        clearTimeout(this.viewInitTimeout);
        this.node.destroy();
    }
    expandParentIfActive() {
        if (this.routerLinkActive && this.routerLinkActive.isActive && this.parentNode) {
            this.parentNode.expandCollapse(true);
        }
    }
    updateIcon() {
        if (this.node.iconTemplate) {
            this.updateIconTemplate();
        }
        else {
            this.updateIconComponent();
        }
    }
    updateIconComponent() {
        let componentType = NavigatorIconComponent;
        if (this.node && this.node.iconComponent) {
            componentType = this.node.iconComponent;
        }
        this.iconSlot.clear();
        const iconComponentFactory = this.componentFactoryResolver.resolveComponentFactory(componentType);
        const componentRef = this.iconSlot.createComponent(iconComponentFactory);
        componentRef.instance.node = this.node;
    }
    updateIconTemplate() {
        this.iconSlot.clear();
        this.iconSlot.createEmbeddedView(this.node.iconTemplate);
    }
};
NavigatorNodeComponent.ctorParameters = () => [
    { type: ComponentFactoryResolver },
    { type: NavigatorService }
];
tslib_1.__decorate([
    ViewChild('icon', { read: ViewContainerRef, static: false })
], NavigatorNodeComponent.prototype, "iconSlot", void 0);
tslib_1.__decorate([
    Input()
], NavigatorNodeComponent.prototype, "node", void 0);
tslib_1.__decorate([
    Input()
], NavigatorNodeComponent.prototype, "isRoot", void 0);
tslib_1.__decorate([
    ViewChild(RouterLinkActive, { static: false })
], NavigatorNodeComponent.prototype, "routerLinkActive", void 0);
tslib_1.__decorate([
    ViewChildren(NavigatorNodeComponent_1)
], NavigatorNodeComponent.prototype, "childrenNodes", void 0);
tslib_1.__decorate([
    Output()
], NavigatorNodeComponent.prototype, "nodeClick", void 0);
tslib_1.__decorate([
    ViewChild(PopoverConfirmComponent, { static: false })
], NavigatorNodeComponent.prototype, "confirm", void 0);
NavigatorNodeComponent = NavigatorNodeComponent_1 = tslib_1.__decorate([
    Component({
        selector: 'c8y-navigator-node-display',
        template: "<div\n  class=\"slot\"\n  [hidden]=\"node.hidden\"\n  (dragstart)=\"node.dragStart($event)\"\n  (dragend)=\"node.dragEnd($event)\"\n  (drop)=\"node.drop($event)\"\n  [draggable]=\"node.draggable\"\n  [ngClass]=\"{ dragged: node.dragged }\"\n>\n  <ng-container>\n    <a\n      class=\"link\"\n      draggable=\"false\"\n      (dragover)=\"node.canDrop && $event.preventDefault()\"\n      (dragenter)=\"node.canDrop && node.dragEnter($event)\"\n      (dragleave)=\"node.canDrop && node.dragLeave($event)\"\n      title=\"{{node.label | translate}}\"\n      [routerLink]=\"node.canNavigate ? node.path : undefined\"\n      [routerLinkActive]=\"node.canNavigate ? 'active' : ''\"\n      [routerLinkActiveOptions]=\"{exact:node.routerLinkExact}\"\n      (click)=\"click(node.canNavigate ? 'link' : 'expander', $event)\"\n      [ngClass]=\"{'root-link':isRoot, open: node.open, parent: node.hasChildren, 'dragged-hover': node.draggedHover && !node.dragged}\"\n    >\n      <ng-container *ngTemplateOutlet=\"inner\"></ng-container>\n    </a>\n  </ng-container>\n\n  <div\n    class=\"children panel-expand expand\"\n    *ngIf=\"node.children.length\"\n    [collapse]=\"!node.open\"\n    [isAnimated]=\"true\"\n  >\n    <c8y-navigator-node-display\n      *ngFor=\"let childNode of node.children\"\n      [node]=\"childNode\"\n      (nodeClick)=\"nodeClick.emit($event)\"\n    >\n    </c8y-navigator-node-display>\n  </div>\n</div>\n\n<ng-template #inner>\n  <!-- loader -->\n  <i\n    class=\"fa-spin loadingIndicator\"\n    [c8yIcon]=\"'circle-o-notch'\"\n    *ngIf=\"node.loading && !isRoot\"\n  >\n  </i>\n\n  <!-- icon -->\n  <div (click)=\"click('icon', $event)\">\n    <ng-container #icon></ng-container>\n  </div>\n\n  <!--title  -->\n  <span>{{node.label | translate}}</span>\n\n  <i\n    class=\"expander\"\n    [c8yIcon]=\"'chevron-down'\"\n    *ngIf=\"node.hasChildren\"\n    (click)=\"click('expander', $event)\"\n    title=\"{{expandTitle}}\"\n  >\n  </i>\n\n  <c8y-popover-confirm\n    outsideClick=\"true\"\n    containerClass=\"navigator-popover\"\n  ></c8y-popover-confirm>\n</ng-template>\n"
    })
], NavigatorNodeComponent);
export { NavigatorNodeComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF2aWdhdG9yLW5vZGUuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGM4eS9uZ3gtY29tcG9uZW50cy8iLCJzb3VyY2VzIjpbImNvcmUvbmF2aWdhdG9yL25hdmlnYXRvci1ub2RlLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDJDQUEyQztBQUMzQyxPQUFPLEVBQUUsU0FBUyxFQUFFLHdCQUF3QixFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDaEwsT0FBTyxFQUFFLGdCQUFnQixFQUFVLE1BQU0saUJBQWlCLENBQUM7QUFDM0QsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFFcEUsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDdkQsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sb0NBQW9DLENBQUM7QUFNN0UsSUFBYSxzQkFBc0IsOEJBQW5DLE1BQWEsc0JBQXNCO0lBYWpDLFlBQ1Usd0JBQWtELEVBQ2xELFNBQTJCO1FBRDNCLDZCQUF3QixHQUF4Qix3QkFBd0IsQ0FBMEI7UUFDbEQsY0FBUyxHQUFULFNBQVMsQ0FBa0I7UUFUM0IsY0FBUyxHQUF5QixJQUFJLFlBQVksRUFBRSxDQUFDO0lBVTVELENBQUM7SUFFSixlQUFlO1FBQ2IsSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLENBQUM7UUFDdkQsSUFBSSxDQUFDLGVBQWUsR0FBRyxVQUFVLENBQUMsR0FBRyxFQUFFO1lBQ3JDLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztZQUNsQixJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7WUFD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LENBQUM7UUFDVCxRQUFRLEVBQUUsNEJBQTRCO1FBQ3RDLGdrRUFBOEM7S0FDL0MsQ0FBQztHQUNXLHNCQUFzQixDQW1HbEM7U0FuR1ksc0JBQXNCIiwic291cmNlc0NvbnRlbnQiOlsiLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1saW5lLWxlbmd0aFxuaW1wb3J0IHsgQ29tcG9uZW50LCBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsIElucHV0LCBRdWVyeUxpc3QsIFZpZXdDaGlsZCwgVmlld0NoaWxkcmVuLCBWaWV3Q29udGFpbmVyUmVmLCBPdXRwdXQsIEV2ZW50RW1pdHRlciwgT25EZXN0cm95LCBIb3N0TGlzdGVuZXIgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFJvdXRlckxpbmtBY3RpdmUsIFJvdXRlciB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQgeyBOYXZpZ2F0b3JJY29uQ29tcG9uZW50IH0gZnJvbSAnLi9uYXZpZ2F0b3ItaWNvbi5jb21wb25lbnQnO1xuaW1wb3J0IHsgTmF2aWdhdG9yTm9kZSwgQ2xpY2tPcHRpb25zIH0gZnJvbSAnLi9uYXZpZ2F0b3Itbm9kZSc7XG5pbXBvcnQgeyBOYXZpZ2F0b3JTZXJ2aWNlIH0gZnJvbSAnLi9uYXZpZ2F0b3Iuc2VydmljZSc7XG5pbXBvcnQgeyBQb3BvdmVyQ29uZmlybUNvbXBvbmVudCB9IGZyb20gJy4uL21vZGFsL3BvcG92ZXItY29uZmlybS5jb21wb25lbnQnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdjOHktbmF2aWdhdG9yLW5vZGUtZGlzcGxheScsXG4gIHRlbXBsYXRlVXJsOiAnLi9uYXZpZ2F0b3Itbm9kZS5jb21wb25lbnQuaHRtbCdcbn0pXG5leHBvcnQgY2xhc3MgTmF2aWdhdG9yTm9kZUNvbXBvbmVudCBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XG4gIEBWaWV3Q2hpbGQoJ2ljb24nLCB7IHJlYWQ6IFZpZXdDb250YWluZXJSZWYsIHN0YXRpYzogZmFsc2UgfSkgaWNvblNsb3Q6IFZpZXdDb250YWluZXJSZWY7XG4gIEBJbnB1dCgpIG5vZGU6IE5hdmlnYXRvck5vZGU7XG4gIEBJbnB1dCgpIGlzUm9vdDogYm9vbGVhbjtcbiAgQFZpZXdDaGlsZChSb3V0ZXJMaW5rQWN0aXZlLCB7c3RhdGljOiBmYWxzZX0pIHJvdXRlckxpbmtBY3RpdmU6IFJvdXRlckxpbmtBY3RpdmU7XG4gIEBWaWV3Q2hpbGRyZW4oTmF2aWdhdG9yTm9kZUNvbXBvbmVudCkgY2hpbGRyZW5Ob2RlczogUXVlcnlMaXN0PE5hdmlnYXRvck5vZGVDb21wb25lbnQ+O1xuICBAT3V0cHV0KCkgbm9kZUNsaWNrOiBFdmVudEVtaXR0ZXI8c3RyaW5nPiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgQFZpZXdDaGlsZChQb3BvdmVyQ29uZmlybUNvbXBvbmVudCwge3N0YXRpYzogZmFsc2V9KSBjb25maXJtOiBQb3BvdmVyQ29uZmlybUNvbXBvbmVudDtcblxuICBwYXJlbnROb2RlOiBOYXZpZ2F0b3JOb2RlQ29tcG9uZW50O1xuXG4gIHByaXZhdGUgdmlld0luaXRUaW1lb3V0O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgY29tcG9uZW50RmFjdG9yeVJlc29sdmVyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXG4gICAgcHJpdmF0ZSBuYXZpZ2F0b3I6IE5hdmlnYXRvclNlcnZpY2VcbiAgKSB7fVxuXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpIHtcbiAgICB0aGlzLmNoaWxkcmVuTm9kZXMuZm9yRWFjaCgobikgPT4gbi5wYXJlbnROb2RlID0gdGhpcyk7XG4gICAgdGhpcy52aWV3SW5pdFRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIHRoaXMudXBkYXRlSWNvbigpO1xuICAgICAgdGhpcy5vcGVuT25GaXJzdFVybCgpO1xuICAgICAgdGhpcy5leHBhbmRQYXJlbnRJZkFjdGl2ZSgpO1xuICAgICAgdGhpcy5ub2RlLmNvbmZpcm0gPSB0aGlzLmNvbmZpcm07XG4gICAgfSk7XG4gIH1cblxuICBvcGVuT25GaXJzdFVybCgpIHtcbiAgICBpZiAodGhpcy5uYXZpZ2F0b3Iub3Blbk9uRmlyc3RVcmwodGhpcy5ub2RlKSAmJiAhdGhpcy5ub2RlLm9wZW4pIHtcbiAgICAgIHRoaXMuZXhwYW5kQ29sbGFwc2UodHJ1ZSk7XG4gICAgfVxuICB9XG5cbiAgZ2V0IGV4cGFuZFRpdGxlKCkge1xuICAgIHJldHVybiAhdGhpcy5ub2RlLm9wZW4gPyAnRXhwYW5kJyA6ICdDb2xsYXBzZSc7XG4gIH1cblxuICBjbGljayhmcm9tOiAnaWNvbicgfCAnZXhwYW5kZXInIHwgJ2xpbmsnID0gJ2xpbmsnLCAkZXZlbnQ/KSB7XG4gICAgbGV0IG9wZW47XG4gICAgaWYgKGZyb20gPT09ICdleHBhbmRlcicpIHtcbiAgICAgIGlmICgkZXZlbnQpIHtcbiAgICAgICAgJGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAkZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgIH1cbiAgICAgIG9wZW4gPSAhdGhpcy5ub2RlLm9wZW47XG4gICAgfSBlbHNlIHtcbiAgICAgIG9wZW4gPSB0aGlzLnJvdXRlckxpbmtBY3RpdmUgJiYgdGhpcy5yb3V0ZXJMaW5rQWN0aXZlLmlzQWN0aXZlID8gdHJ1ZSA6ICF0aGlzLm5vZGUub3BlbjtcbiAgICB9XG4gICAgaWYgKG9wZW4gIT09IHRoaXMubm9kZS5vcGVuKSB7XG4gICAgICB0aGlzLmV4cGFuZENvbGxhcHNlKG9wZW4sIGZhbHNlLCB7IFtmcm9tXTogdHJ1ZSwgJGV2ZW50IH0pO1xuICAgIH1cbiAgICB0aGlzLm5vZGVDbGljay5lbWl0KGZyb20pO1xuICB9XG5cbiAgZXhwYW5kQ29sbGFwc2Uob3BlbiwgcmVjdXJzaXZlPywgZm9yTm9kZTogQ2xpY2tPcHRpb25zID0ge30pIHtcbiAgICB0aGlzLm5vZGUub3BlbiA9IG9wZW47XG4gICAgLy8gQWxzbyBjbG9zZSBjaGlsZHJlblxuICAgIGlmIChyZWN1cnNpdmUpIHtcbiAgICAgIHRoaXMuY2hpbGRyZW5Ob2Rlcy5mb3JFYWNoKChuKSA9PiBuLmV4cGFuZENvbGxhcHNlKG9wZW4sIHJlY3Vyc2l2ZSkpO1xuICAgIH1cbiAgICBmb3JOb2RlLm9wZW4gPSBvcGVuO1xuICAgIHRoaXMubm9kZS5jbGljayhmb3JOb2RlKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIGNsZWFyVGltZW91dCh0aGlzLnZpZXdJbml0VGltZW91dCk7XG4gICAgdGhpcy5ub2RlLmRlc3Ryb3koKTtcbiAgfVxuXG4gIHByaXZhdGUgZXhwYW5kUGFyZW50SWZBY3RpdmUoKSB7XG4gICAgaWYgKHRoaXMucm91dGVyTGlua0FjdGl2ZSAmJiB0aGlzLnJvdXRlckxpbmtBY3RpdmUuaXNBY3RpdmUgJiYgdGhpcy5wYXJlbnROb2RlKSB7XG4gICAgICB0aGlzLnBhcmVudE5vZGUuZXhwYW5kQ29sbGFwc2UodHJ1ZSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVJY29uKCkge1xuICAgIGlmICh0aGlzLm5vZGUuaWNvblRlbXBsYXRlKSB7XG4gICAgICB0aGlzLnVwZGF0ZUljb25UZW1wbGF0ZSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnVwZGF0ZUljb25Db21wb25lbnQoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZUljb25Db21wb25lbnQoKSB7XG4gICAgbGV0IGNvbXBvbmVudFR5cGUgPSBOYXZpZ2F0b3JJY29uQ29tcG9uZW50O1xuICAgIGlmICh0aGlzLm5vZGUgJiYgdGhpcy5ub2RlLmljb25Db21wb25lbnQpIHtcbiAgICAgIGNvbXBvbmVudFR5cGUgPSB0aGlzLm5vZGUuaWNvbkNvbXBvbmVudDtcbiAgICB9XG4gICAgdGhpcy5pY29uU2xvdC5jbGVhcigpO1xuICAgIGNvbnN0IGljb25Db21wb25lbnRGYWN0b3J5ID0gdGhpcy5jb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoY29tcG9uZW50VHlwZSk7XG4gICAgY29uc3QgY29tcG9uZW50UmVmID0gdGhpcy5pY29uU2xvdC5jcmVhdGVDb21wb25lbnQoaWNvbkNvbXBvbmVudEZhY3RvcnkpO1xuICAgIGNvbXBvbmVudFJlZi5pbnN0YW5jZS5ub2RlID0gdGhpcy5ub2RlO1xuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVJY29uVGVtcGxhdGUoKSB7XG4gICAgdGhpcy5pY29uU2xvdC5jbGVhcigpO1xuICAgIHRoaXMuaWNvblNsb3QuY3JlYXRlRW1iZWRkZWRWaWV3KHRoaXMubm9kZS5pY29uVGVtcGxhdGUpO1xuICB9XG59XG4iXX0=