import * as tslib_1 from "tslib";
// tslint:disable-next-line:max-line-length
import { Component, ComponentFactoryResolver, Input, QueryList, ViewChild, ViewChildren, ViewContainerRef, Output, EventEmitter, OnDestroy, HostListener } from '@angular/core';
import { RouterLinkActive } from '@angular/router';
import { NavigatorIconComponent } from './navigator-icon.component';
import { NavigatorService } from './navigator.service';
import { PopoverConfirmComponent } from '../modal/popover-confirm.component';
var NavigatorNodeComponent = /** @class */ (function () {
    function NavigatorNodeComponent(componentFactoryResolver, navigator) {
        this.componentFactoryResolver = componentFactoryResolver;
        this.navigator = navigator;
        this.nodeClick = new EventEmitter();
    }
    NavigatorNodeComponent_1 = NavigatorNodeComponent;
    NavigatorNodeComponent.prototype.ngAfterViewInit = function () {
        var _this = this;
        this.childrenNodes.forEach(function (n) { return n.parentNode = _this; });
        this.viewInitTimeout = setTimeout(function () {
            _this.updateIcon();
            _this.openOnFirstUrl();
            _this.expandParentIfActive();
            _this.node.confirm = _this.confirm;
        });
    };
    NavigatorNodeComponent.prototype.openOnFirstUrl = function () {
        if (this.navigator.openOnFirstUrl(this.node) && !this.node.open) {
            this.expandCollapse(true);
        }
    };
    Object.defineProperty(NavigatorNodeComponent.prototype, "expandTitle", {
        get: function () {
            return !this.node.open ? 'Expand' : 'Collapse';
        },
        enumerable: true,
        configurable: true
    });
    NavigatorNodeComponent.prototype.click = function (from, $event) {
        var _a;
        if (from === void 0) { from = 'link'; }
        var open;
        if (from === 'expander') {
            if ($event) {
                $event.stopPropagation();
                $event.preventDefault();
            }
            open = !this.node.open;
        }
        else {
            open = this.routerLinkActive && this.routerLinkActive.isActive ? true : !this.node.open;
        }
        if (open !== this.node.open) {
            this.expandCollapse(open, false, (_a = {}, _a[from] = true, _a.$event = $event, _a));
        }
        this.nodeClick.emit(from);
    };
    NavigatorNodeComponent.prototype.expandCollapse = function (open, recursive, forNode) {
        if (forNode === void 0) { forNode = {}; }
        this.node.open = open;
        // Also close children
        if (recursive) {
            this.childrenNodes.forEach(function (n) { return n.expandCollapse(open, recursive); });
        }
        forNode.open = open;
        this.node.click(forNode);
    };
    NavigatorNodeComponent.prototype.ngOnDestroy = function () {
        clearTimeout(this.viewInitTimeout);
        this.node.destroy();
    };
    NavigatorNodeComponent.prototype.expandParentIfActive = function () {
        if (this.routerLinkActive && this.routerLinkActive.isActive && this.parentNode) {
            this.parentNode.expandCollapse(true);
        }
    };
    NavigatorNodeComponent.prototype.updateIcon = function () {
        if (this.node.iconTemplate) {
            this.updateIconTemplate();
        }
        else {
            this.updateIconComponent();
        }
    };
    NavigatorNodeComponent.prototype.updateIconComponent = function () {
        var componentType = NavigatorIconComponent;
        if (this.node && this.node.iconComponent) {
            componentType = this.node.iconComponent;
        }
        this.iconSlot.clear();
        var iconComponentFactory = this.componentFactoryResolver.resolveComponentFactory(componentType);
        var componentRef = this.iconSlot.createComponent(iconComponentFactory);
        componentRef.instance.node = this.node;
    };
    NavigatorNodeComponent.prototype.updateIconTemplate = function () {
        this.iconSlot.clear();
        this.iconSlot.createEmbeddedView(this.node.iconTemplate);
    };
    var NavigatorNodeComponent_1;
    NavigatorNodeComponent.ctorParameters = function () { return [
        { type: ComponentFactoryResolver },
        { type: NavigatorService }
    ]; };
    tslib_1.__decorate([
        ViewChild('icon', { read: ViewContainerRef, static: false })
    ], NavigatorNodeComponent.prototype, "iconSlot", void 0);
    tslib_1.__decorate([
        Input()
    ], NavigatorNodeComponent.prototype, "node", void 0);
    tslib_1.__decorate([
        Input()
    ], NavigatorNodeComponent.prototype, "isRoot", void 0);
    tslib_1.__decorate([
        ViewChild(RouterLinkActive, { static: false })
    ], NavigatorNodeComponent.prototype, "routerLinkActive", void 0);
    tslib_1.__decorate([
        ViewChildren(NavigatorNodeComponent_1)
    ], NavigatorNodeComponent.prototype, "childrenNodes", void 0);
    tslib_1.__decorate([
        Output()
    ], NavigatorNodeComponent.prototype, "nodeClick", void 0);
    tslib_1.__decorate([
        ViewChild(PopoverConfirmComponent, { static: false })
    ], NavigatorNodeComponent.prototype, "confirm", void 0);
    NavigatorNodeComponent = NavigatorNodeComponent_1 = tslib_1.__decorate([
        Component({
            selector: 'c8y-navigator-node-display',
            template: "<div\n  class=\"slot\"\n  [hidden]=\"node.hidden\"\n  (dragstart)=\"node.dragStart($event)\"\n  (dragend)=\"node.dragEnd($event)\"\n  (drop)=\"node.drop($event)\"\n  [draggable]=\"node.draggable\"\n  [ngClass]=\"{ dragged: node.dragged }\"\n>\n  <ng-container>\n    <a\n      class=\"link\"\n      draggable=\"false\"\n      (dragover)=\"node.canDrop && $event.preventDefault()\"\n      (dragenter)=\"node.canDrop && node.dragEnter($event)\"\n      (dragleave)=\"node.canDrop && node.dragLeave($event)\"\n      title=\"{{node.label | translate}}\"\n      [routerLink]=\"node.canNavigate ? node.path : undefined\"\n      [routerLinkActive]=\"node.canNavigate ? 'active' : ''\"\n      [routerLinkActiveOptions]=\"{exact:node.routerLinkExact}\"\n      (click)=\"click(node.canNavigate ? 'link' : 'expander', $event)\"\n      [ngClass]=\"{'root-link':isRoot, open: node.open, parent: node.hasChildren, 'dragged-hover': node.draggedHover && !node.dragged}\"\n    >\n      <ng-container *ngTemplateOutlet=\"inner\"></ng-container>\n    </a>\n  </ng-container>\n\n  <div\n    class=\"children panel-expand expand\"\n    *ngIf=\"node.children.length\"\n    [collapse]=\"!node.open\"\n    [isAnimated]=\"true\"\n  >\n    <c8y-navigator-node-display\n      *ngFor=\"let childNode of node.children\"\n      [node]=\"childNode\"\n      (nodeClick)=\"nodeClick.emit($event)\"\n    >\n    </c8y-navigator-node-display>\n  </div>\n</div>\n\n<ng-template #inner>\n  <!-- loader -->\n  <i\n    class=\"fa-spin loadingIndicator\"\n    [c8yIcon]=\"'circle-o-notch'\"\n    *ngIf=\"node.loading && !isRoot\"\n  >\n  </i>\n\n  <!-- icon -->\n  <div (click)=\"click('icon', $event)\">\n    <ng-container #icon></ng-container>\n  </div>\n\n  <!--title  -->\n  <span>{{node.label | translate}}</span>\n\n  <i\n    class=\"expander\"\n    [c8yIcon]=\"'chevron-down'\"\n    *ngIf=\"node.hasChildren\"\n    (click)=\"click('expander', $event)\"\n    title=\"{{expandTitle}}\"\n  >\n  </i>\n\n  <c8y-popover-confirm\n    outsideClick=\"true\"\n    containerClass=\"navigator-popover\"\n  ></c8y-popover-confirm>\n</ng-template>\n"
        })
    ], NavigatorNodeComponent);
    return NavigatorNodeComponent;
}());
export { NavigatorNodeComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF2aWdhdG9yLW5vZGUuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGM4eS9uZ3gtY29tcG9uZW50cy8iLCJzb3VyY2VzIjpbImNvcmUvbmF2aWdhdG9yL25hdmlnYXRvci1ub2RlLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsMkNBQTJDO0FBQzNDLE9BQU8sRUFBRSxTQUFTLEVBQUUsd0JBQXdCLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFLGdCQUFnQixFQUFFLE1BQU0sRUFBRSxZQUFZLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNoTCxPQUFPLEVBQUUsZ0JBQWdCLEVBQVUsTUFBTSxpQkFBaUIsQ0FBQztBQUMzRCxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUVwRSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN2RCxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSxvQ0FBb0MsQ0FBQztBQU03RTtJQWFFLGdDQUNVLHdCQUFrRCxFQUNsRCxTQUEyQjtRQUQzQiw2QkFBd0IsR0FBeEIsd0JBQXdCLENBQTBCO1FBQ2xELGNBQVMsR0FBVCxTQUFTLENBQWtCO1FBVDNCLGNBQVMsR0FBeUIsSUFBSSxZQUFZLEVBQUUsQ0FBQztJQVU1RCxDQUFDOytCQWhCTyxzQkFBc0I7SUFrQmpDLGdEQUFlLEdBQWY7UUFBQSxpQkFRQztRQVBDLElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLFVBQUMsQ0FBQyxJQUFLLE9BQUEsQ0FBQyxDQUFDLFVBQVUsR0FBRyxLQUFJLEVBQW5CLENBQW1CLENBQUMsQ0FBQztRQUN2RCxJQUFJLENBQUMsZUFBZSxHQUFHLFVBQVUsQ0FBQztZQUNoQyxLQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7WUFDbEIsS0FBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1lBQ3RC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RCxTQUFTLENBQUMsdUJBQXVCLEVBQUUsRUFBQyxNQUFNLEVBQUUsS0FBSyxFQUFDLENBQUM7MkRBQWtDO0lBUDNFLHNCQUFzQjtRQUpsQyxTQUFTLENBQUM7WUFDVCxRQUFRLEVBQUUsNEJBQTRCO1lBQ3RDLGdrRUFBOEM7U0FDL0MsQ0FBQztPQUNXLHNCQUFzQixDQW1HbEM7SUFBRCw2QkFBQztDQUFBLEFBbkdELElBbUdDO1NBbkdZLHNCQUFzQiIsInNvdXJjZXNDb250ZW50IjpbIi8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtbGluZS1sZW5ndGhcbmltcG9ydCB7IENvbXBvbmVudCwgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLCBJbnB1dCwgUXVlcnlMaXN0LCBWaWV3Q2hpbGQsIFZpZXdDaGlsZHJlbiwgVmlld0NvbnRhaW5lclJlZiwgT3V0cHV0LCBFdmVudEVtaXR0ZXIsIE9uRGVzdHJveSwgSG9zdExpc3RlbmVyIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBSb3V0ZXJMaW5rQWN0aXZlLCBSb3V0ZXIgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgTmF2aWdhdG9ySWNvbkNvbXBvbmVudCB9IGZyb20gJy4vbmF2aWdhdG9yLWljb24uY29tcG9uZW50JztcbmltcG9ydCB7IE5hdmlnYXRvck5vZGUsIENsaWNrT3B0aW9ucyB9IGZyb20gJy4vbmF2aWdhdG9yLW5vZGUnO1xuaW1wb3J0IHsgTmF2aWdhdG9yU2VydmljZSB9IGZyb20gJy4vbmF2aWdhdG9yLnNlcnZpY2UnO1xuaW1wb3J0IHsgUG9wb3ZlckNvbmZpcm1Db21wb25lbnQgfSBmcm9tICcuLi9tb2RhbC9wb3BvdmVyLWNvbmZpcm0uY29tcG9uZW50JztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LW5hdmlnYXRvci1ub2RlLWRpc3BsYXknLFxuICB0ZW1wbGF0ZVVybDogJy4vbmF2aWdhdG9yLW5vZGUuY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIE5hdmlnYXRvck5vZGVDb21wb25lbnQgaW1wbGVtZW50cyBPbkRlc3Ryb3kge1xuICBAVmlld0NoaWxkKCdpY29uJywgeyByZWFkOiBWaWV3Q29udGFpbmVyUmVmLCBzdGF0aWM6IGZhbHNlIH0pIGljb25TbG90OiBWaWV3Q29udGFpbmVyUmVmO1xuICBASW5wdXQoKSBub2RlOiBOYXZpZ2F0b3JOb2RlO1xuICBASW5wdXQoKSBpc1Jvb3Q6IGJvb2xlYW47XG4gIEBWaWV3Q2hpbGQoUm91dGVyTGlua0FjdGl2ZSwge3N0YXRpYzogZmFsc2V9KSByb3V0ZXJMaW5rQWN0aXZlOiBSb3V0ZXJMaW5rQWN0aXZlO1xuICBAVmlld0NoaWxkcmVuKE5hdmlnYXRvck5vZGVDb21wb25lbnQpIGNoaWxkcmVuTm9kZXM6IFF1ZXJ5TGlzdDxOYXZpZ2F0b3JOb2RlQ29tcG9uZW50PjtcbiAgQE91dHB1dCgpIG5vZGVDbGljazogRXZlbnRFbWl0dGVyPHN0cmluZz4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIEBWaWV3Q2hpbGQoUG9wb3ZlckNvbmZpcm1Db21wb25lbnQsIHtzdGF0aWM6IGZhbHNlfSkgY29uZmlybTogUG9wb3ZlckNvbmZpcm1Db21wb25lbnQ7XG5cbiAgcGFyZW50Tm9kZTogTmF2aWdhdG9yTm9kZUNvbXBvbmVudDtcblxuICBwcml2YXRlIHZpZXdJbml0VGltZW91dDtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGNvbXBvbmVudEZhY3RvcnlSZXNvbHZlcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxuICAgIHByaXZhdGUgbmF2aWdhdG9yOiBOYXZpZ2F0b3JTZXJ2aWNlXG4gICkge31cblxuICBuZ0FmdGVyVmlld0luaXQoKSB7XG4gICAgdGhpcy5jaGlsZHJlbk5vZGVzLmZvckVhY2goKG4pID0+IG4ucGFyZW50Tm9kZSA9IHRoaXMpO1xuICAgIHRoaXMudmlld0luaXRUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICB0aGlzLnVwZGF0ZUljb24oKTtcbiAgICAgIHRoaXMub3Blbk9uRmlyc3RVcmwoKTtcbiAgICAgIHRoaXMuZXhwYW5kUGFyZW50SWZBY3RpdmUoKTtcbiAgICAgIHRoaXMubm9kZS5jb25maXJtID0gdGhpcy5jb25maXJtO1xuICAgIH0pO1xuICB9XG5cbiAgb3Blbk9uRmlyc3RVcmwoKSB7XG4gICAgaWYgKHRoaXMubmF2aWdhdG9yLm9wZW5PbkZpcnN0VXJsKHRoaXMubm9kZSkgJiYgIXRoaXMubm9kZS5vcGVuKSB7XG4gICAgICB0aGlzLmV4cGFuZENvbGxhcHNlKHRydWUpO1xuICAgIH1cbiAgfVxuXG4gIGdldCBleHBhbmRUaXRsZSgpIHtcbiAgICByZXR1cm4gIXRoaXMubm9kZS5vcGVuID8gJ0V4cGFuZCcgOiAnQ29sbGFwc2UnO1xuICB9XG5cbiAgY2xpY2soZnJvbTogJ2ljb24nIHwgJ2V4cGFuZGVyJyB8ICdsaW5rJyA9ICdsaW5rJywgJGV2ZW50Pykge1xuICAgIGxldCBvcGVuO1xuICAgIGlmIChmcm9tID09PSAnZXhwYW5kZXInKSB7XG4gICAgICBpZiAoJGV2ZW50KSB7XG4gICAgICAgICRldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgJGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICB9XG4gICAgICBvcGVuID0gIXRoaXMubm9kZS5vcGVuO1xuICAgIH0gZWxzZSB7XG4gICAgICBvcGVuID0gdGhpcy5yb3V0ZXJMaW5rQWN0aXZlICYmIHRoaXMucm91dGVyTGlua0FjdGl2ZS5pc0FjdGl2ZSA/IHRydWUgOiAhdGhpcy5ub2RlLm9wZW47XG4gICAgfVxuICAgIGlmIChvcGVuICE9PSB0aGlzLm5vZGUub3Blbikge1xuICAgICAgdGhpcy5leHBhbmRDb2xsYXBzZShvcGVuLCBmYWxzZSwgeyBbZnJvbV06IHRydWUsICRldmVudCB9KTtcbiAgICB9XG4gICAgdGhpcy5ub2RlQ2xpY2suZW1pdChmcm9tKTtcbiAgfVxuXG4gIGV4cGFuZENvbGxhcHNlKG9wZW4sIHJlY3Vyc2l2ZT8sIGZvck5vZGU6IENsaWNrT3B0aW9ucyA9IHt9KSB7XG4gICAgdGhpcy5ub2RlLm9wZW4gPSBvcGVuO1xuICAgIC8vIEFsc28gY2xvc2UgY2hpbGRyZW5cbiAgICBpZiAocmVjdXJzaXZlKSB7XG4gICAgICB0aGlzLmNoaWxkcmVuTm9kZXMuZm9yRWFjaCgobikgPT4gbi5leHBhbmRDb2xsYXBzZShvcGVuLCByZWN1cnNpdmUpKTtcbiAgICB9XG4gICAgZm9yTm9kZS5vcGVuID0gb3BlbjtcbiAgICB0aGlzLm5vZGUuY2xpY2soZm9yTm9kZSk7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICBjbGVhclRpbWVvdXQodGhpcy52aWV3SW5pdFRpbWVvdXQpO1xuICAgIHRoaXMubm9kZS5kZXN0cm95KCk7XG4gIH1cblxuICBwcml2YXRlIGV4cGFuZFBhcmVudElmQWN0aXZlKCkge1xuICAgIGlmICh0aGlzLnJvdXRlckxpbmtBY3RpdmUgJiYgdGhpcy5yb3V0ZXJMaW5rQWN0aXZlLmlzQWN0aXZlICYmIHRoaXMucGFyZW50Tm9kZSkge1xuICAgICAgdGhpcy5wYXJlbnROb2RlLmV4cGFuZENvbGxhcHNlKHRydWUpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlSWNvbigpIHtcbiAgICBpZiAodGhpcy5ub2RlLmljb25UZW1wbGF0ZSkge1xuICAgICAgdGhpcy51cGRhdGVJY29uVGVtcGxhdGUoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy51cGRhdGVJY29uQ29tcG9uZW50KCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVJY29uQ29tcG9uZW50KCkge1xuICAgIGxldCBjb21wb25lbnRUeXBlID0gTmF2aWdhdG9ySWNvbkNvbXBvbmVudDtcbiAgICBpZiAodGhpcy5ub2RlICYmIHRoaXMubm9kZS5pY29uQ29tcG9uZW50KSB7XG4gICAgICBjb21wb25lbnRUeXBlID0gdGhpcy5ub2RlLmljb25Db21wb25lbnQ7XG4gICAgfVxuICAgIHRoaXMuaWNvblNsb3QuY2xlYXIoKTtcbiAgICBjb25zdCBpY29uQ29tcG9uZW50RmFjdG9yeSA9IHRoaXMuY29tcG9uZW50RmFjdG9yeVJlc29sdmVyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KGNvbXBvbmVudFR5cGUpO1xuICAgIGNvbnN0IGNvbXBvbmVudFJlZiA9IHRoaXMuaWNvblNsb3QuY3JlYXRlQ29tcG9uZW50KGljb25Db21wb25lbnRGYWN0b3J5KTtcbiAgICBjb21wb25lbnRSZWYuaW5zdGFuY2Uubm9kZSA9IHRoaXMubm9kZTtcbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlSWNvblRlbXBsYXRlKCkge1xuICAgIHRoaXMuaWNvblNsb3QuY2xlYXIoKTtcbiAgICB0aGlzLmljb25TbG90LmNyZWF0ZUVtYmVkZGVkVmlldyh0aGlzLm5vZGUuaWNvblRlbXBsYXRlKTtcbiAgfVxufVxuIl19