"use strict";!function(){function e(c,e,a,o,s,t,n){var r=o.cleanFields,u="devicecontrol/operations",i="\\/devicecontrol\\/operations\\/(\\d+)",l={headers:{"Content-Type":"application/json",Accept:"application/json"}},d={PENDING:n("PENDING"),SUCCESSFUL:n("SUCCESSFUL"),EXECUTING:n("EXECUTING"),FAILED:n("FAILED")},p=_.keys(d),f=["creationTime","deviceExternalIDs","id","self"],v=["deviceId","deviceName","bulkOperationId"],E={},I=f.concat(["deviceId","deviceName","bulkOperationId"]),g={failureReason:n("Failure reason"),description:n("Description"),status:n("Status")},y=e.$new(!0);function S(e){var t=o.url(u),n=o.pageSizeNoTotalFilter(e),i={params:n},r=o.cleanListCallback("operations",S,n);return c.get(t,i).then(r)}function h(e){var t=o.url(u),n=r(e,f),i=_.cloneDeep(l);if(!n.deviceId)throw new Error("c8yDeviceControl: data must have a deviceId property");return c.post(t,n,i).then(C).finally(function(e){return y.$emit("create"),e})}function C(e){var t=new RegExp(i),n=e.headers("Location").match(t);return parseInt(n[1],10)}function D(e){var t="".concat(o.url(u),"/").concat(e.id),n=r(e,f.concat(v)),i=_.cloneDeep(l);return c.put(t,n,i).finally(function(){y.$emit("update")})}E[d.PENDING]={icon:"clock-o",cls:""},E[d.EXECUTING]={icon:"refresh",cls:"text-info"},E[d.SUCCESSFUL]={icon:"check-circle",cls:"text-success"},E[d.FAILED]={icon:"exclamation-circle",cls:"text-danger"};var U={list:S,listPaged:function(e){var i=a.defer(),r=_.assign(e||{},{pageSize:1e3}),c=!1;return _.assign(i.promise,{cancel:function(){c=!0,i.reject("canceled")}}),S(r).then(function e(t){var n=!_.isUndefined(t.paging.next)&&t.length>=r.pageSize;return i.notify(t),n||i.resolve(!0),!!c||!n||t.paging.next().then(e)}),i.promise},detail:function(e){var t=function(e){var t=e.id||e;return o.url("".concat(u,"/").concat(t))}(e);return c.get(t)},create:h,createWithNotifications:function(c){var e=h(c),t=e.then(function(e){c.id=e;var n=a.defer(),i="operation".concat(c.id),r="/operations/".concat(c.deviceId);return s.addListener(i,r,"UPDATE",function(e,t){t.id==c.id&&(t.status===d.SUCCESSFUL||t.status===d.FAILED?(s.destroySubscription(i,r),n.resolve(t)):n.notify(t))}),s.start(i,r),n.promise});return a.when({created:e,completed:t})},update:D,cancel:function(e){var t=D({id:e.id,status:d.FAILED,failureReason:n("Operation cancelled by user.")});return t.then(function(){e.status=d.FAILED}),t},save:function(e){return e.id?D(e):h(e)},status:d,statusList:p,getStyle:function(e){var t=_.isString(e)?e:e.status;return E[t.toUpperCase()]},events:y};return t.enhanceWithKeysUtil({target:U,reservedKeys:I,standardKeys:g})}e.$inject=["$http","$rootScope","$q","c8yBase","c8yRealtime","c8yUtil","gettext"],angular.module("c8y.core").factory("c8yDeviceControl",e)}();