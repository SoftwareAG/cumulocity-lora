"use strict";!function(){function t(i,r,a,e,s){function t(t,e){var n=this;n.scope=t,n.filter=e||{dateFrom:moment().subtract(1,"days").startOf("day").format(r.dateFullFormat),dateTo:moment().format(r.dateFullFormat)},n.active={},n.events={},n.loadMore={},n._paths={},n.canceler=i.defer(),Object.defineProperty(n,"state",{get:function(){return this.realtimeStarted}})}function o(t){return/gsm/gi.test(_.get(t,"c8y_Position.fixType"))}return t.prototype.abortRequests=function(){this.canceler.resolve(),this.canceler=i.defer()},t.prototype.onPaths=function(t){this.callback=t},t.prototype._fetchAllEvents=function(){var t=this,e=_.keys(_.pickBy(t.active,_.identity)),n=_.map(e,_.bind(t._fetchEvents,t));return i.all(n).then(_.bind(t._notify,t,!0))},t.prototype._notify=function(t){var e=this;e.callback&&e.callback(L.multiPolyline(_.values(e._paths),{color:"darkblue"}),t)},t.prototype._fetchEvents=function(n){var i=this,t={source:n,type:"c8y_LocationUpdate",pageSize:1e3,withTotalPages:!0};return _.assign(t,i.filter),i._fetching=e.list(t,{timeout:i.canceler.promise}).then(function(t){var e=i._filterEvents(t);return i._buildEventListCallback(n,!0)(e)}),i._fetching},t.prototype._filterEvents=function(t){var e=this.trackingOptions||{},n=_.filter(t,function(t){return function(t){return"c8y_LocationUpdate"===t.type}(t)&&(_.isUndefined(e.gps)&&_.isUndefined(e.gsm)||e.gps&&function(t){return!o(t)}(t)||e.gsm&&o(t))}),i=_.filter(_.keys(t),function(t){return _.isNaN(_.toNumber(t))});return _.assign(n,_.pick(t,i)),n},t.prototype._buildLoadMore=function(t,e){var n=this;return function(){return n._fetching=e().then(n._filterEvents.bind(n)).then(n._buildEventListCallback(t,!1)).then(function(t){t.length&&n._notify(!0)}),n._fetching}},t.prototype._buildEventListCallback=function(n,i){var r=this;return function(t){var e=t.paging;return r.events[n]=i?t:(r.events[n]||[]).concat(t),r._paths[n]=_(r.events[n]).filter(s.getLocationFragment).map(function(t){var e=s.getLocationFragment(t),n=L.latLng(e.lat,e.lng);return n.time=t.time,n}).value(),r.loadMore[n]=e.next&&r._buildLoadMore(n,e.next),r._fetching=!1,r._paths[n]}},t.prototype.changeInterval=function(t){var e=this;return e.filter=t,e.abortRequests(),e._fetchAllEvents()},t.prototype.refresh=function(){return this.abortRequests(),this._fetchAllEvents()},t.prototype.activate=function(t,e){var n=this;return n.active[t]=!0,n.trackingOptions=e,n.setupRealtime(),n._fetchEvents(t).then(function(t){t.length&&n._notify(!0)})},t.prototype.getActiveDeviceIds=function(){return _.keys(this.active)},t.prototype.deactivate=function(t){var e=this;delete e.active[t],delete e._paths[t],delete e.events[t],e._notify(),e.setupRealtime()},t.prototype.deactivateAll=function(){var e=this;_.forEach(_.keys(e.active),function(t){delete e.active[t],delete e._paths[t],delete e.events[t]}),e._notify(),e.setupRealtime()},t.prototype._onNotification=function(t,e){var r=this;if(r.active[e.source.id]){var n=s.getLocationFragment(e);if(n&&r._filterEvents([e]).length&&moment(e.time).isAfter(r.filter.dateFrom)){r._paths[e.source.id]=r._paths[e.source.id]||[];var i=_.assign(L.latLng(n.lat,n.lng),{time:e.time});o(r._paths[e.source.id],i),r.events[e.source.id]=r.events[e.source.id]||[],o(r.events[e.source.id],e),r._notify(!0)}}function o(t,e){var n=r.filter.revert?1:-1,i=_.sortedIndexBy(t,e,function(t){return n*moment(t.time).valueOf()});t.splice(i,0,e)}},t.prototype.realtimeId=function(){return"c8yTracker-".concat(this.scope.$id)},t.prototype.setupRealtime=function(){if(this.realtimeStarted){var e=_.bind(this._onNotification,this),t=_.keys(this.active).map(function(t){return"/events/".concat(t)}),n=this.subscribedChannels,i=_.difference(t,n),r=_.difference(n,t),o=this.realtimeId();this.subscribedChannels=_.union(n,i),_.forEach(i,function(t){a.addListener(o,t,a.realtimeActions().CREATE,e),a.start(o,t)}),_.forEach(r,function(t){a.removeSubscriber(o,t)})}},t.prototype.cleanRealtime=function(){var t=this.subscribedChannels,e=this.realtimeId();_.forEach(t,function(t){a.removeSubscriber(e,t)}),this.subscribedChannels=[]},t.prototype.start=function(){var t=this;if(t.realtimeStarted)throw new Error("Tracker: Realtime is already started.");t.realtimeStarted=!0,t.scopeDestroyer&&t.scopeDestroyer(),t.scopeDestroyer=t.scope.$on("$destroy",function(){t.cleanRealtime()}),t.setupRealtime()},t.prototype.stop=function(){if(!this.realtimeStarted)throw new Error("Tracker: Cannot stop realtime, it has not been started.");this.realtimeStarted=!1,this.scopeDestroyer(),this.cleanRealtime()},{Tracker:t}}t.$inject=["$q","c8yBase","c8yRealtime","c8yEvents","c8yGeo"],angular.module("c8y.core").factory("c8yTracker",t)}();