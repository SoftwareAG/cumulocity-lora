"use strict";!function(){function t(t,e,n){var r,i,a,o,c,l,d,s,u,m,h,p=this,f={},g={top:20,right:0,bottom:10,left:0},v=30,y="10px",x=10,D=100,b=!1,A=!1,T=function(){h||(h=setTimeout(function(){h=null,function(){if(!b)return;c=c||e.find("svg")[0],l=l||d3.select("body").append("div").classed("c8y-timelines-chart-tooltip",!0).style("opacity",0),function(){var t=0<o.length?$(c).width()-g.left-g.right:0,e=0<o.length?o.length*v:0,n=0<o.length?t+g.left+g.right:0,a=0<o.length?e+g.top+g.bottom:0;n===f.totalWidth&&a===f.totalHeight||p.onSizeChanged({$size:{width:n,height:a}});f={chartWidth:0<t?t:0,chartHeight:0<e?e:0,totalWidth:0<n?n:0,totalHeight:0<a?a:0}}(),d3.select(c).attr({width:f.totalWidth,height:f.totalHeight}),function(){d||(d=d3.select(c).append("defs").append("svg:clipPath").attr("id","chart-clip-".concat(r)).append("svg:rect").attr("id","clip-rect".concat(r)).attr("x",0).attr("y",-15).attr("width",f.chartWidth).attr("height",f.chartHeight));d3.select("#clip-rect".concat(r)).attr("width",f.chartWidth).attr("height",f.chartHeight)}(),function(){s||(s=d3.select(c).append("g").classed("chart",!0));s.attr("transform",z(g.left,g.top))}(),u=d3.time.scale().domain([moment(i).toDate(),moment(a).toDate()]).range([0,f.chartWidth]),m=d3.svg.axis().scale(u).orient("bottom").ticks(0),function(){var t=s.selectAll("g.timeline").data(o),e=t.enter().append("g").classed("timeline",!0);e.append("g").classed("axis",!0),e.append("text").classed("axis-label",!0).attr("text-anchor","start").attr("x",0).attr("y",0).attr("transform",z(0,-10)).style("font-size",y),t.exit().remove(),s.selectAll("text.axis-label").data(o).text(function(t){return t.label}),s.selectAll("g.timeline").attr("transform",function(t,e){return z(0,e*v)}),s.selectAll("g.axis").call(m),s.selectAll("g.timeline").data(o).each(function(t){!function(t,e){A&&d3.select(t).selectAll("g.event").remove();var n=d3.select(t).selectAll("g.event").data(function(){return e.events}),a=d3.select(t).selectAll(".diamond").data(function(){return e.events});a.attr("d",d3.svg.symbol().type("diamond").size(function(){return D})).attr("transform",function(t){return z(u(moment(t.date).toDate()),0)}).attr("fill",function(){return e.color}),a.exit().remove();var o=d3.select(t).selectAll(".rect").data(function(){return e.events});o.attr("x",function(t){return u(moment(t.dateFrom).toDate())}).attr("width",function(t){return u(moment(i).add(moment(t.dateTo).diff(t.dateFrom)).toDate())}).style("fill",function(){return e.color}),o.exit().remove(),n.enter().append("g").classed("event",!0).attr("clip-path","url(#chart-clip-".concat(r,")")).each(function(t){t.date?d3.select(this).append("g").append("path").attr("class","diamond").attr("d",d3.svg.symbol().type("diamond").size(function(){return D})).attr("transform",z(u(moment(t.date).toDate()),0)).attr("fill",function(){return e.color}):d3.select(this).append("rect").attr("class","rect").attr("x",function(t){return u(moment(t.dateFrom).toDate())}).attr("y",0).attr("width",function(t){return u(moment(i).add(moment(t.dateTo).diff(t.dateFrom)).toDate())}).attr("height",x).attr("transform",z(0,-5)).style("fill",function(){return e.color})}).on("mouseover",function(t){l.transition().duration(200).style("opacity",.9),l.html(_.isFunction(t.tooltip)?t.tooltip():t.tooltip).style("left","".concat(d3.event.pageX,"px")).style("top","".concat(d3.event.pageY-28,"px"))}).on("mouseout",function(){l.transition().duration(500).style("opacity",0)})}(this,t)}),A=!1}()}()},300))};if(n.has("ngZone")){var F=n.get("ngZone"),w=T;T=function(){return F.runOutsideAngular(w)}}function z(t,e){return"translate(".concat(t,", ").concat(e,")")}_.assign(p,{$onInit:function(){r=String(Math.random()).substr(2),i=_.cloneDeep(p.dateFrom),a=_.cloneDeep(p.dateTo),o=_.cloneDeep(p.data),t.$on("c8yTimelinesChart::render",T),t.$on("dashboardResize",T),window.addEventListener("resize",T),b=!0,T()},$onChanges:function(t){t.dateFrom&&(i=_.cloneDeep(t.dateFrom.currentValue));t.dateTo&&(a=_.cloneDeep(t.dateTo.currentValue));t.data&&(o=_.cloneDeep(t.data.currentValue));if(t.chartBox){var e=t.chartBox.currentValue;_.assign(g,{left:e&&e.leftSpace||0,right:e&&e.rightSpace||0})}T()},$doCheck:function(){var t=!1;_.isEqual(o,p.data)||(o=_.cloneDeep(p.data),t=A=!0);moment(i).isSame(p.dateFrom)||(i=_.cloneDeep(p.dateFrom),t=!0);moment(a).isSame(p.dateTo)||(a=_.cloneDeep(p.dateTo),t=!0);t&&T()}})}t.$inject=["$scope","$element","$injector"],angular.module("c8y.ui").component("c8yTimelinesChart",{bindings:{dateFrom:"<",dateTo:"<",data:"<timelines",chartBox:"<",onSizeChanged:"&"},templateUrl:":::PLUGIN_PATH:::/ui/components/timelinesChart.html",controller:t,controllerAs:"vm"})}();