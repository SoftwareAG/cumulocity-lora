"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}!function(){function e(i,l,g,p,f,m,h,w,y,A,S,E,v,P){return e.$inject=["$scope","$q"],{restrict:"EA",scope:{user:"=",forms:"=",password:"=",hideUsername:"=?",hideActive:"=?",hideFirstName:"=?",hideLastName:"=?",hideEmail:"=?",hideTelephone:"=?",hideCustomProperties:"=?",hideTfaOption:"=?",hidePasswordReset:"=?",hideChangePassword:"=?",hideOwner:"=?",hideDelegate:"=?",disabledEdit:"=?",hideLanguage:"=?"},templateUrl:":::PLUGIN_PATH:::/ui/user/editUser.directive.html",controller:e,controllerAs:"vm",link:function(e,t){$(t).find("input[name=email]").bind("blur",function(){e.emailWarning=!(e.user&&e.user.email)})}};function e(d,r){var e="maxlength",a=v("Messaging application is not subscribed."),c={PATTERN:{type:"pattern",text:v("Invalid pattern.")},PATTERN_PASSWORD:{type:"pattern",text:P.getString(y.validation.password.message)},PATTERN_USERNAME:{type:"pattern",text:P.getString(y.validation.user.message)},PATTERN_DISPLAYNAME:{type:"pattern",text:P.getString(y.validation.loginAlias.message)},PATTERN_PHONE:{type:"pattern",text:P.getString(y.validation.phoneNumber.message)},SAME_AS_CURRENT_PASSWORD:{type:"same_as_current",text:v("New password can't be the same as current one.")},PASSWORD_MISSMATCH:{type:"password_missmatch",text:v("Password confirmation does not match.")},REQUIRED:{type:"required",text:v("This field is required.")},EMAIL:{type:"email",text:v("Invalid email address.")},PASSWORD_STRENGTH:{type:"password_strength",text:v("Password not good enough, password must be be stronger (green).")},INTERNATIONAL_NUMBER_REQUIRED_PHONE:{type:"international_number_required",text:P.getString(y.validation.internationalPhoneNumber.message)},MAXLENGTH_FIRSTNAME:{type:e,text:"".concat(P.getString("Max length:")," 50")},MAXLENGTH_LASTNAME:{type:e,text:"".concat(P.getString("Max length:")," 50")},MAXLENGTH_USERNAME:{type:e,text:"".concat(P.getString("Max length:")," 254")},MAXLENGTH_DISPLAYNAME:{type:e,text:"".concat(P.getString("Max length:")," 254")},MAXLENGTH_PHONE:{type:e,text:"".concat(P.getString("Max length:")," 254")},MAXLENGTH_EMAIL:{type:e,text:"".concat(P.getString("Max length:")," 254")}},u=this;_.assign(d,{confirmPassword:"",invalid:angular.bind(i,i.invalid,d.forms,"userForm"),isInvalidConfirmPassword:function(){var e=d.forms.userForm,t=e.password.$pristine,r=e.confirmPassword.$invalid;return!t&&r},changePasswordConfirm:function(){d.forms.userForm.confirmPassword.$setValidity(c.PASSWORD_MISSMATCH.type,d.forms.userForm.confirmPassword.$viewValue===d.user.password)},getPhoneTooltip:function(){return s("phone")||v("Enter a valid international phone number. The accepted format is +49 9 876 543 210.")},getErrorFeedback:s,getUserCustomProperties:function(e){var r={};e&&e.customProperties&&_.forEach(e.customProperties,function(e,t){"userOrigin"!==t&&(r[t]="object"===_typeof(e)?angular.toJson(e):e)});return r},humanize:i.humanizeFragment,passwordRegex:y.validation.password.pattern,resetPasswords:function(e){var r=P.getString("A user managed via your authorization server cannot change the password of the user.");l.current().then(function(e){var t=E.hasExternalOrigin(e);!d.password.showPassword&&t&&S.add({text:r,type:"warning"})}),d.password.showPassword=!d.password.showPassword,e.passwordStrength=d.password.strength,e.password=null,d.confirmPassword=""},tfaAvailable:!1,tfaReadonly:!0,delegateTo:function(){l.current().then(function(e){d.user.delegatedBy=e.id}),o()},undelegate:function(){d.user.delegatedBy=null,o()},setOwner:function(e){d.user.owner=e,u.isParentDropDownOpen=!1,u.ownerHiddenForm.$setDirty()}}),_.assign(u,{onToggleDropdown:function(e){e&&(u.ownerDropDownInitialized=!0)},twoFactorAuthenticationCheckboxDisabled:function(){return d.tfaReadonly||d.disabledEdit||"TOTP"===u.tfaStrategy||!d.smsMicroserviceAvailable||!d.notCurrentUser&&"SMS"===u.tfaStrategy},messagingWarningVisible:function(){return!d.smsMicroserviceAvailable&&"SMS"===u.tfaStrategy}}),f.checkIfStrongPasswordRequired().then(t);var n=d.$watch("user",function(e,t){e&&e!==t&&(function(n){var i=!n.id;d.password.strength=n.passwordStrength,d.changePasswordBtn=!d.password.showPassword,d.emailWarning=!n.email,d.smsWarningPopover=a,i&&(n.sendPasswordResetEmail=!0);delete d.confirmPassword,d.notCurrentUser=null,function(e){var t=/.*/;e&&!e.id&&(t=y.validation.user.pattern),d.userNamePattern=t,d.loginAliasPattern=y.validation.loginAlias.pattern}(n),d.hideLanguage||g.get("language").then(function(e){e&&(d.user.language={name:w.getLanguageNativeName(e),code:e}),d.languages=_.map(m.getSupportedLanguages(),function(e){return Object.assign({name:w.getLanguageNativeName(e),code:e},{})})}),A.isActivatedFor("units-conversion")&&(d.unitsConversionActive=!0);r.all({tfaAvailable:l.isTfaAvailable(),smsMicroserviceAvailable:h.isAvailable({contextPath:"messaging"}),twoFactorAuthenticationEnabled:l.isTfaActive(n),tfaReadonly:l.isTfaReadonly(n),tfaStrategy:l.getTfaStrategy(),isCurrentUser:l.checkIfCurrent(n)}).then(function(e){var t=e.tfaAvailable,r=e.smsMicroserviceAvailable,n=e.twoFactorAuthenticationEnabled,a=e.tfaReadonly,s=e.tfaStrategy,o=e.isCurrentUser;d.notCurrentUser=!o,d.tfaAvailable=t,d.smsMicroserviceAvailable=!!r,d.tfaReadonly=a,u.tfaStrategy=s,d.user.twoFactorAuthenticationEnabled=!i&&n}),d.hideOwner||(d.ownerEditDisabled=!1,l.current().then(function(e){var t=p.hasRole(e,"ROLE_USER_MANAGEMENT_ADMIN"),r=p.hasRole(e,"ROLE_USER_MANAGEMENT_CREATE");!t&&r&&(u.rootOwner=[e],u.currentOwner=e.id,u.defaultOwner=e,i&&(d.ownerEditDisabled=!0,n.owner=u.currentOwner))}))}(e),n())});function t(e){var t=!1;try{t=JSON.parse(e.value)}finally{(d.passwordStrengthEnforced=t)&&d.$watch("user.passwordStrength",function(e){e&&d.password.showPassword&&d.forms.userForm.password.$setValidity(c.PASSWORD_STRENGTH.type,function(e){return"GREEN"===e}(d.user.passwordStrength))})}}function s(s){var o=d.forms.userForm[s]||{},i=[];return _.forEach(o.$error||{},function(e,t){if("parse"!==t){var r=t.toUpperCase(),n="".concat(r,"_").concat(s.toUpperCase());if(e&&!o.$pristine){var a=c[n]||c[r];i.push(P.getString(a.text))}}else d.forms.userForm.phone.$setValidity(t,!0)}),i.join(" ")}function o(){d.delegationHiddenForm.$setDirty()}d.$watch("user.password",function(){d.forms.userForm&&d.forms.userForm.password&&d.forms.userForm.password.$setValidity(c.SAME_AS_CURRENT_PASSWORD.type,!d.notCurrentUser&&!l.isCurrentPassword(d.user.password)||d.notCurrentUser)})}}e.$inject=["c8yBase","c8yUser","c8yUserPreferences","c8yPermissions","c8yTenantOptions","c8yLocales","c8yApplication","LocalesUtil","c8yConfig","c8yBeta","c8yAlert","c8yUsersUi","gettext","gettextCatalog"],angular.module("c8y.ui").directive("c8yEditUser",e).directive("c8yUiEditUser",e)}();