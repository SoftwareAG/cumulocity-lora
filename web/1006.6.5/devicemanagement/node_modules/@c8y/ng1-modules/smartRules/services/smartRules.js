"use strict";!function(){function e(u,i,o,a,r,c,t,n,l,s){var d=o.url("service/smartrule"),f="".concat(d,"/smartrules"),h=["id","self","cepModuleId","lastUpdated","creationTime"],p=["type","cepModuleId","creationTime","lastUpdated"];return{eventProcessingEnabled:r.shouldShowEventProcessing,permissionsCfgs:{create:{anyRole:["ROLE_INVENTORY_ADMIN","ROLE_INVENTORY_CREATE"],allRoles:["ROLE_CEP_MANAGEMENT_ADMIN"]}},getEmpty:function(e){var t=e||r.getContext(),n={type:"c8y_SmartRule",name:"",enabled:!0,config:{}};t.context&&t.id&&(n.c8y_Context=t,n.type="c8y_PrivateSmartRule");return n},list:function(){return i.get(f).then(o.getResData).then(_.property("rules")).then(m)},listByContext:function(e){return i.get(g({moId:e})).then(o.getResData).then(_.property("rules")).then(m)},detail:function(e){var t=v({id:e});return i.get(t).then(o.getResData)},save:function(e,t,n){var r;r=e.id?S(e):function(e,t,n){var r=v(e,!0);return function(e,t,n){return e.ruleTemplateName=t.name,function(e,t){var n=u.when(e);return e.c8y_Context||t.mo?(e.enabledSources=[],e.disabledSources=void 0,n=y(e,t.mo,t.withChildren)):(e.enabledSources=void 0,e.disabledSources=[]),n}(e,n)}(e,t,n).then(_.partial(i.post,r)).then(o.getResData)}(e,t,n);return r},remove:function(e){var t=v(e,!0);return i.delete(t)},hasSource:function(e,t){var n=t&&t.id||t;if(!n)return!1;if(e.disabledSources)return!b(e.disabledSources,n);if(e.enabledSources)return b(e.enabledSources,n);return!0},activate:function(e,t,n){return y(e,t,n).then(S)},deactivate:function(e,t,n){return function(n,e,t){return I(e,t).then(function(e){return _.forEach(e,function(t){_.isArray(n.enabledSources)&&b(n.enabledSources,t)&&_.remove(n.enabledSources,function(e){return _.toString(e)===_.toString(t)}),_.isArray(n.disabledSources)&&!b(n.disabledSources,t)&&n.disabledSources.push(t)}),n})}(e,t,n).then(S)},addNewWithUI:R,addNewForInputAlarmAndOutputUserWithUI:function(e,t){return R({inputAlarm:e,outputUser:t})},addNewForInputDataPointWithUI:function(e){return R({inputDataPoint:e})},addNewForOutputOperationWithUI:function(e){return R({outputOperation:{template:function(e){return o.cleanFields(e,["id","self","status","deviceId","creationTime","failureReason"])}(e)}})},createInstanceWithUI:U,createInstanceWithUIByName:function(e,t){return n.getTemplateByName(e).then(function(e){return U(e,t)})},editWithUI:function(e){return D(e,void 0)},cloneWithUI:function(e){return t.current().then(_.partial(A,e)).then(D)}};function m(e){return u.all(_.map(e,function(t){return n.getTemplateForRule(t).then(function(e){return _.isUndefined(e)?null:t})})).then(_.flatten).then(_.filter)}function v(e,t){var n=_.get(e,"c8y_Context.id"),r=t&&n?g({moId:n}):f;return e.id&&(r+="/".concat(e.id)),r}function g(e){return"".concat(d,"/managedObjects/").concat(e.moId,"/smartrules")}function S(e){var t=v(e,!0),n=o.cleanFields(e,p);return i.put(t,n)}function y(n,e,t){return I(e,t).then(function(e){return _.forEach(e,function(t){_.isArray(n.enabledSources)&&!b(n.enabledSources,t)&&n.enabledSources.push(t),_.isArray(n.disabledSources)&&b(n.disabledSources,t)&&_.remove(n.disabledSources,function(e){return _.toString(e)===_.toString(t)})}),n})}function I(e,t){var n=e&&e.id||e,r=[];return n&&(r.push(u.when(n)),r.push(function(e,t){var n=[];!0!==t&&!0!==t.assets||n.push(a.childAssets(e));!0!==t&&!0!==t.devices||n.push(a.childDevices(e));return u.all(n).then(_.flattenDeep).then(_.partialRight(_.map,"id"))}(n,t))),u.all(r).then(_.flattenDeep)}function b(e,t){var n=t.id||t;return _.some(e,function(e){return _.toString(e)===_.toString(n)})}function R(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=1<arguments.length?arguments[1]:void 0,n=2<arguments.length?arguments[2]:void 0;return c({title:l("Add global smart rule"),templateUrl:":::PLUGIN_PATH:::/views/add.html",controller:"SmartRuleAddCtrl",size:"lg",resolve:{context:function(){return _.cloneDeep(e)},ruleInitialObj:function(){return _.cloneDeep(n)},ruleTemplatesFilterFn:function(){return t}}})}function U(e,t){return D(t,e)}function A(e,t){var n=_.cloneDeep(e);return(n=o.cleanFields(n,h)).name=s.getString("Duplicate of {{name}}",n),t&&(n.owner=t.id),n}function D(e,t){return c({templateUrl:":::PLUGIN_PATH:::/views/edit.html",controller:"SmartRuleEditCtrl",size:"sm",resolve:{ruleTemplate:function(){return _.cloneDeep(t)},rule:function(){return _.cloneDeep(e)}}})}}e.$inject=["$q","$http","c8yBase","c8yInventory","c8yUiUtil","c8yModal","c8yUser","smartRuleTemplatesSvc","gettext","gettextCatalog"],angular.module("c8y.smartRules").factory("smartRulesSvc",e)}();