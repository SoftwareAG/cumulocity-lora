"use strict";function _toConsumableArray(r){return _arrayWithoutHoles(r)||_iterableToArray(r)||_unsupportedIterableToArray(r)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(r,e){if(r){if("string"==typeof r)return _arrayLikeToArray(r,e);var n=Object.prototype.toString.call(r).slice(8,-1);return"Object"===n&&r.constructor&&(n=r.constructor.name),"Map"===n||"Set"===n?Array.from(r):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(r,e):void 0}}function _iterableToArray(r){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(r))return Array.from(r)}function _arrayWithoutHoles(r){if(Array.isArray(r))return _arrayLikeToArray(r)}function _arrayLikeToArray(r,e){(null==e||e>r.length)&&(e=r.length);for(var n=0,t=new Array(e);n<e;n++)t[n]=r[n];return t}!function(){function r(l,c,a){return{flatTree:function n(r,e,t){var o=e||0;var a=t||[];if(15<o)throw new Error("Exceeded maximum level of nesting");return _.reduce(r,function(r,e){return e._depth=o,r.push(e),n(e._subGroups,o+1,r)},a)},copyUserRoles:function(r,u,i,e){var n,t=l.when();n=e?(t=l.all(_.map(u,function(r){return c.removeInventoryRoles(i,r.id)})),function(){return l.all(_.map(r,function(r){var e=_.map(r.roles,function(r){return{id:r.id}});return c.assignInventoryRoles(i,r.managedObject,e)}))}):function(){return l.all(_.map(r,function(r){var e=r.managedObject,n=_.find(u,{managedObject:e}),t=_.get(n,"roles"),o=_.get(n,"id"),a=_(_.union(r.roles,t)).uniqBy("id").map(function(r){return{id:r.id}}).value();return o?c.updateInventoryRoles(i,o,a):c.assignInventoryRoles(i,e,a)}))};return t.then(n)},onSaveInventoryRoles:function(e,n){var r=_.filter(n,"isModified").map(function(r){return function(r,e,n){var t,o=(n[e.managedObject]||{}).id;o?t=e.roles.length?c.updateInventoryRoles(r,o,e.roles):c.removeInventoryRoles(r,o):e.roles.length&&(t=c.assignInventoryRoles(r,e.managedObject,e.roles));return t||l.when()}(e,r,n)});return l.all(r)},listRootGroups:function(){return c.current().then(function(r){var e=c.hasRole(r,"ROLE_INVENTORY_READ"),n="type eq 'c8y_DeviceGroup' ".concat(e?"":"or type eq 'c8y_DeviceSubgroup'"),t="$filter=(".concat(n,")$orderby=name"),o={query:t,onlyRoots:!0,withChildren:!1};return a.listAll(o)})},loadChildren:u,expandAll:function(r,n){var t=l.defer(),o=0,a=Array.from(r);return function e(){if(o<=5){var r=a.shift();r?(o++,u(r).then(function(r){n&&n(),a.push.apply(a,_toConsumableArray(r)),o--,e()},t.reject),e()):0===o&&t.resolve()}}(),t.promise}};function u(e){var r={query:"$filter=((type eq c8y_DeviceSubgroup) and bygroupid(".concat(e.id,"))"),pageSize:2e3,withChildren:!1,withTotalPages:!1},n=[].concat(_toConsumableArray(e._parentGroups||[]),[e]);return a.list(r).then(function(r){return r.forEach(function(r){r._parentGroups=Array.from(n)}),e._subGroups=_.sortBy(r,"name"),e._subGroups})}}r.$inject=["$q","c8yUser","c8yInventory"],angular.module("c8y.userRoles").factory("c8yUserInventoryRoles",r)}();