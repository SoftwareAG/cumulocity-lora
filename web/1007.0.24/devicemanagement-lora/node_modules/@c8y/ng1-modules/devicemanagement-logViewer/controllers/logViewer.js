"use strict";!function(){function e(i,n,o,e,a,t,s,l,r,c,u,f){var d=this,g="YYYY-MM-DDTHH:mm:ssZZ";function m(){i.filters={dateFrom:moment().subtract(1,"day"),dateTo:moment(),logFile:i.logTypes[0]&&i.logTypes[0].name||null,maximumLines:1e3},d.filters=i.filters}function p(e){var t=_.assign({deviceId:n.deviceId,fragmentType:"c8y_LogfileRequest",withTotalPages:!0},e);return s.list(t).then(y)}function y(e,t){i.operations&&!t||(i.operations=[]),e.forEach(function(e){i.operations.push(e)}),i.paging=e.paging}function h(){_.get(i.paging,"refresh")&&(i.realtimeAnimation=!1,i.refreshLoading=!0,i.paging.refresh().then(_.partialRight(y,!0)).finally(function(){i.refreshLoading=!1}),i.paging=null)}function L(e){if(e.c8y_LogfileRequest.file){var t=a.getIdFromUrl(e.c8y_LogfileRequest.file);if(t)return a.removeBinary(t)}return!1}function v(e){var t={id:e.id,status:e.status,c8y_LogfileRequest:null};return s.save(t)}function R(e){C(e)?i.selectedLog=e:i.selectedLog=void 0}function C(e){return e.c8y_LogfileRequest&&e.c8y_LogfileRequest.file}function q(e){return e&&"SUCCESSFUL"===e.status}function F(e){return e&&"FAILED"===e.status}function T(e,t){t&&!e?(d.shouldClose="disabled",o(function(){d.shouldClose="outsideClick"})):d.shouldClose="outsideClick"}i.requestLogfile=function(e){var t={deviceId:n.deviceId,description:u("Log file request"),c8y_LogfileRequest:{dateFrom:moment(e.dateFrom).format(g),dateTo:moment(e.dateTo).format(g),logFile:e.logFile,searchText:e.searchText||"",maximumLines:e.maximumLines}};s.createWithNotifications(t).then(function(e){e.created.then(h),e.completed.then(function(e){e.status===s.status.SUCCESSFUL?(_.assign(t,e),R(t)):e.status===s.status.FAILED&&"Operation cancelled by user."!==e.failureReason&&(e.failureReason?c.danger(f('Could not load file: "{{failureReason | translate}}".',e)):c.danger(u("Could not load file.")))},_.noop,function(e){_.assign(t,e),R(t)}).then(h)})},i.hasLogFile=C,i.selectLogfile=R,i.isBinary=function(e){return e&&e.c8y_LogfileRequest&&e.c8y_LogfileRequest.file&&!!a.getIdFromUrl(e.c8y_LogfileRequest.file)},i.download=function(e){if(e.c8y_LogfileRequest.file){var t=a.getIdFromUrl(e.c8y_LogfileRequest.file);if(t)return a.downloadAndSaveAs(t).catch(function(){c.danger(u("Could not download the log file."))})}return!1},i.cancel=function(e){return"PENDING"===e.status&&s.cancel(e).then(_.partial(c.success,u("Log file request cancelled."))).then(h)},i.remove=function(e){return r({title:u("Delete log file"),body:u("You are about to delete this log file. Do you want to proceed?"),status:"danger",labels:{ok:u("Delete")}}).then(_.partial(L,e)).finally(_.partial(v,e)).then(_.partial(c.success,u("Log file deleted."))).then(h)},i.statusIcon=function(e){return s.getStyle(e).icon},i.statusClass=function(e){return s.getStyle(e).cls},i.isSuccessful=q,i.isPending=function(e){return e&&"PENDING"===e.status},i.isFailed=F,i.isCompleted=function(e){return q(e)||F(e)},i.refresh=h,i.loadNext=function(e){i.paging.loading=!0,(e?p({pageSize:e}):i.paging.next().then(y)).finally(function(){i.paging.loading=!1})},i.getOperationDesc=function(e){return e.description||u("no description available")},i.$watch("vm.datePickerToOpen",T),i.$watch("vm.datePickerFromOpen",T),d.shouldClose="outsideClick",d.datePickerToOpen=!1,d.datePickerFromOpen=!1,t.detail(n.deviceId).then(e.getResData).then(function(e){i.logTypes=_.map(e.c8y_SupportedLogs,function(e){return{name:e}}),d.logTypes=i.logTypes}).then(m),p();var D=i.$id,I="/operations/".concat(n.deviceId),S=l.realtimeActions();_.forOwn(S,function(e){l.addListener(D,I,e,function(e,t){if(_.has(t,"c8y_LogfileRequest")){h();var n=i.selectedLog;n&&n.id===t.id&&e===S.UPDATE&&(n.c8y_LogfileRequest=t.c8y_LogfileRequest)}})}),l.start(D,I),i.$on("$destroy",function(){l.stop(D,I),l.destroySubscription(D,I)})}e.$inject=["$scope","$routeParams","$timeout","c8yBase","c8yBinary","c8yDevices","c8yDeviceControl","c8yRealtime","c8yModal","c8yAlert","gettext","gettextCatalog"],angular.module("c8y.logViewer").controller("logViewerCtrl",e)}();