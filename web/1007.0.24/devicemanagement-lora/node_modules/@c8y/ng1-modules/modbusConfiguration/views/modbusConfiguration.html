<div ng-controller="modbusConfigCtrl">
  <div class="panel panel-clean panel-border" ng-show="device.c8y_SerialConfiguration">
    <div class="panel-heading">
      <i c8y-icon="hdd-o"></i> <translate>Serial communication</translate>
    </div>
    <div class="panel-body">
      <form role="form" name="serialCommunicationForm">
        <div class="row">
          <div
            class="form-group col-lg-3"
            ng-class="{'has-error': invalid('serialCommunicationForm', 'baudRate')}"
          >
            <label for="baudRate" translate>Baud rate</label>
            <select
              class="form-control input-border"
              id="baudRate"
              name="baudRate"
              ng-model="device.c8y_SerialConfiguration.baudRate"
              ng-options="br for br in serialConfigurationOptions.baudRates"
              required
            ></select>
          </div>
          <div
            class="form-group col-lg-3"
            ng-class="{'has-error': invalid('serialCommunicationForm', 'dataBits')}"
          >
            <label for="dataBits" translate>Data bits</label>
            <select
              class="form-control input-border"
              id="dataBits"
              name="dataBits"
              ng-model="device.c8y_SerialConfiguration.dataBits"
              ng-options="db for db in serialConfigurationOptions.dataBits"
              required
            ></select>
          </div>
          <div
            class="form-group col-lg-3"
            ng-class="{'has-error': invalid('serialCommunicationForm', 'parity')}"
          >
            <label for="parity" translate>Parity</label>
            <select
              class="form-control input-border"
              id="parity"
              name="parity"
              ng-model="device.c8y_SerialConfiguration.parity"
              ng-options="p for p in serialConfigurationOptions.parities"
              required
            ></select>
          </div>
          <div
            class="form-group col-lg-3"
            ng-class="{'has-error': invalid('serialCommunicationForm', 'stopBits')}"
          >
            <label for="stopBits" translate>Stop bits</label>
            <select
              class="form-control input-border"
              id="stopBits"
              name="stopBits"
              ng-model="device.c8y_SerialConfiguration.stopBits"
              ng-options="sb for sb in serialConfigurationOptions.stopBits"
              required
            ></select>
          </div>
        </div>
      </form>
    </div>
  </div>
  <div class="panel panel-clean panel-border">
    <div class="panel-heading">
      <i c8y-icon="hdd-o"></i> <translate>Modbus communication</translate>
    </div>
    <div class="panel-body">
      <form role="form" name="modbusCommunicationForm">
        <div class="row">
          <div
            class="form-group col-lg-2"
            ng-class="{'has-error': invalid('modbusCommunicationForm', 'transmitRate')}"
          >
            <label for="transmitRate" translate>Transmit rate</label>
            <input
              type="number"
              class="form-control input-border"
              id="transmitRate"
              name="transmitRate"
              ng-model="device.c8y_ModbusConfiguration.transmitRate"
              min="0"
              required
              uib-tooltip="{{ getFieldValidationHints('modbusCommunicationForm', 'transmitRate') }}"
            />
            <span style="font-size:18px;" translate>seconds</span>
          </div>
          <div
            class="form-group col-lg-2"
            ng-class="{'has-error': invalid('modbusCommunicationForm', 'pollingRate')}"
          >
            <label for="pollingRate" translate>Polling rate</label>
            <input
              type="number"
              class="form-control input-border"
              id="pollingRate"
              name="pollingRate"
              ng-model="device.c8y_ModbusConfiguration.pollingRate"
              min="0"
              max="{{ device.c8y_ModbusConfiguration.transmitRate }}"
              placeholder="{{ 'e.g.' | translate }} 30"
              required
              uib-tooltip="{{ getFieldValidationHints('modbusCommunicationForm', 'pollingRate') }}"
            />
            <span style="font-size:18px;" translate>seconds</span>
          </div>
          <div
            class="form-group col-lg-3"
            ng-class="{'has-error': invalid('modbusCommunicationForm', 'protocol')}"
          >
            <label for="protocol" translate>Protocol</label>
            <select
              class="form-control input-border"
              id="protocol"
              name="protocol"
              ng-model="device.c8y_ModbusConfiguration.protocol"
              ng-options="p for p in modbusConfigurationOptions.protocols"
              required
              ng-disabled="usesModbusTCP(device)"
            ></select>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div style="margin-bottom: 30px;">
    <a
      title="{{ 'Save' | translate }}"
      href=""
      class="btn btn-primary"
      ng-click="save(device)"
      ng-disabled="(!usesModbusTCP(device) && serialCommunicationForm.$invalid) || modbusCommunicationForm.$invalid"
      translate
      >Save</a
    >
  </div>

  <div class="clearfix">
    <button
      title="{{ 'Add new device' | translate }}"
      class="btn btn-link pull-right"
      ng-click="startAddingNewDevice()"
    >
      <i c8y-icon="plus"></i> <translate>Add new device</translate>
    </button>
  </div>

  <form role="form" name="newDeviceForm" class="panel-body" novalidate ng-show="newDevice">
    <div class="row">
      <div
        class="form-group col-lg-3"
        ng-class="{'has-error': invalid('newDeviceForm', 'name')}"
        uib-tooltip="{{ getFieldValidationHints('newDeviceForm', 'name') }}"
      >
        <input
          type="text"
          class="form-control"
          placeholder="{{ 'Name' | translate }}"
          name="name"
          ng-model="newDevice.name"
          required
          ng-disabled="newDevice.adding"
        />
      </div>
      <div
        class="form-group col-lg-3"
        ng-class="{'has-error': invalid('newDeviceForm', 'deviceType')}"
        uib-tooltip="{{ getFieldValidationHints('newDeviceForm', 'deviceType') }}"
      >
        <ui-select
          name="deviceType"
          ng-model="newDevice.deviceType"
          class="form-control"
          required
          ng-disabled="newDevice.adding"
        >
          <ui-select-match
            title="{{ $select.selected.name }}"
            ng-bind="$select.selected.name"
          ></ui-select-match>
          <ui-select-choices
            repeat="t in deviceConfigurationOptions.types | orderBy:'name' | filter: $select.search"
          >
            <span title="{{ t.name }}" ng-bind="t.name"></span>
          </ui-select-choices>
        </ui-select>
      </div>
      <div
        class="form-group col-lg-2"
        ng-class="{'has-error': invalid('newDeviceForm', 'address')}"
        uib-tooltip="{{ getFieldValidationHints('newDeviceForm', 'address') }}"
      >
        <input
          type="number"
          class="form-control"
          placeholder="{{ 'Address' | translate }}"
          name="address"
          ng-model="newDevice.address"
          required
          min="1"
          max="247"
          step="1"
          ng-disabled="newDevice.adding"
        />
      </div>
      <div
        ng-show="usesModbusTCP(device)"
        class="form-group col-lg-2"
        ng-class="{'has-error': invalid('newDeviceForm', 'ipAddress')}"
        uib-tooltip="{{ getFieldValidationHints('newDeviceForm', 'ipAddress') }}"
      >
        <input
          id="ipAddress"
          name="ipAddress"
          type="text"
          validate-ip
          class="form-control"
          ng-model="newDevice.ipAddress"
          placeholder="{{ 'IP address' | translate }}"
          maxlength="15"
          ng-required="usesModbusTCP(device)"
          ng-disabled="newDevice.adding"
        />
      </div>
      <div class="form-group col-lg-2">
        <button
          title="{{ 'Add' | translate }}"
          class="btn btn-primary"
          ng-click="addNewDevice(newDevice)"
          ng-disabled="newDeviceForm.$invalid || newDevice.adding"
        >
          <span ng-hide="newDevice.adding" translate>Add</span>
          <span ng-show="newDevice.adding"
            ><i c8y-icon="spinner" class="fa-spin"></i> <translate>Adding</translate>&hellip;</span
          >
        </button>
        <button
          title="{{ 'Cancel' | translate }}"
          class="btn btn-default"
          ng-click="clearNewDevice(newDevice)"
          ng-disabled="newDevice.adding"
          translate
        >
          Cancel
        </button>
      </div>
    </div>
  </form>

  <table class="table table-hover">
    <tr>
      <th translate>Name</th>
      <th translate>Device type</th>
      <th translate>Address</th>
      <th ng-show="usesModbusTCP(device)" translate>IP address</th>
      <th>&nbsp;</th>
    </tr>
    <tr ng-repeat="dev in devices">
      <td class="interact" ng-click="navigateToDetail(dev)">{{ dev.name }}</td>
      <td>{{ dev.deviceType }}</td>
      <td>{{ dev.address }}</td>
      <td ng-show="usesModbusTCP(device)">{{ dev.ipAddress }}</td>
      <td class="text-right">
        <button
          class="btn btn-danger btn-xs showOnHover"
          title="{{ 'Remove' | translate }}"
          ng-click="onClickDelete(dev)"
        >
          <i c8y-icon="times"></i>
        </button>
      </td>
    </tr>
  </table>

  <c8y-load-more change-page-size></c8y-load-more>
</div>
