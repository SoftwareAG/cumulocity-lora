"use strict";!function(){function t(t,o,r,i,e,c,n){var a,l=[{val:"min",text:e("Minimum")},{val:"max",text:e("Maximum")},{val:"area",text:e("Area")}],d={BLOCK_DISPLAY:"block-display",DANGER_FIELD_CSS_CLASS:"danger",DANGER_TEXT_CSS_CLASS:"text-danger",DATE_LEGEND_CSS_CLASS_TEXT_LEFT:"text-left",DATE_LEGEND_CSS_CLASS_TEXT_NOWRAP:"text-nowrap",DATE_LEGEND_LAST_CSS_CLASS:"text-left",DATE_LEGEND_REST_CSS_CLASS:"text-muted text-left",SELECTED_CSS_CLASS:"active",TIME_LEGEND_FIRST_CSS_CLASS:"text-muted text-right",TIME_LEGEND_REST_CSS_CLASS_TEXT_RIGHT:"text-right",TIME_LEGEND_REST_CSS_CLASS_TEXT_NOWRAP:"text-nowrap",VALUE_CSS_CLASS:"text-right",VALUE_SEPARATOR_CSS_CLASS:"text-muted",WARNING_FIELD_CSS_CLASS:"warning",WARNING_TEXT_CSS_CLASS:"text-warning"},s=!1,u=[],S=500,g=_.throttle(function(){var i=o.activePoints;return D().then(function(t){_.forEach(t,function(t,e){var n=i[e];n.data=_.cloneDeep(t);var a=function(e){return _.findIndex(e.data.series,function(t){return t.type===e.fragment&&t.name===e.series})}(n),r=_.cloneDeep(n.data.series);delete n.data.series,-1<a?(n.data.series=r[a],_.forOwn(n.data.values,function(t,e){_.isObjectLike(n.data.values[e][a])&&(o.legend.push({date:e,momentDate:moment(e),targetId:n.__target.id,targetName:n.__target.name}),w(n,e,a))})):_.forOwn(n.data.values,function(t,e){w(n,e)})})}).then(v).then(I).then(T).then(function(){s=!(a=!0)}).then(h)},100,{leading:!1,trailing:!0}),m=function(){s=!(a=!1),g()},f=_.memoize(function(t){return moment(t).format("ll")},function(t){return"".concat(t,"_").concat(o.aggregation)}),E=_.memoize(function(t){var e=moment(t),n="";"HOURLY"===o.aggregation?n="".concat(e.format("HH[:00]"),"-").concat(e.add(1,"hour").format("HH[:00]")):"MINUTELY"===o.aggregation?n="".concat(e.format("HH:mm"),"-").concat(e.add(1,"minute").format("HH:mm")):o.aggregation||(n=e.format("HH:mm:ss"));return n},function(t){return"".concat(t,"_").concat(o.aggregation)});function T(){var t=o.tbody.selectAll("tr").data(o.legend,function(t){return[t.date,t.targetId].join(";")});return function(t){var e=t.enter().append("tr").on("click",function(t){!function(t,e,n){if(!o.rowsSelectable)return;o.selected&&o.selected.target===n&&moment(o.selected.date).isSame(e)?o.selected={}:(o.selected={date:e,target:n},o.skipScroll=!0)}(0,t.date,t.targetId)});e.append("td").classed("datetime",!0).call(function(t){t.append("strong").attr("class",[d.DATE_LEGEND_CSS_CLASS_TEXT_LEFT,d.DATE_LEGEND_CSS_CLASS_TEXT_NOWRAP].join(" ")).style("margin-right","2px"),t.append("span")}),e.append("td").classed("target",!0).style("display",o.displayTarget?"table-cell":"none").text(function(t){return t.targetName});var n=e.selectAll("td.datapoint").data(o.activePoints,function(t){return t._id||t._kpiId||t.$$hashKey});n.enter().append("td").call(function(n){var r=function(t){var e=n.data()||[];return(e=_.filter(e,_.identity))[t]};return function(t){t.attr("class",function(t,e,n){return _(L(r(n),t,"FIELD")).pickBy(_.identity).keys().value().join(" ")}).attr("stw-datatable-tooltip",function(t,e,n){return function(t,e){var n=p(t,e),a=null;C(n,e)?a=c.getString("Red range: {{min}} … {{max}}",{min:e.redRangeMin,max:e.redRangeMax}):x(n,e)&&(a=c.getString("Yellow range: {{min}} … {{max}}",{min:e.yellowRangeMin,max:e.yellowRangeMax}));return a}(r(n),t)}),t.append("strong").text(function(t,e,n){var a=r(n);return R(a,t,"min")?p(a,t).min:""}).attr("class",function(t,e,n){return _(L(r(n),t,"TEXT","min")).pickBy(_.identity).keys().value().join(" ")}),t.append("strong").text(function(t,e,n){var a=r(n);return R(a,t,"min")&&R(a,t,"max")?" ... ":""}).classed(d.VALUE_SEPARATOR_CSS_CLASS,!0),t.append("strong").text(function(t,e,n){var a=r(n);return R(a,t,"max")?p(a,t).max:""}).attr("class",function(t,e,n){return _(L(r(n),t,"TEXT","max")).pickBy(_.identity).keys().value().join(" ")})}}(e)).classed("datapoint",!0).classed(d.VALUE_CSS_CLASS,!0),n.exit().remove(),n.order(),t.sort(function(t,e){return moment(e.date).isAfter(moment(t.date))?1:-1})}(t),function(t){t.classed(d.SELECTED_CSS_CLASS,function(t){return!!o.selected&&(moment(o.selected.date).valueOf()===t.momentDate.valueOf()&&o.selected.target===t.targetId)});var e=t.select("td.datetime");e.attr("stw-datatable-tooltip",function(t){var e=t.isFirstNewDate?void 0:f(t.date);return e}),e.select("strong").attr("class",function(t){var e=t.isLastForDate;return e?d.DATE_LEGEND_LAST_CSS_CLASS:d.DATE_LEGEND_REST_CSS_CLASS}).text(function(t){var e=t.date;return f(e)}),e.select("span").attr("class",[d.TIME_LEGEND_REST_CSS_CLASS_TEXT_RIGHT,d.TIME_LEGEND_REST_CSS_CLASS_TEXT_NOWRAP].join(" ")).text(function(t){return E(t.date)})}(t),function(t){t.exit().remove()}(t),t}function v(){o.legend=_.sortBy(_.uniqBy(o.legend,function(t){return"".concat(t.date).concat(t.targetId)}),["momentDate","targetName"])}function L(t,e,n,a){var r=a?p(t,e)[a]:p(t,e),i={},o=d["DANGER_".concat(n,"_CSS_CLASS")],c=d["WARNING_".concat(n,"_CSS_CLASS")];return i[o]=!1,i[c]=!1,C(r,e)?i[o]=!0:x(r,e)&&(i[c]=!0),i}function p(t,e){if(!function(t,e){var n=t.date;return e.data&&e.data.values&&e.__target.id===t.targetId&&_.isObjectLike(e.data.values[n])&&_.isNumber(e.data.values[n].min)&&_.isNumber(e.data.values[n].max)}(t,e))return{};var n={},a=e.data.values,r=t.date;switch(e.renderType){case"area":n.min=a[r].min,n.max=a[r].max;break;case"min":n.min=a[r].min;break;case"max":n.max=a[r].max;break;default:n.min=a[r].min}return n}function A(t,e,n){return _.isObjectLike(t)?t.min>=e&&t.min<=n||t.max>=e&&t.max<=n:e<=t&&t<=n}function C(t,e){return A(t,e.redRangeMin,e.redRangeMax)}function x(t,e){return A(t,e.yellowRangeMin,e.yellowRangeMax)}o.legend=[],o.firstNewDates=[],o.$watch("datapoints",function(t){o.legend=[],o.firstNewDates=[],o.activePoints=[],T();var e=_.cloneDeep(t);o.activePoints=_.filter(e,function(t){return t.__active}),o.displayTarget=1<_.uniqBy(o.activePoints,function(t){return t.__target.id}).length,m()}),o.$watch("dateFrom",b),o.$watch("dateTo",b),o.$watch("aggregation",m),o.$watch("selected",function(){if(a)if(T(),o.skipScroll)o.skipScroll=!1;else{var t=o.table.find(".".concat(d.SELECTED_CSS_CLASS)).get(0);t&&o.panel.animate({scrollTop:(t.offsetTop-o.panel.height())/2},500)}}),_.assign(o,{getChartTypeTooltip:function(e){var t=e.label,n=e.unit||e.data&&e.data.series&&e.data.series.unit,a=e.renderType&&l[_.findIndex(l,function(t){return t.val===e.renderType})].text;return[t,n?[" [",n,"]"].join(""):"",a?[" (",c.getString(a),")"].join(""):""].join("")},getFieldStyling:L,getFieldValue:p,onData:function(t){u.push(t),h()},data:{},selected:o.selected||{},isDataLoading:function(){return s}});var D=n.latest(function(){var t=o.activePoints,e=o.dateFrom,n=o.dateTo,a=o.aggregation;return o.legend=[],o.firstNewDates=[],r.all(_.map(t,function(t){return i.loadSeriesData(t,e,n,a)}))});var N=_.throttle(function(){o.panel.scrollTop(0)},500);function h(){if(!s){for(var t=u.shift();t;)y(t),t=u.shift();I(),T(),k()}}function y(e){_.forEach(o.activePoints,function(t){(function(t,e){var n=e[t.fragment];return t.__target.id===e.source.id&&n&&n[t.series]})(t,e)&&(t.data=t.data||{values:{}},t.data.values[e.time]={min:e[t.fragment][t.series].value,max:e[t.fragment][t.series].value},_.last(o.legend)&&e.time===_.last(o.legend).date&&t.__target.id===_.last(o.legend).targetId||(o.legend.push({date:e.time,momentDate:moment(e.time),targetId:t.__target.id,targetName:t.__target.name}),o.legend.length>S&&o.legend.shift()))})}function R(t,e,n){return _.isNumber(p(t,e)[n])}function I(){for(var t=o.legend.length,e=0;e<t;e++){var n=0===e,a=e===t-1,r=(o.legend[e-1]?o.legend[e-1].date.substr(0,10):"")!==o.legend[e].date.substr(0,10);o.legend[e].isFirstNewDate=n||r,o.legend[e].isLastForDate=a||r}}function w(t,e,n){t.data.values[e]=_.isUndefined(n)?{}:t.data.values[e][n]}function b(){o.tbody.selectAll("tr").remove(),m()}function k(){o.scrollLocked&&N()}o.$watch("scrollLocked",k)}t.$inject=["$filter","$scope","$q","c8yDataPoint","gettext","gettextCatalog","c8yBase"],angular.module("c8y.cockpit.dataPointTable").controller("c8yDataPointTableController",t)}();