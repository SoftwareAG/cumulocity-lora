"use strict";function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}function _iterableToArrayLimit(e,t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e)){var i=[],n=!0,r=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(n=(o=s.next()).done)&&(i.push(o.value),!t||i.length!==t);n=!0);}catch(e){r=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(r)throw a}}return i}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _defineProperty(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}!function(){function e(e,a,i,t,d,o,n,r,s,u,c,l,f,y,v,p){var g,m=this,A=i.deviceId,b={types:[]},I={IS_REQUIRED:"required",ADDRESS_IN_USE:"address-in-use",ADDRESSES_IN_USE:"addresses-in-use",ADDRESS_INVALID:"address-invalid",POLLING_RATE_LARGER_THAN_TRANSMIT_RATE:"polling-rate-larger-than-transmit-rate",ONLY_NATURAL_NUMBERS_ALLOWED:"only-natural-numbers-allowed",IPADDRESS_INVALID_FORMAT:"ip",INVALID_URL:"invalid-url",NODE_IN_USE:"node-in-use",NODE_OUT_OF_RANGE:"node-out-of-range",IP_RANGE:"ip-range",PORT_INVALID:"port-invalid",IP_RANGE_MAXLIMIT:"ip-range-maxlimit",ENGINEID_IN_USE:"engineid-in-use",IS_MIN:"min"},D=(_defineProperty(g={},I.IS_REQUIRED,v("This field is required.")),_defineProperty(g,I.ADDRESS_IN_USE,v("This address is already in use.")),_defineProperty(g,I.ADDRESSES_IN_USE,v("These addresses are already in use.")),_defineProperty(g,I.ADDRESS_INVALID,v("Addresses from 248 up to 254 are not allowed.")),_defineProperty(g,I.POLLING_RATE_LARGER_THAN_TRANSMIT_RATE,v("Polling rate must be equal to or smaller than transmit rate.")),_defineProperty(g,I.ONLY_NATURAL_NUMBERS_ALLOWED,v("Only natural numbers allowed.")),_defineProperty(g,I.IPADDRESS_INVALID_FORMAT,v("The IP address format is invalid.")),_defineProperty(g,I.INVALID_URL,v("The URL format is invalid. The only supported protocols are http, https and opc.tcp.")),_defineProperty(g,I.NODE_IN_USE,v("This node id is already in use.")),_defineProperty(g,I.IP_RANGE,v("Invalid IP address range.")),_defineProperty(g,I.PORT_INVALID,v("Invalid port number.")),_defineProperty(g,I.IP_RANGE_MAXLIMIT,v("Max. 30 IP addresses in total allowed.")),_defineProperty(g,I.NODE_OUT_OF_RANGE,v("Only node ID(s) between 1 and 127 are allowed.")),_defineProperty(g,I.ENGINEID_IN_USE,v("This engine ID is already in use.")),_defineProperty(g,I.IS_MIN,v("Value cannot be lower than minimum.")),g);function P(){var i=m.device;return _.assign(m,{hasSerialConfigOperation:r.supportsOperation(i,"c8y_SerialConfiguration"),hasFieldBusConfigOperation:function(e){return L()&&r.supportsOperation(e,"c8y_CanConfiguration")||O()&&r.supportsOperation(e,"c8y_ModbusConfiguration")||M()&&r.supportsOperation(e,"c8y_OPCUAConfiguration")||U()&&r.supportsOperation(e,"c8y_ProfibusConfiguration")||w()&&r.supportsOperation(e,"c8y_CANopenConfiguration")||V()&&r.supportsOperation(e,"c8y_SNMPConfiguration")}(i),serialConfiguration:function(e){return _.get(e,"c8y_SerialConfiguration",{})}(i),fieldbusConfiguration:function(e){var t={};e&&(O()?t=e.c8y_ModbusConfiguration:L()?t=e.c8y_CanConfiguration:M()?(e.c8y_OPCUAGateway&&(e.c8y_OPCUAGateway.transmitRate=e.c8y_OPCUAGateway.transmitRate||0,_.unset(e,"c8y_OPCUAGateway.userIdentityPassword")),t=e.c8y_OPCUAGateway):U()?(_.defaultsDeep(e,{c8y_ProfibusConfiguration:{baudRate:v("automatic")}}),t=e.c8y_ProfibusConfiguration):w()?t=e.c8y_CANopenConfiguration:V()&&(e.c8y_SNMPGateway&&(e.c8y_SNMPGateway.transmitRate=e.c8y_SNMPGateway.transmitRate||0,_.unset(e,"c8y_SNMPGateway.userIdentityPassword")),t=e.c8y_SNMPGateway));return t}(i)}),c.getAvailableDeviceTypes().then(function(e){var t=c.getFieldbusVersionFromDevice(i);_.set(m.fieldbusConfiguration,"maxFieldbusVersion",t),b.types=_(e).filter(function(e){return e.fieldbusVersion<=t}).filter(function(e){var t=e.fieldbusType;return O()&&"modbus"===t||L()&&"canbus"===t||M()&&"opcua"===t||U()&&"profibus"===t||w()&&"canopen"===t||V()&&"snmp"===t}).value()})}function S(){var e=function(e){var t=n.timeOrderFilter(e||{});return _.assign(t,_.pick(i,"deviceId")),t.revert=!0,t}({pageSize:1,fragmentType:"c8y_SnmpAutoDiscovery",status:"EXECUTING"});return o.list(e).then(N).then(h)}function N(e){var i=_slicedToArray(e,1)[0];if(i){m.autoDiscoveryInProgress=!0;var n=a.defer(),t="operation".concat(i.id),r="/operations/".concat(i.deviceId);return l.getStatus(t,r)&&l.destroySubscription(t,r),l.addListener(t,r,"UPDATE",function(e,t){t.id===i.id&&(t.status===o.status.SUCCESSFUL||t.status===o.status.FAILED?n.resolve(t):n.notify(t))}),l.start(t,r),a.when({completed:n.promise})}return!1}function R(){return r.childDevices(A).then(function(e){var t=V()?_.orderBy(e,["name"],["asc"]):e;m.devices=_.map(t,function(e){var t;return O()&&e.c8y_ModbusDevice?t=function(e){var t=C({device:e,fieldbusDeviceFragment:"c8y_ModbusDevice"});return{id:e.id,name:e.name,deviceType:_.get(t,"name"),address:e.c8y_ModbusDevice.address,ipAddress:e.c8y_ModbusDevice.ipAddress,protocol:e.c8y_ModbusDevice.protocol}}(e):L()&&e.c8y_CanDevice?t=function(e){var t=C({device:e,fieldbusDeviceFragment:"c8y_CanDevice"});return{id:e.id,name:e.name,deviceType:_.get(t,"name")}}(e):M()&&e.c8y_OPCUADevice?t=function(e){var t=C({device:e,fieldbusDeviceFragment:"c8y_OPCUADevice"});return{id:e.id,name:e.name,deviceType:_.get(t,"name"),directoryPath:e.c8y_OPCUADevice.browsePath}}(e):U()&&e.c8y_ProfibusDevice?t=function(e){var t=C({device:e,fieldbusDeviceFragment:"c8y_ProfibusDevice"});return{id:e.id,name:e.name,deviceType:_.get(t,"name")}}(e):w()&&e.c8y_CANopenDevice?t=function(e){var t=C({device:e,fieldbusDeviceFragment:"c8y_CANopenDevice"});return{id:e.id,name:e.name,deviceType:_.get(t,"name"),nodeId:e.c8y_CANopenDevice.nodeId}}(e):V()&&e.c8y_SNMPDevice&&(t=function(e){var t=C({device:e,fieldbusDeviceFragment:"c8y_SNMPDevice"});return{id:e.id,name:e.name,deviceType:_.get(t,"name"),ipAddress:e.c8y_SNMPDevice.ipAddress,port:e.c8y_SNMPDevice.port,version:e.c8y_SNMPDevice.version,auth:_.get(e.c8y_SNMPDevice,"auth",{})}}(e)),t})})}function C(e){var i=e.device,n=e.fieldbusDeviceFragment;return _(b.types).find(function(e){var t=e.id;return _.get(i,"".concat(n,".type"))==="/inventory/managedObjects/".concat(t)})}function E(){var e=m.fieldbusCommunicationForm;e.$setPristine(),e.$setUntouched()}function T(e){var t,i=e.split("-").map(function(e){return e.trim()}),n=y.validation.ip.pattern,r=y.validation.ipV6.pattern;if(2===i.length){var a=_slicedToArray(i,2),o=a[0],s=a[1],u=n.test(o)&&n.test(s),c=r.test(o)&&r.test(s);if(u||c)try{t=new d.Ip.Range(o,s)}catch(e){}}return t}function h(e){e.completed.then(function(e){e.status===o.status.SUCCESSFUL?(u.success(v("Autodiscovery completed.")),m.autoDiscoveryInProgress=!1):e.status===o.status.FAILED&&(e.failureReason?u.danger(p.getString('Autodiscovery failed due to: "{{ failureReason | translate }}".',e)):u.danger(v("Autodiscovery failed.")),m.autoDiscoveryInProgress=!1)},_.noop,function(){u.success(v("Autodiscovery in progress."))}).then(R)}function O(){return"modbus"===m.tab}function L(){return"canbus"===m.tab}function M(){return"opcua"===m.tab}function U(){return"profibus"===m.tab}function w(){return"canopen"===m.tab}function V(){return"snmp"===m.tab}_.assign(m,{$onInit:function(){r.detail(A).then(n.getResData).then(function(e){O()?_.defaults(e.c8y_SerialConfiguration,{baudRate:19200,dataBits:8,parity:"E",stopBits:1}):L()&&(m.serialConfigurationOptions.baudRates=[1e5,125e3,25e4,5e5,1e6]),m.device=e}).then(P).then(R).then(S)},shouldShowSerialPanel:function(){return O()&&_.get(m,"device.c8y_SerialConfiguration")},isModbusTab:O,isCanBusTab:L,isOPCUATab:M,isProfibusTab:U,isCanOpenTab:w,isSNMPTab:V,getFieldValidationHints:_.curryRight(n.validationHints)(D),serialConfigurationOptions:{baudRates:[110,300,600,1200,2400,4800,9600,14400,19200,38400,57600,115200,25e4,460800,5e5,921600,1e6],dataBits:[8],parities:["N","E","O"],stopBits:[1,2]},fieldbusConfigurationOptions:{baudRates:[{value:1e3,label:"1 Mbit/s"},{value:800,label:"800 kbit/s"},{value:500,label:"500 kbit/s"},{value:250,label:"250 kbit/s"},{value:125,label:"125 kbit/s"},{value:50,label:"50 kbit/s"},{value:20,label:"20 kbit/s"},{value:10,label:"10 kbit/s"}]},deviceConfigurationOptions:b,fieldErrors:I,fieldErrorsToMessages:D,saveSerialConfig:function(){(function(e){return o.create({deviceId:e.id,description:v("Set serial configuration"),c8y_SerialConfiguration:e.c8y_SerialConfiguration})})(m.device).then(function(){return u.success(v("Settings will be applied."))})},saveFieldbusConfig:function(){(function(e){var t=a.resolve();O()&&e.c8y_ModbusConfiguration?t=function(e){return o.create({deviceId:e.id,description:v("Set modbus configuration"),c8y_ModbusConfiguration:_.omit(e.c8y_ModbusConfiguration,["maxFieldbusVersion"])})}(e):L()?t=function(e){return o.create({deviceId:e.id,description:v("Set CAN Bus configuration"),c8y_CanConfiguration:_.omit(e.c8y_CanConfiguration,["maxFieldbusVersion"])})}(e):M()?t=function(e){var t=e.c8y_OPCUAGateway.transmitRate,i=_.merge(_.cloneDeep(e),{c8y_OPCUAGateway:{transmitRate:0===t?void 0:t}});return r.update(_.pick(i,["id","c8y_OPCUAGateway"]))}(e):U()?t=function(e){return o.create({deviceId:e.id,description:v("Set Profibus configuration"),c8y_ProfibusConfiguration:_.pick(e.c8y_ProfibusConfiguration,["transmitRate","slaveAddress"])})}(e):w()?t=function(e){return o.create({deviceId:e.id,description:v("Set CAN Open configuration"),c8y_CANopenConfiguration:_.omit(e.c8y_CANopenConfiguration,["maxFieldbusVersion"])})}(e):V()&&(t=function(e){var t=e.c8y_SNMPGateway.transmitRate,i=_.merge(_.cloneDeep(e),{c8y_SNMPGateway:{transmitRate:0===t?void 0:t}});return r.update(_.pick(i,["id","c8y_SNMPGateway"])).then(E)}(e));return t})(m.device).then(function(){return u.success(v("Settings will be applied."))})},invalid:function(e,t){(O()||M())&&function(e){var t=m[e],i=t.pollingRate;if(i){var n=t.transmitRate,r=!0,a=!0,o=i.$modelValue<=n.$modelValue;M()&&0===n.$modelValue&&(o=!0),(!_.isInteger(n.$modelValue)||n.$modelValue<=0)&&(r=!1),(!_.isInteger(i.$modelValue)||i.$modelValue<=0)&&(a=!1),n.$setValidity(I.ONLY_NATURAL_NUMBERS_ALLOWED,r),n.$setValidity(I.POLLING_RATE_LARGER_THAN_TRANSMIT_RATE,o),i.$setValidity(I.ONLY_NATURAL_NUMBERS_ALLOWED,a),i.$setValidity(I.POLLING_RATE_LARGER_THAN_TRANSMIT_RATE,o)}}(e);M()&&function(e){var t=m[e].OPCUAUrl,i=y.validation.opcuaBrowsePath.pattern,n=t.$modelValue;t.$setValidity(I.INVALID_URL,!n||i.test(n))}(e);V()&&function(e){var t=m[e].ipRange,i=t.$modelValue;if(i){var n=i.split(",").map(function(e){return e.trim()}),r=_.every(n,T);t.$setValidity(I.IP_RANGE,r),r&&function(e){var t=e.$modelValue,i=!0,n=!0,r=BigInt(30);if(t){var a=BigInt(0),o=t.split(",");_.forEach(o,function(e){var t=T(e);t||(i=!1),a+=BigInt(t.countIps())}),(r<a||a<-r)&&(n=!1)}e.$setValidity(I.IP_RANGE,i),e.$setValidity(I.IP_RANGE_MAXLIMIT,n)}(t)}}(e);return n.invalid(m,e,t)},reloadDevices:R,onClickDelete:function(e){s({title:v("Delete device"),body:p.getString('You are about to delete device "{{name}}". Do you want to proceed?',e),size:"sm",labels:{ok:v("Delete")},status:"danger"}).then(function(){return r.remove(e)}).then(function(){return w()?f.onRemove(m.device,e):a.resolve()}).then(function(){m.devices=_.without(m.devices,e),r.update({id:m.device.id}),u.success(v("Device deleted."))}).catch(function(e){e&&u.danger(e)})},navigateToDetail:function(e){t.url("device/".concat(e.id))},triggerAutodiscovery:function(e){m.autoDiscoveryInProgress=!0;var t=e.ipRange.$modelValue;if(t){var i={deviceId:A,description:v("Autodiscovery request"),c8y_SnmpAutoDiscovery:{ipRange:t}};o.createWithNotifications(i).then(h)}},autoDiscoveryInProgress:!1,canTriggerAutodiscovery:function(e){return m.autoDiscoveryInProgress||e.ipRange.$dirty||_.isEmpty(e.ipRange.$modelValue)}})}e.$inject=["$rootScope","$q","$routeParams","$location","$window","c8yDeviceControl","c8yBase","c8yDevices","c8yModal","c8yAlert","c8yDeviceDatabase","c8yRealtime","c8yCanopenDevice","c8yConfig","gettext","gettextCatalog"],angular.module("c8y.modbusConfiguration4").component("c8yFieldbusConfig",{templateUrl:":::PLUGIN_PATH:::/fieldbus-config.html",bindings:{tab:"@"},controllerAs:"vm",controller:e})}();