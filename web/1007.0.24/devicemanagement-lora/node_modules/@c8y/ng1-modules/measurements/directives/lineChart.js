"use strict";function _slicedToArray(t,n){return _arrayWithHoles(t)||_iterableToArrayLimit(t,n)||_unsupportedIterableToArray(t,n)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(t,n){if(t){if("string"==typeof t)return _arrayLikeToArray(t,n);var e=Object.prototype.toString.call(t).slice(8,-1);return"Object"===e&&t.constructor&&(e=t.constructor.name),"Map"===e||"Set"===e?Array.from(t):"Arguments"===e||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e)?_arrayLikeToArray(t,n):void 0}}function _arrayLikeToArray(t,n){(null==n||n>t.length)&&(n=t.length);for(var e=0,r=new Array(n);e<n;e++)r[e]=t[e];return r}function _iterableToArrayLimit(t,n){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t)){var e=[],r=!0,a=!1,i=void 0;try{for(var o,c=t[Symbol.iterator]();!(r=(o=c.next()).done)&&(e.push(o.value),!n||e.length!==n);r=!0);}catch(t){a=!0,i=t}finally{try{r||null==c.return||c.return()}finally{if(a)throw i}}return e}}function _arrayWithHoles(t){if(Array.isArray(t))return t}!function(){function t(v,y,s){var g=200,x={left:50,bottom:20,top:10},a=d3.scale.category10(),i=d3.time.format.multi([[".%L",function(t){return t.getMilliseconds()}],[":%S",function(t){return t.getSeconds()}],["%H:%M",function(t){return t.getMinutes()}],["%H:%M",function(t){return t.getHours()}],["%a %d",function(t){return t.getDay()&&1!==t.getDate()}],["%b %d",function(t){return 1!==t.getDate()}],["%B",function(t){return t.getMonth()}],["%Y",function(){return!0}]]);function u(){return d3.scale.linear().range([g,0]).nice()}function b(t,n){var e=function(e){var l=[];return _.forEach(e,function(t){var n=_slicedToArray(t.scale.domain(),2),e=n[0],r=n[1],a=t.kpi&&t.kpi.unit||t.unit,i=_.find(l,{min:e,max:r})||_.find(l,function(t){return-1<t.units.indexOf(a)});i||(i={scale:u().domain([e,r]),min:e,max:r,units:[],colors:[],kpis:[]},l.push(i));var o=_slicedToArray(i.scale.domain(),2),c=o[0],s=o[1];i.scale.domain([d3.min([e,c]),d3.max([r,s])]),t.kpi&&i.kpis.push(t.kpi),-1===i.units.indexOf(a)&&i.units.push(a),i.colors.push(t.color),t.yaxis=i}),_.forEach(l,function(t){var n=t.scale;_.forEach(_.filter(e,{yaxis:t}),function(t){t.scale=n})}),l}(n);return t.selectAll(".yaxis").remove(),_.forEach(e,_.partial(r,t)),e}function r(t,r,a){var n=a?"right":"left",e=function(t,n){var e=d3.format(".2s");return d3.svg.axis().scale(t).orient(n||"left").ticks(6).tickFormat(function(t){return 4<String(t).length?e(t):t})}(r.scale,n),i=t.append("g").attr("class","yaxis axis");return function(t,n){var e=n?30:-35,r=n?90:-90;return t.append("text").attr({x:e,y:g/2,"text-anchor":"middle",transform:"rotate(".concat(r," , ").concat(e,",").concat(g/2,")")}).style({fill:"#999","font-size":"10px"})}(i,a).text(function(t){var n=t.kpis||[],e=t.units||[],r="";if(1===n.length){var a=_slicedToArray(n,1),i=a[0],o=i.unit||e[0];r=i.label+(o?" [".concat(o,"]"):"")}else r=e.join(" / ");return r}(r)),_.forEach(r.colors,function(n,e){i.append("circle").attr({cx:a?30:-35,cy:g-7*e,r:5,fill:function(){var t=r.kpis[e];return t&&t.color||n}})}),i.attr({transform:function(t,n){var e=Number(t.attr("width")),r=x.top,a=n?e-n*x.left-1:x.left;return"translate(".concat(a,", ").concat(r,")")}(t,a)}).call(e)}function k(t,n){var e=function(t){return d3.svg.axis().scale(t).orient("bottom").ticks(6).tickFormat(i)}(n),r=t.select(".xaxis");r.empty()&&(t.append("g").attr("class","xaxis axis").attr("transform","translate(".concat(x.left,", ").concat(g+x.top,")")),r=t.select(".xaxis")),r.call(e)}function c(t,n,e,r){var a="focusPoint".concat(r),i=e[a];if(!i){var o=s.getDOMId(e,r),c=t.select("#".concat(o));i=c.empty()?t.append("g").attr("transform","translate(".concat(x.left,", ").concat(x.top,")")).attr("class","focusPoint").attr("id",o).append("circle").style("visibility","hidden").attr({cx:0,cy:0,r:5}):c.select("circle")}return i.attr("fill",function(){return e.kpi&&e.kpi.color||n}),i}function T(t){t.style("visibility","visible")}function w(t){t.style("visibility","hidden")}function A(t,n,e){t.css("right","".concat(n.width-e,"px"))}function P(t,n){t.find(".loadingIcon").css("display",n?"inline-block":"none")}function I(t,i,o,n){var e=t.select(".focusContainer");o.color||(o.color=o.kpi&&o.kpi.color||function(t,n){return a(n)}(0,n)),o.focusPoint0=c(e,o.color,o,0),o.focusPoint1=c(e,o.color,o,1),o.moveFocusPoints||(o.moveFocusPoints=function(t){var n=this.getNearIndex(t);this.nearValue=o.values[n];var e=this.nearValue;this.nearTime=o.timelist[n];var r=this.nearTime,a=this.scale;_.forEach([this.focusPoint0,this.focusPoint1],function(t,n){t&&function(t,n,e){t.attr({cx:n,cy:e})}(t,i(r),a(e[["min","max"][n]]))})});var r=u().domain(function(t){var n=t.kpi,e=_.reduce(t.values,function(t,n){return t.push(n.min),t.push(n.max),t},[]),r=d3.max(e),a=d3.min(e),i=_.isUndefined(n&&n.min)?0:n.min,o=_.isUndefined(n&&n.max)?r:n.max;return o<0&&(o=0),[d3.min([i,a]),d3.max([o,r])]}(o));o.scale=r,o.pathFn=function(t,n,e){return d3.svg.area().interpolate("linear").x(t).y0(n).y1(e)}(function(t){return i(t.time)},function(t){return o.scale(t.val.min)},function(t){return o.scale(t.val.max)})}return{scope:{interval:"=?",aggregationType:"=?",autoAggregationOff:"@",dateFrom:"=?",dateTo:"=?",startRealtime:"=?",selectedKpis:"=?kpis",hideRealtime:"=?",hideHeader:"=?",frag:"@measurementType",deviceId:"@",datapoints:"=?"},restrict:"EA",link:function(a,t){var i,o,r,c,s;function n(){i=function(t){return{width:t.width(),height:g+x.bottom+x.top}}(t),o=function(t){var n=t.find(".graphHoverInfo"),e=t.find(".graphHoverInfoCurrent");return e.css("bottom","7px"),{hover:n,current:e}}(t),r=function(t,n){$(t).find(".graph").empty();var e=d3.select(t[0]||t).select(".graph").append("svg").attr(n).style({height:"".concat(n.height,"px")});return e.append("defs").append("svg:clipPath").attr("id","clip").attr("transform","translate(".concat(x.left,", ").concat(x.top,")")).append("svg:rect").attr("id","clip-rect").attr("x","0").attr("y","-5").attr("width",n.width).attr("height",n.height+5),e.append("g").attr("class","graphContainer").attr("clip-path","url(#clip)"),e.append("g").attr("class","focusContainer").attr("clip-path","url(#clip)"),e}(t,i),c=function(t){return t.append("g").attr("transform","translate(".concat(x.left,", ").concat(x.top,")")).append("line").style({visibility:"hidden",stroke:"#999999","stroke-dasharray":"3,3",opacity:.5}).attr({class:"overline",y1:0,y2:g})}(r),s=function(t,n){return d3.time.scale().range([0,t.width-x.left*(n||1)-1]).nice()}(i),r.append("rect").attr({width:i.width,height:g,transform:"translate(".concat(x.left,", ").concat(x.top,")")}).style({fill:"none","z-index":1e3,"pointer-events":"all"}).on("mouseenter",d).on("mouseleave",p).on("mousemove",f),l()}function l(t){var n=u(t);k(r,n)}function u(t){var n=a.filter.dateFrom,e=a.filter.dateTo;if(!n||!e)return s;a.realtimeState||(e=t?d3.max([e,d3.max(_.flattenDeep(_.map(t,"timelist")))]):e);var r=s.domain([n,e]);return s=r}function e(t){if(_.isArray(t)){var n=u(t);_.forEach(t,_.partial(I,r,n));var e=b(r,t);s.range([0,i.width-e.length*x.left-1]),function(t,n,e){var r=t.select(".graphContainer").selectAll(".area").data(e);r.exit().remove(),r.enter().append("g").attr("transform","translate(".concat(x.left,", ").concat(x.top,")")).attr("class","area").append("path"),r.select("path").attr("d",function(t){return t.pathFn(t.dataPoints)}).style({opacity:.8,stroke:function(t){return t.kpi&&t.kpi.color||t.color},fill:function(t){return t.kpi&&t.kpi.color||t.color}})}(r,0,t),l(t),f()}}function f(){var n,t=a.series;try{n=d3.mouse(this)[0]}catch(t){n=f.__cachedMouse}finally{f.__cachedMouse=n}var e=s.invert(n);!function(t,n){t.attr("transform","translate(".concat(n||0,", 0)"))}(c,n),a.currentTime=e,a.nearTime=_.reduce(t,function(t,n){return 0===t?n.nearTime:!1!==t&&!!moment(n.nearTime).isSame(t,"second")&&n.nearTime},0);var r=y(function(){_.isFunction(r.cancel)&&r.cancel(),_.forEach(t,function(t){t.moveFocusPoints(e)}),A(o.hover,i,Math.round(n+x.left)),A(o.current,i,Math.round(n+x.left-1))})}function d(){m(!0)}function p(){m(!1)}function m(t){var n=a.series;y(function(){_.forEach(_.union(_.map(n,"focusPoint0"),_.map(n,"focusPoint1"),[c]),t?T:w),a.showHover=t})}t.addClass("c8yGraphContainer"),a.$watch("series",function(t){e(t)}),a.$on("newData",function(){e(a.series)}),a.$watch("loading",_.partial(P,t));var h=_.throttle(function(){n(),e(a.series)},10);v.addEventListener("resize",h),a.$on("dashboardResize",h),a.$on("$destroy",function(){v.removeEventListener("resize",h)}),a.$watch("interval",function(t){null!=t&&(a.filter.interval=t)}),a.$watch("filter",function(t){a.dateFrom=t&&t.dateFrom,a.dateTo=t&&t.dateTo},!0),n()},templateUrl:":::PLUGIN_PATH:::/views/lineChart.html",controller:"c8yLineChartCtrl"}}t.$inject=["$window","$timeout","c8yLineChartSvc"],angular.module("c8y.core.measurements2").directive("c8yMeasurementLineChart",t)}();