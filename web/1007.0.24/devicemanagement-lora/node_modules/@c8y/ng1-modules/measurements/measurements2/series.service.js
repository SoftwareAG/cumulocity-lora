"use strict";function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function _iterableToArrayLimit(e,t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e)){var n=[],r=!0,i=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(r=(o=s.next()).done)&&(n.push(o.value),!t||n.length!==t);r=!0);}catch(e){i=!0,a=e}finally{try{r||null==s.return||s.return()}finally{if(i)throw a}}return n}}function _arrayWithHoles(e){if(Array.isArray(e))return e}!function(){function e(r,s,c){function i(e,t,n,r,i){var a=i,o="NONE"!==r?r:void 0;return s.listForDataPoint(e,t,n,o,a)}function e(e,t){var n=this;return n.chart=e,n.dataPoint=t,n.hoverItems=[],n.values=[],n.implicitDomain={},n.bisect=d3.bisector(function(e){return e.time}).right,n.loadSeriesData=r.latest(i),n}return e.prototype={defaultRenderType:"min",defaultLineType:"line",loadDataAndRender:function(e,t,n){var r=this;r.loadData(e,t,n).finally(function(){r.chart.render()})},loadData:function(e,t,n){var r=this,i=r.dataPoint,a=r._aggregation;return this.loadSeriesData(i,e,t,n,r.chart).then(function(e){return a!==n&&(r.values.length=0,r._aggregation=n,r.resetImplicitDomain()),r.appendValues(e.values),e})},appendValues:function(e){var a=this,o=a.values,s=a.implicitDomain;return _.forEach(e,function(e){if(_.isFinite(e.min)&&_.isFinite(e.max)){var t=new Date(e.time),n=t.getTime(),r=_.find(o,function(e){return n===e.time.getTime()}),i={time:t,val:{min:e.min,max:e.max}};o.length&&_.last(o).time.getTime()>n&&(a._valuesSortingNeeded=!0),r?_.assign(r,i):o.push(i),(_.isUndefined(s.min)||e.min<s.min)&&(s.min=e.min),(_.isUndefined(s.max)||e.max>s.max)&&(s.max=e.max)}}),o},destroy:function(){this.svg&&this.svg.remove(),this.hoverItems=[],delete this.svg},resetImplicitDomain:function(){this.implicitDomain.min=void 0,this.implicitDomain.max=void 0},domain:function(){var e=this.dataPoint,t=this.implicitDomain,n=_.isUndefined(e.min)||""===e.min?t.min:Number(e.min),r=_.isUndefined(e.max)||""===e.max?t.max:Number(e.max);return(_.isUndefined(n)||Number.isNaN(n))&&(n=d3.min(this.values,function(e){return e.val.min}),_.isUndefined(n)||(t.min=n),n=n||0),(_.isUndefined(r)||Number.isNaN(r))&&(r=d3.max(this.values,function(e){return e.val.max}),_.isUndefined(r)||(t.max=r),r=r||0),n===r&&(n-=1,r+=1),[n,r]},scale:function(){return this.chart.scaleY().domain(this.domain())},getRenderType:function(){return this.dataPoint.renderType||this.renderType||this.defaultRenderType},getLineType:function(){return this.dataPoint.lineType||this.lineType||this.defaultLineType},render:function(){var e=this,t=e.chart.svgSeries,n=e.getRenderType(),r=e.getLineType(),i=e.values,a=e.svg;if(!a||a.minOrMax===n&&a.chartType===n||e.destroy(),!e.svg){var o=e.chart.margins;e.svg=t.append("g").attr("transform",c.translate(o.l,o.t)).attr("class","series"),(a=e.svg).minOrMax=n,a.chartType=r}e._valuesSortingNeeded&&(delete e._valuesSortingNeeded,i.sort(function(e,t){return e.time>t.time?1:e.time<t.time?-1:0})),e.chart.allowSelectFocusTime||e.removeOldHiddenValues(),"bars"===r?e._render_bars():"area"!==n?e._render_path(n):e._render_area()},removeOldHiddenValues:function(){var e=this.values,n=this.chart.axisX._from,r=0;_.forEach(e,function(e,t){return!moment(e.time).isSameOrAfter(n)||(r=t-1,!1)}),r&&e.splice(0,r)},_render_path:function(t){var n=this,e=n.svg._path;function r(e){return n.chart.axisX.scale()(e.time)}function i(e){return n.scale()(e.val[t])}function a(){return n.dataPoint.color}e||(n.svg._path=n.svg.append("path"),(e=n.svg._path).style({"pointer-events":"none"})),n._create_update_focusPoint(1),n._render_path_line(e,r,i,a),n._render_path_points(r,i,a)},_render_path_line:function(e,t,n,r){var i=this,a=i.getLineType()||"linear",o=d3.svg.line().interpolate(a).x(t).y(n);_.includes(["bars","points"],i.getLineType())?(e.remove(),i.svg._path=void 0):e.attr("d",function(){return o(i.values)}).style({fill:"transparent",stroke:r})},_render_path_points:function(e,t,n){if(_.includes(["points","linePoints"],this.getLineType())){var r=this.svg.selectAll("circle.point").data(this.values);r.enter().append("circle").attr("class","point"),r.exit().remove(),r.attr("cx",e).attr("cy",t).attr("r",4).attr("fill","transparent").attr("stroke",n)}else this.svg.selectAll("circle.point").remove()},_render_bars:function(){var i=this,e=_.filter(i.chart.series,function(e){return e.getLineType()===i.getLineType()}),r=e.length,a=_.findIndex(e,function(e){return e===i}),o=i.svg.minOrMax,t=function(){var n=i.chart.axisX.scale();if(i._aggregation)return function(e){var t=n(e.time)-r*c()/2;return t+a*c()};return function(e){return n(e.time)}}(),n=l(),s=m(n),c=function(){var e=1;if(i._aggregation){var t=function(e){var t=i.chart.axisX.scale(),n=_slicedToArray(t.domain(),1)[0],r=moment(n).add(1,{MINUTELY:"minute",HOURLY:"hour",DAILY:"day"}[e]).toDate();return t(r)-t(n)}(i._aggregation);20<(e=t/(r+1))&&(e=20),e<1&&(e=1)}return _.constant(e)}();function l(e){var t=i.scale(),n=e;return n||(n="area"===o?"max":o),function(e){return t(e.val[n])}}function u(n){var r=_.max(i.scale().range());return function(e){var t=n(e);return r<t?r:t}}function m(t){var n=i.scale().range();return function(e){return Math.abs(_.max(n)-t(e))}}var d={x:t,y:u(n),width:c,height:s,fill:function(){return i.dataPoint.color}},v=i.svg.selectAll(".bars").data(i.values),f=v.enter().append("g").style("pointer-events","none").attr("class",function(e,t){return"bar index".concat(t)});if(f.append("rect").attr("class","barmain"),v.exit().remove(),v.select(".barmain").attr(d),"area"===o&&i._aggregation){f.append("rect").attr("class","barmin").style("opacity","0.2");var p=l("min"),h=_.defaults({fill:"#000",y:u(p),height:m(p)},d);v.select(".barmin").attr(h)}i._aggregation||i._create_update_focusPoint(1)},hover:function(e){var t=this,n=t.getRenderType(),r=t.getLineType(),i=t.values[e];(t.overPoint=i)&&(t._focusPointTime=i.time,"bars"===r&&this._hover_bars(e)),t._render_focusPoint(1,"area"!==n?n:"max"),t._render_focusPoint(2,"area"!==n?n:"min")},_hover_bars:function(e){this.svg.select(".hover").classed("hover",!1).style({opacity:1}),this.svg.select(".index".concat(e," .barmain")).classed("hover",!0).style({opacity:.5})},mouseleave:function(){"bars"===this.getLineType()&&this.svg.select(".hover").classed("hover",!1).style({opacity:1})},_create_update_focusPoint:function(e){var t=this,n="focusPoint".concat(e),r=t.svg[n];r||(t.svg[n]=t.svg.append("circle").style({visibility:t.chart.hoverItemsVisible?"visible":"hidden","pointer-events":"all"}).attr({cx:0,cy:0,r:3}),r=t.svg[n],t.addFocusPointEvent(r),t.hoverItems.push(r)),r.attr({fill:function(){return t.dataPoint.color}})},_render_focusPoint:function(e,t){var n=this.chart.axisX.scale(),r=this.scale(),i=this.svg,a=this.overPoint,o=i&&i["focusPoint".concat(e)];if(o)if(a){var s=i.xFocusScale?i.xFocusScale(a):n(a.time),c=r(a.val[t]);o.attr({cx:s,cy:c})}else o.style("visibility","hidden")},_render_area:function(){var t=this,e=t.getLineType()||"linear";function n(e){return t.chart.axisX.scale()(e.time)}function r(e){return t.scale()(e.val.max)}function i(e){return t.scale()(e.val.min)}function a(){return t.dataPoint.color}var o=d3.svg.area().interpolate(e).x(n).y0(r).y1(i),s=t.svg._path;s||(t.svg._path=t.svg.append("path").style({"pointer-events":"none",opacity:.8})),s=t.svg._path,t._create_update_focusPoint(1),t._create_update_focusPoint(2),s.attr("d",function(){return o(t.values)}).style({"pointer-events":"none",stroke:a,fill:a}),_.includes(["points","linePoints"],t.getLineType())?(t.svg.selectAll("circle.point.max").data(t.values).enter().append("circle").attr("class","point max"),t.svg.selectAll("circle.point.min").data(t.values).enter().append("circle").attr("class","point min"),t.svg.selectAll("circle.point.max").attr("cx",n).attr("cy",r).attr("r",4).attr("fill","transparent").attr("stroke",a),t.svg.selectAll("circle.point.min").attr("cx",n).attr("cy",i).attr("r",4).attr("fill","transparent").attr("stroke",a)):t.svg.selectAll("circle.point").remove()},onMove:function(e,t){var n=this.getNearIndex(e);this.hover(n,e,t)},hoverValue:function(){var e=this.getRenderType(),t=this.overPoint,n=this.dataPoint.unit||"",r=" -- ";if(t){var i=t.val,a=i.min,o=i.max;"min"===e&&(r="".concat(a," ").concat(n)),"max"===e&&(r="".concat(o," ").concat(n)),"area"===e&&(r="".concat(a," - ").concat(o," ").concat(n))}return r},hoverTime:function(){var e=this.overPoint;return e?moment(e.time):"--"},getNearIndex:function(e){var t=e,n=this.values,r=n.length-1,i=this.bisect(n,e,1,r),a=n[i-1]&&n[i-1].time,o=n[i]&&n[i].time;return _.isUndefined(a)?i:_.isUndefined(o)?i-1:t-a<o-t?i-1:i},measurementFits:function(e){return s.rtMeasurementForDatapoint(this.dataPoint)(e)},addFocusPointEvent:function(e){var n=this,r=n.chart;e.on("click",function(){if(r.allowSelectFocusTime){var e={target:(n.dataPoint.__target||{}).id,date:moment(n._focusPointTime).format("YYYY-MM-DDTHH:mm:ss.SSSZ")},t=r.selectedPoint;t&&moment(e.date).isSame(moment(t.date))?r.clearSelectPoint():r.setSelectPoint(e)}}),e.on("mouseenter",function(){r.allowSelectFocusTime&&e.style({cursor:"pointer"}).attr({r:6})}),e.on("mouseleave",function(){r.allowSelectFocusTime&&e.style({cursor:"default"}).attr({r:3})})},realtimeMeasurement:function(e){var t=this,n=t.measurementFits(e);return n&&(t.__realtimeToAppend||(t.__realtimeToAppend=[]),t.__realtimeToAppend.push(n.values)),t.__realtimeToAppendTimout||(t.__realtimeToAppendTimout=setTimeout(function(){t.appendValues(_.flattenDeep(t.__realtimeToAppend)),t.__realtimeToAppend=[],t.__realtimeToAppendTimout=void 0,t.chart.render()},250)),n}},e}e.$inject=["c8yBase","c8yMeasurements","c8yChartCommon"],angular.module("c8y.core.measurements2").factory("c8ySeries",e)}();