"use strict";!function(){function e(s,e,l,c,r,u,d,p){var i=this;this.downloadReportForDevice=function(e,t,r,n){var o=_.get(t,"id",t),a=_(r).map(_.partial(i.createPairFromSeries,o)).value();return new i.Downloader(e,n,a).start()},this.downloadReportForDatapoints=function(e,t,r){var n=_.map(t,i.createPairFromDp);return n.length?new i.Downloader(e,r,n).start():s.reject(new Error(d("At least 1 data point must be selected")))},this.createPairFromSeries=function(e,t){return{source:e,fragmentType:t}},this.createPairFromDp=function(e){return{source:e.__target.id,fragmentType:e.fragment}},this.Downloader=function(n,o,e){var a=this,t=_.uniqBy(e,function(e){return JSON.stringify(e)});function i(e){return{text:d("Access denied."),type:"danger",detailedData:e}}this.downloadReports=function(){var e=_(t).map(a.downloadReportForPair).value();return s.all(e).then(a.onDownloads).catch(a.onFail)},this.start=function(){return r({templateUrl:":::PLUGIN_PATH:::/ui/views/measurementsReport.html",title:d("Generating report"),controller:["$scope","$timeout",function(n,o){n.completed=0,n.total=t.length,n.reportFileName="report.zip",n.close=function(){if(void 0!==window.navigator.msSaveBlob){var e=n.blob,t=n.reportFileName;window.navigator.msSaveBlob(e,t)}else{var r=n.url;o(function(){window.URL.revokeObjectURL(r)},5e3)}n.$close()},a.scope=n,a.downloadReports()}]})},this.downloadReportForPair=function(e,t){var r=a.getFilter(e,t);return l.list(r,n).then(_.partial(a.onDownload,e)).catch(_.partial(a.onAsyncResult,e))},this.onDownload=function(e,t){return a.scope.completed+=1,t.name=[e.source,".",e.fragmentType,".",n.name].join(""),t},this.onAsyncResult=function(e,t){return t.async?(a.scope.completed+=1,null):s.reject(t)},this.onFail=function(e){a.scope.$dismiss(),function(r){var n=s.defer();if(403===r.status)if(r.data instanceof Blob){var e=new FileReader;e.addEventListener("loadend",function(e){try{var t=JSON.parse(_.get(e,"srcElement.result"));n.resolve({type:"danger",text:p.getString(t.message),detailedData:t})}catch(e){n.resolve(i(r))}}),e.readAsText(r.data)}else n.resolve(i(r));else n.resolve({type:"danger",text:d("An error occurred. Please try again later."),detailedData:r});return n.promise}(e).then(u.add)},this.onDownloads=function(e){var t=e.filter(_.identity),r=e.length-t.length;if(0<r){var n=p.getPlural(r,"You will get a CSV/Excel file for 1 series via email.","You will get CSV/Excel files for {{$count}} series via email.",{});u.success(n)}return 0===t.length?s.when():c.zipFiles(t).then(function(e){a.scope.blob=e,a.scope.url=window.URL.createObjectURL(e)})},this.getFilter=function(e,t){var r=_.isArray(o)?o[t]:o;return r=_.merge({},r,e)}}}e.$inject=["$q","$rootScope","c8yMeasurements","c8yZip","c8yModal","c8yAlert","gettext","gettextCatalog"],angular.module("c8y.ui").service("MeasurementsReportSvc",e)}();