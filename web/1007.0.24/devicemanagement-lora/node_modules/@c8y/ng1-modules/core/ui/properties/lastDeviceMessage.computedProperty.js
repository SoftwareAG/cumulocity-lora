"use strict";function _objectSpread(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?Object(arguments[e]):{},r=Object.keys(i);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(i).filter(function(e){return Object.getOwnPropertyDescriptor(i,e).enumerable}))),r.forEach(function(e){_defineProperty(t,e,i[e])})}return t}function _defineProperty(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}!function(){function e(e){e.register("lastDeviceMessage",t)}function t(n,e,t,o,a,c,i){var r={};function s(e){return i.list({source:e,pageSize:50})}function u(e,t){var i=this;i.device=e,i.service=t.service,i.check_audit=t.check_audit,i.rt_channel="/".concat(t.rt_channel,"/").concat(e.id),i.filter_prop=t.filter_prop||"source",i.time_prop=t.time_prop||"time",i.ops=t.ops,i.list(t.listFilters).then(_.bind(i.onList,i))}function p(i){var r=this;r.device=i,r.dateObj=[function(t){var e={};return Object.defineProperty(e,"timestamp",{get:function(){var e=t.device||{};return e.c8y_Availability&&e.c8y_Availability.lastMessage}}),e}(r)],r.devices=new Set,_.forEach([{service:e,rt_channel:"alarms",check_audit:!0},{service:t,rt_channel:"events",ops:["CREATE"],time_prop:"creationTime"},{service:o,rt_channel:"measurements",ops:["CREATE"],listFilters:{revert:!0}},{service:a,rt_channel:"operations",ops:["UPDATE"],filter_prop:"deviceId",check_audit:!0,listFilters:{dateFrom:new Date(0).toISOString(),dateTo:new Date(Date.now()).toISOString(),revert:!0}}],function(e){var t=new u(i,e);r.dateObj.push(t)})}function d(e){r[e.id]=r[e.id]||new p(e);var t=r[e.id];return t.device=e,t.add(e),t.get()}return u.prototype.list=function(){var e=this,t=_objectSpread({pageSize:1},0<arguments.length&&void 0!==arguments[0]?arguments[0]:{});return t[e.filter_prop]=e.device.id,e.service.list(t)},u.prototype.updateValue=function(e){var t=this;t.timestamp||(t.timestamp=e),moment(t.timestamp).isBefore(e)&&(t.timestamp=e)},u.prototype.onList=function(e){var t=this,i=_(e),r=t.check_audit?"id":t.time_prop,n=_.bind(t.updateValue,t),o=t.check_audit?function(e){s(e).then(_.bind(t.onAudit,t))}:n;i.map(r).forEach(o),t.startRealtime()},u.prototype.onRealtime=function(e,t){var i=this;i.check_audit?s(t.id).then(_.bind(i.onAudit,i)):i.updateValue(t[i.time_prop])},u.prototype.onAudit=function(e){_(e).filter(_.bind(this.byOwner,this)).map("creationTime").forEach(_.bind(this.updateValue,this))},u.prototype.byOwner=function(e){var t=this.device;return e.user===t.owner},u.prototype.startRealtime=function(){var t=this;c.createLocalId(t,"rtId");var i=t.rtId,r=t.rt_channel,e=t.ops||["CREATE","UPDATE","DELETE"];_.forEach(e,function(e){n.addListener(i,r,e,_.bind(t.onRealtime,t))}),n.start(i,r)},u.prototype.stopRealtime=function(){n.removeSubscriber(this.rtId,this.rt_channel)},p.prototype.detach=function(e){var t=this.devices;t.delete(e),t.size||(_(this.dateObj).filter("stopRealtime").forEach(function(e){return e.stopRealtime()}),delete r[e.id])},p.prototype.add=function(e){this.devices.has(e)||this.devices.add(e)},p.prototype.get=function(){return function(e){var t=_(e).map(function(e){return e&&moment(e)}).filter(_.identity).value();return t.length?moment.max(t).format("YYYY-MM-DDTHH:mm:ssZ"):void 0}(_.map(this.dateObj,"timestamp"))},d.detach=function(e){var t=r[e.id];t&&t.detach(e)},d}t.$inject=["c8yRealtime","c8yAlarms","c8yEvents","c8yMeasurements","c8yDeviceControl","c8yBase","c8yAudits"],e.$inject=["c8yComputedPropertiesProvider"],angular.module("c8y.ui").config(e)}();