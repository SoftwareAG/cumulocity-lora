"use strict";function _slicedToArray(t,n){return _arrayWithHoles(t)||_iterableToArrayLimit(t,n)||_unsupportedIterableToArray(t,n)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(t,n){if(t){if("string"==typeof t)return _arrayLikeToArray(t,n);var e=Object.prototype.toString.call(t).slice(8,-1);return"Object"===e&&t.constructor&&(e=t.constructor.name),"Map"===e||"Set"===e?Array.from(t):"Arguments"===e||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e)?_arrayLikeToArray(t,n):void 0}}function _arrayLikeToArray(t,n){(null==n||n>t.length)&&(n=t.length);for(var e=0,r=new Array(n);e<n;e++)r[e]=t[e];return r}function _iterableToArrayLimit(t,n){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t)){var e=[],r=!0,i=!1,a=void 0;try{for(var o,l=t[Symbol.iterator]();!(r=(o=l.next()).done)&&(e.push(o.value),!n||e.length!==n);r=!0);}catch(t){i=!0,a=t}finally{try{r||null==l.return||l.return()}finally{if(i)throw a}}return e}}function _arrayWithHoles(t){if(Array.isArray(t))return t}!function(){function t(A,w,T,I,N,$,P){return{link:function(e){var a=[],r="c8y_Position",i="com_nsn_startups_vendme_fragments_GPSCoordinates",o=v,l=b,c=[];function t(){c.length=0,a.length=0,e.deviceId?u(e.deviceId):d()}function u(t){return w.detail(t).then(N.getResData).then(n)}function n(t){c.push(t),e.multipleDevices?function(t){A.all([w.childDevices(t),w.childAssets(t)]).then(_.flattenDeep).then(s)}(e.deviceId):d(f(c))}function s(t){d(f(_.union(c,t)))}function f(t){return _.map(function(t){return _.filter(t,function(t){return!$.isGroup(t)})}(t),"id")}function d(t){var n={};return(t&&t.length?(n.ids=t.join(","),w.list(n)):A.all([w.list({fragmentType:i}),w.list({fragmentType:r})]).then(_.flattenDeep)).then(m).then(v)}function m(t){return e.withPosition=function(t){return _.filter(t,function(t){return g(t)})}(t),_.filter(_.map(e.withPosition,b),_.identity)}function h(){e.realtimeAnimation=!1}function y(t,n){T.addListener(e.$id,e.realtimeChannel,t,n)}function p(t,n){g(n)&&(l(n),o())}function g(t){return t[r]||t[i]}function v(t){t&&t.length&&_.forEach(t,function(t){a.push(t)}),e.withPosition.length&&I.getMap("c8y-map-".concat(e.$id)).then(function(t){t.fitBounds(a,{padding:[50,50]})})}function b(t){var n=g(t),e=_.cloneDeep(n||{}),r=null,i=_.find(a,{id:t.id});return i?(n.lat=Number(n.lat),i.lat=n.lat,n.lng=Number(n.lng),i.lng=n.lng):(n.lat=Number(n.lat),e.lat=n.lat,n.lng=Number(n.lng),e.lng=n.lng,n&&_.isNumber(n.lat)&&_.isNumber(n.lng)&&!_.isNaN(_.toNumber(n.lat))&&!_.isNaN(_.toNumber(n.lng))&&(e.id=t.id,e.message=function(t){return'\n          <a\n            class="btn btn-link"\n            style="width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"\n            href="#/device/'.concat(t.id,'"\n            title="').concat(t.name,'"\n          >\n            ').concat(t.name,"\n          </a>\n        ")}(t),e.icon=function(t){return{className:"".concat(t,"-marker-icon"),iconSize:[25,41],iconAnchor:[12,41],type:"div"}}(function(t){var n=t.c8y_ActiveAlarmsStatus||{};return _.find(["critical","major","minor","warning"],function(t){return n[t]})||"normal"}(t)),r=e)),r}e.$watch("deviceId",function(t,n){t&&t!==n&&(c=[],a.length=0,u(t))}),e.markers=a,e.mapDefault={scrollWheelZoom:!1},e.cssToHide=function(){return e.withPosition&&e.withPosition.length?{}:{visibility:"hidden"}},e.paging={refresh:!0},e.realtime||(e.refresh=t),A.all([P.listByUser(),I.getMap("c8y-map-".concat(e.$id))]).then(function(t){var n=_slicedToArray(t,2),e=n[0],r=n[1];if(_.some(e,{contextPath:"openseamap"})){var i=L.tileLayer("/apps/openseamap/{z}/{x}/{y}.png");L.control.layers({},{openseamap:i}).addTo(r)}}),e.realtimeChannel="/managedobjects/*",y("".concat(e.$id,"-subscribed"),h),y("UPDATE",p),e.realtime&&(e.$on("$destroy",function(){T.stop(e.$id,e.realtimeChannel)}),T.start(e.$id,e.realtimeChannel)),t()},restrict:"E",scope:{deviceId:"=?",multipleDevices:"=",cssClass:"@",width:"=?",height:"=?",config:"=",realtime:"="},templateUrl:":::PLUGIN_PATH:::/ui/views/map.html"}}t.$inject=["$q","c8yInventory","c8yRealtime","leafletData","c8yBase","c8yGroups","c8yApplication"],angular.module("c8y.ui").directive("c8yMap",t)}();