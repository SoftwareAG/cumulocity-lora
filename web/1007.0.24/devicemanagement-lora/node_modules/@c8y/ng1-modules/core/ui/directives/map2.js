"use strict";function _objectSpread(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?Object(arguments[e]):{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(e){_defineProperty(t,e,n[e])})}return t}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(){function e(P,T,S,e,t,n,j,$,w,A,C,M,r,O,R,D,E,B,I){return a.$inject=["$scope","$element"],{restrict:"EA",templateUrl:":::PLUGIN_PATH:::/ui/views/map2.html",scope:{multipleDevices:"&",realtime:"&",cssClass:"@",deviceId:"&",config:"&",markerTemplate:"&",controlButtons:"&",noDataFetch:"&",map:"=?",c8yLegend:"&"},link:function(e){e.$on("dashboard-change",function(){e.map&&e.map.leafletMap&&e.map.leafletMap.invalidateSize()})},controller:a};function a(o,e){var n,t={padding:[50,50]},c=[],s=!1,l=D("The map widget displays up to {{count}} devices."),u={mapCustomBaseLayers:w.getPluginService("mapCustomBaseLayers"),ecbPositionSelector:w.getPluginService("ecbPositionSelector"),mapMarkerClusterer:w.getPluginService("mapMarkerClusterer")};o.map=this,e.addClass(o.cssClass);var d=L.map(e.find(".c8y-map-internal").get(0)).fitBounds(L.latLngBounds(L.latLng(14,-130.3),L.latLng(53.9,112.3)));o.map.leafletMap=d,o.map.event=o.$new(!0),o.map.markers=c;var r=L.tileLayer("//{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{noWrap:!0});r.addTo(d),u.mapMarkerClusterer&&u.mapMarkerClusterer.applyClustering({mapInternalScope:o}),o.map.tracker=new C.Tracker(o),o.tracker=o.map.tracker,o.tracker.onPaths(function(e,t){n&&d.removeLayer(n);(n=e).addTo(d),t&&f(n.getBounds())}),o.$on("$destroy",function(){o.cleanRealtime&&o.cleanRealtime(),s=!0});var a=L.Control.extend({options:{position:"topright"},onAdd:function(){var e=L.DomUtil.create("div");return angular.element(e).html('\n            <c8y-realtime-switch\n               ng-if="!realtime()"\n               get-state="state()"\n               on-start="startRt()"\n               on-stop="stopRt()"\n             ></c8y-realtime-switch>\n             <c8y-refresh-btn></c8y-refresh-btn>\n          '),T(e)(o),e}}),i=L.Control.extend({options:{position:"bottomright"},onAdd:function(){var e=L.DomUtil.create("div");return angular.element(e).html("<div c8y-map-legend></div>"),T(e)(o),e}}),p=L.control.layers({OSM:r});function m(){var e=o.deviceId();return(e?function(n){var e;if(_.isArray(n))e=v(n);else{var r=[];e=j.detail(n).then(w.getResData).then(function(e){r.push(e);var t=P.when([]);return o.multipleDevices()&&(t=P.all([j.childDevices(n),j.childAssets(n)]).then(_.flattenDeep)),t}).then(function(e){r=_.union(r,e);var t=_(r).filter(function(e){return!A.isGroup(e)}).map("id").value();return _.isEmpty(t)?(g(),P.when(new L.featureGroup)):v(t)})}return e}(e):v()).then(function(e){o.tracker.getActiveDeviceIds().length||f(e.getBounds())})}function f(e){e&&e.isValid()&&d.fitBounds(e,t)}function g(){o.devices=[],_.forEach(c,function(e){d.removeLayer(e)}),c.length=0}function v(n){var e,i={};if(o.noDataFetch())return P.reject();if(delete o.filterIds,u.ecbPositionSelector)e=u.ecbPositionSelector.getPositionedDevicesByEvents();else if(n&&n.length){var t=_.uniq(n),r={};r.ids=t.join(","),r.pageSize=t.length,o.filterIds=t,e=j.list(r),b()}else{var a={__or:[{__and:[{__has:"".concat(M.c8y_Position,".lat")},{__has:"".concat(M.c8y_Position,".lng")}]},{__and:[{__has:"".concat(M.v4e_Position,".lat")},{__has:"".concat(M.v4e_Position,".lng")}]}]};e=j.listQuery(a),b()}return function t(e){var r,a;return e.then(function(e){var t=e.statistics,n=e.paging;return r=n.next,a=t.pageSize,e}).then(function(e){return _(e).filter(function(e){var t=M.getLocationFragment(e);return!(!t||180<Math.abs(t.lng)||90<Math.abs(t.lat))||(console.warn("Device ".concat(e.name," has an invalid position!")),!1)}).reduce(function(e,t){return e[t.id]=t,e},{})}).then(function(e){return i=function(e,t,n){var r=_objectSpread({},e),a=Object.keys(r).length;if(a+Object.keys(t).length<=n)r=_objectSpread({},r,t);else{B.info(E.getString(l,{count:n}));var i=Object.entries(t).filter(function(e,t){return void 0!==e&&t+a<n}).reduce(function(e,t){return e[t[0]]=t[1],e},{});r=_objectSpread({},r,i)}return r}(i,e,a),Object.keys(i).length<a&&r&&!s&&t(r()),Object.keys(i).length>=a&&r&&B.info(E.getString(l,{count:a})),i}).then(function(e){g(),o.devices=e;var t=_.map(e,function(e){var t=h(e),n=M.getLocationFragment(e),r=L.marker(L.latLng(n.lat,n.lng),{icon:t}).addTo(d);return y(e,r).then(function(){r.on("click",function(){return y(e,r)}),r.id=e.id,c.push(r)})});return P.all(t).then(function(){return new L.featureGroup(c)})}).then(function(e){return o.map.event.$broadcast("refresh",n),e}).then(function(e){o.tracker.getActiveDeviceIds().length||f(e.getBounds())})}(e)}function h(e){var t=e.c8y_ActiveAlarmsStatus||{},n=_.find(["critical","major","minor","warning"],function(e){return t[e]})||"normal";return L.divIcon({className:"".concat(n,"-marker-icon"),iconSize:[25,41],iconAnchor:[12.5,41]})}function y(e,n){return function(i){var e={fragmentType:"c8y_Position",dateFrom:"1970-01-01",dateTo:moment().add(1,"days").format("YYYY-MM-DD"),pageSize:1,source:i.id};return O.list(e).then(function(e){var t=e.length?e[0].time:void 0;o.markerTemplate()||(o.markerTemplate=k);var n=S("absoluteDate")(t),r='\n              <div\n                c8y-map-marker\n                i-mo="devices['.concat(i.id,']"\n                i-template="markerTemplate()"\n                i-tracker="tracker"\n                last-updated="\'').concat(n,"'\"\n              ></div>\n            "),a=angular.element(r);return T(a)(o),a.get(0)})}(e).then(function(e){var t=n.getPopup()||L.popup({minWidth:120});n.bindPopup(t,{offset:L.point(0,-20)}),t.setContent(e)})}function k(){return"<div ng-include=\"'".concat(I,"'\"></div>")}function b(){var e=o.realtimeChannel,t="/managedobjects/*",n=o.filterIds,r=o.deviceId();if(r&&!n&&(n=[r]),n&&(t="/managedobjects/".concat(n.join(","))),e){if(e===t)return;o.cleanRealtime()}e=t,o.realtimeChannel=e,$.addListener.bind($,o.$id,e)("UPDATE",function(e,t){var n=M.getLocationFragment(t);if(n){var r=_.find(c,{id:t.id});if(r){r.setLatLng(L.latLng(n.lat,n.lng)),r.setIcon(h(t));var a=r.getPopup();a&&a._isOpen&&y(t,r)}o.devices&&o.devices[t.id]&&(o.devices[t.id]=t),o.map.event.$broadcast("realtime",t)}}),o.cleanRealtime=function(){$.removeSubscriber(o.$id,e)},o.map.state=function(){return $.getStatus(o.$id,e)},o.map.startRt=function(){o.noDataFetch()||($.start(o.$id,e),o.tracker.state||o.tracker.start())},o.map.stopRt=function(){$.stop(o.$id,e),o.tracker.state&&o.tracker.stop()},_.assign(o,{state:o.map.state,startRt:o.map.startRt,stopRt:o.map.stopRt}),o.realtime()&&o.startRt()}(function(r,a){var e=R.getBaseLayers(o.map),t=R.getOverlays(o.map),n=P.reject();u.mapCustomBaseLayers&&(n=u.mapCustomBaseLayers.create({google:!0,here:!0,bing:!0,googleSatellite:!0,hereSatellite:!0,bingSatellite:!0}));P.any(_.values(e).concat(n,_.values(t))).then(function(e){_.isEmpty(e)||r.addTo(a)}),_.forEach(e,function(e,t){e.then(function(e){r.addBaseLayer(e,t)})}),n.then(function(e){_.forEach(e,function(e){r.addBaseLayer(e.layer,e.name)})}),R.getUserOverlayPreferences().then(function(n){_.forEach(t,function(e,t){e.then(function(e){r.addOverlay(e,t),n[t]&&a.addLayer(e)})})})})(o.map.layersControl=p,d),d.on("overlayadd",function(e){R.setUserOverlayPreference(e,!0)}),d.on("overlayremove",function(e){R.setUserOverlayPreference(e,!1)}),o.controlButtons()&&d.addControl(new a),o.c8yLegend()&&d.addControl(new i),o.paging={refresh:!0},o.refresh=m,b(),o.$watch("deviceId()",m),o.$watch("noDataFetch()",function(e){e?o.stopRt():o.startRt()})}}function t(n,e,r){return{restrict:"EA",scope:{iMo:"&",iTemplate:"&",iTracker:"&",lastUpdated:"="},link:function(t,e){_.assign(t,{mo:t.iMo(),tracker:_.defaults(t.iTracker(),{__gps:!1,__gsm:!1}),onTrackingChange:function(e){t.tracker.__gps||t.tracker.__gsm?t.tracker.activate(e,{gps:t.tracker.__gps,gsm:t.tracker.__gsm}):t.tracker.deactivate(e)}}),t.showTrackingOptions=!1,r.gsmTrackingAvailable(t.mo).then(function(e){t.showTrackingOptions=e}),e.html(t.iTemplate()),n(e.contents())(t)}}}t.$inject=["$compile","c8yApplication","c8yCombain"],e.$inject=["$q","$compile","$filter","$http","$timeout","$injector","c8yInventory","c8yRealtime","c8yBase","c8yGroups","c8yTracker","c8yGeo","c8yApplication","c8yEvents","c8yMapConfig","gettext","gettextCatalog","c8yAlert","MARKER_TEMPLATE"],angular.module("c8y.ui").constant("MARKER_TEMPLATE",":::PLUGIN_PATH:::/ui/views/map2-markerTemplate.html").directive("c8yMapInternal",e).directive("c8yMapMarker",t).directive("c8yMapLegend",function(){return{restrict:"EA",templateUrl:":::PLUGIN_PATH:::/ui/views/map2-legend.html"}})}();