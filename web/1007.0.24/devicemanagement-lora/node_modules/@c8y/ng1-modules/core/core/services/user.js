"use strict";function _objectSpread(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?Object(arguments[e]):{},r=Object.keys(t);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(t).filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.forEach(function(e){_defineProperty(n,e,t[e])})}return n}function _defineProperty(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,n){if(e){if("string"==typeof e)return _arrayLikeToArray(e,n);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(e,n):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,n){(null==n||n>e.length)&&(n=e.length);for(var t=0,r=new Array(n);t<n;t++)r[t]=e[t];return r}!function(){function e(c,s,t,f,l,e,r){var n="user/{tenant}/users",d="user/currentUser",u=null,h={headers:f.contentHeaders("user",!0)},o={headers:f.contentHeaders("user",!0)};function p(e){var n=_.cloneDeep(e);return n.id&&delete n.userName,delete n.id,delete n.self,delete n.effectiveRoles,n}function g(e){var n=e.id||e;return i().then(function(e){return"".concat(e,"/").concat(encodeURIComponent(n))})}function i(){return y().then(function(e){return f.url(function(e,n){return e.replace(/\{tenant\}/g,n)}(n,e.tenant))})}function a(e){var n=e.match(/\/user\/([\w-]+)\//);if(n.length<2)throw new Error("Cannot find tenant on user self URL");return n[1]}function y(e){var n=d,t=_.cloneDeep(o);return e&&(u=null),u&&!_.isFunction(u.then)?s.when(u):u=u||c.get(f.url(n),t).then(function(e){return(u=e.data).tenant=a(u.self),u},function(){return u=null,s.reject()})}function v(e){var n=f.pageSizeFilter(e),t={params:n},r=f.cleanListCallback("users",v,n);return i().then(function(e){return c.get(e,t).then(r)})}function m(e,n){var t={silentError:n};return g(e).then(function(e){return c.get(e,t)})}function b(){var e=f.url(d),n=_.cloneDeep(o);return c.get(e,n)}function w(r,u){var o=u,i=p(r),n=_.cloneDeep(h),a=o?s.when(f.url(d)):g(r);return a.then(function(e){return c.put(e,i,n)}).then(function(e){var n=s.resolve(e),t=e.data;return!_.isUndefined(i.password)&&o&&(i.id=t.id,n=n.then(function(){return s.when(function(n){S(n).then(function(e){e&&l.updatePassword(function(e){return e.password||l.getPassword()}(n))})}(i))})),_.isUndefined(r.owner)||r.owner===t.owner||(n=n.then(null===r.owner?function(){return function(e){return g(e).then(function(e){return c.delete("".concat(e,"/owner"))}).then(function(){return m(e)})}(t)}:function(){return function(e,n){var t={owner:e.owner},r={"Content-Type":f.mimeType("userOwnerReference")};return n.then(function(e){return"".concat(e,"/owner")}).then(function(e){return c.put(e,t,{headers:r})})}(r,a)})),_.isUndefined(r.delegatedBy)||r.delegatedBy===t.delegatedBy||(n=n.then(null===r.delegatedBy?function(){return function(e){return g(e).then(function(e){return c.delete("".concat(e,"/delegatedby"))}).then(function(){return m(e)})}(t)}:function(){return function(e,n){var t={delegatedBy:e.delegatedBy},r={"Content-Type":f.mimeType("userDelegatedByReference")};return n.then(function(e){return"".concat(e,"/delegatedby")}).then(function(e){return c.put(e,t,{headers:r})})}(r,a)})),n=n.then(function(){return u?b():m(r)})}).then(function(e){return t.$emit("c8yUser:update",{user:e.data,res:e}),e})}function T(e,n){return e.id?w(e,n):function(e){var n=p(e),t=_.cloneDeep(h);return i().then(function(e){return c.post(e,n,t)})}(e)}function S(e){var n=e.id||e;return y().then(function(e){return s.when(e.id===n)})}function A(e){return _.get(e,"groups.references",[]).map(function(e){return e.group})}function U(e){var n=l.headers();return e&&(n.Authorization="Basic ".concat(e)),_.assign(n,f.contentHeaders("user",!0))}function O(){return s.when(!0)}function P(e,n){var t=n||a(e.self);return r.getTfaSettings(t)}function j(e,n){var t=_.some(A(e),function(e){return e.name===n.enforcedUsersGroup});return n.enforcedOnSystemLevel||n.totpEnforcedOnTenantLevel||t}function I(e){return"".concat(e,"/roles/inventory")}return t.$on("authStateChange",function(e,n){n.hasAuth||(u=null)}),{current:y,getCurrentUser:function(){return u},checkIfCurrent:S,listAll:function(e){var o=[];return v(_objectSpread({pageSize:f.MAX_PAGESIZE},e)).then(function e(n){o.push.apply(o,_toConsumableArray(n));var t=n.statistics.pageSize,r=n.paging.next,u=n.length>=t;return r&&u?n.paging.next().then(e):s.resolve(o)})},list:v,detail:m,detailCurrent:b,remove:function(e){return g(e).then(function(e){return c.delete(e)})},enable:function(e){return T({id:e.id||e,enabled:!0})},disable:function(e){return T({id:e.id||e,enabled:!1})},save:T,saveCurrent:function(e){return T(e,!0)},savePhoneNumber:function(e,n){var t=f.url("user/currentUserPhone"),r={headers:U(l.encodeToken(e.name,e.password,e.tenant)),method:"PUT",url:t,data:{phone:n},silentError:!0};return c(r)},groups:A,isDeviceUser:function(e){return e.id.match(/^device_/)},isServiceUser:function(e){var n;return(e.id||e).match(/^service_/)&&(n=!0),n},hasRole:function(e,n){var t=function(e,n){var t=!1,r=_.get(e,"roles.references");return r&&_.forEach(r,function(e){e.role.id===n&&(t=!0)}),t}(e,n);return t||(t=function(e,n){var t=!1,r=_.get(e,"groups.references");return r&&_.forEach(r,function(e){_.forEach(e.group.roles.references,function(e){e.role.id===n&&(t=!0)})}),t}(e,n)),t},getDevicePermissions:function(e,n){var t={params:f.pageSizeFilter({moId:n})};return g(e).then(function(e){return c.get("".concat(e,"/devicePermissions"),t)})},login:function(e,n,t,r){var u=l.encodeToken(n,t,e);return l.setAuthToken(u).then(function(){return l.saveAuthToken(r)})},logout:function(){return l.logout()},isAdmin:function(e){return _.some(e.groups.references,function(e){return"admins"===e.group.name})},isCurrentPassword:function(e){return l.getPassword()===e},isTfaAvailable:O,isTfaActive:function(t){return _.isUndefined(t.id)?O():s.when(t).then(function(e){var n=e.twoFactorAuthenticationEnabled;return P(t).then(function(e){return"TOTP"===e.strategy?n:!!j(t,e)||n})})},getTenantTfaSettings:P,isEnforcedForUser:j,getTfaStrategy:function(){return e.detailValue({category:"two-factor-authentication",key:"strategy"},"SMS")},getHeaders:U,activateSupportUser:function(){var e=f.url("tenant/support-user/enable");return c.put(e)},deactivateSupportUser:function(){var e=f.url("tenant/support-user/disable");return c.put(e)},delegateTo:function(e){var n={id:e.id};return y().then(function(e){return n.delegatedBy=e.id,w(n)})},setUserTfaSettings:function(e,t){var r={"content-type":"application/json"};return g(e.id||e.userName).then(function(e){var n=e+"/tfa";return c.put(n,t,{headers:r})})},getUserTfaSettings:function(e){return g(e).then(function(e){var n=e+"/tfa";return c.get(n)})},hasExternalOrigin:function(e){return e.customProperties&&"OAUTH2"===e.customProperties.userOrigin},listInventoryRoles:function(e){return(e?s.resolve(e):y()).then(g).then(I).then(function(e){return c.get(e)})},assignInventoryRoles:function(e,n,t){var r=e?s.resolve(e):y(),u={managedObject:n,roles:_.map(t,function(e){return _.pick(e,"id")})};return r.then(g).then(I).then(function(e){return c.post(e,u)})},updateInventoryRoles:function(e,n,t){var r=e?s.resolve(e):y(),u={roles:_.map(t,function(e){return _.pick(e,"id")})};return r.then(g).then(I).then(function(e){return c.put("".concat(e,"/").concat(n),u)})},removeInventoryRoles:function(e,n){return(e?s.resolve(e):y()).then(g).then(I).then(function(e){return c.delete("".concat(e,"/").concat(n))})}}}e.$inject=["$http","$q","$rootScope","c8yBase","c8yAuth","c8ySettings","c8yTfaSettings"],angular.module("c8y.core").factory("c8yUser",e)}();