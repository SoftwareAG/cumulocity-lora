"use strict";function _slicedToArray(e,n){return _arrayWithHoles(e)||_iterableToArrayLimit(e,n)||_unsupportedIterableToArray(e,n)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,n){if(e){if("string"==typeof e)return _arrayLikeToArray(e,n);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,n):void 0}}function _arrayLikeToArray(e,n){(null==n||n>e.length)&&(n=e.length);for(var r=0,t=new Array(n);r<n;r++)t[r]=e[r];return t}function _iterableToArrayLimit(e,n){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e)){var r=[],t=!0,u=!1,i=void 0;try{for(var o,a=e[Symbol.iterator]();!(t=(o=a.next()).done)&&(r.push(o.value),!n||r.length!==n);t=!0);}catch(e){u=!0,i=e}finally{try{t||null==a.return||a.return()}finally{if(u)throw i}}return r}}function _arrayWithHoles(e){if(Array.isArray(e))return e}!function(){function e(n,i,o,a,s,e,c,r){var l="user/devicePermissions",t=a.createEnum([{name:"ALARM",value:"ALARM",label:r("Alarms")},{name:"AUDIT",value:"AUDIT",label:r("Audits")},{name:"EVENT",value:"EVENT",label:r("Events")},{name:"MANAGED_OBJECT",value:"MANAGED_OBJECT",label:r("Inventory")},{name:"MEASUREMENT",value:"MEASUREMENT",label:r("Measurements")},{name:"OPERATION",value:"OPERATION",label:r("Device control")},{name:"SUPPORT",value:"SUPPORT",label:r("Support")},{name:"ALL",value:"*",label:r("Full access")}]),u=a.createEnum([{name:"READ",value:"READ",label:r("Read")},{name:"CHANGE",value:"ADMIN",label:r("Change")},{name:"ALL",value:"*",label:r("All")}]);function f(e,n){var r=function(e,n){var r=!1;e.roles&&e.roles.references&&_.forEach(e.roles.references,function(e){e.role.id===n&&(r=!0)});return r}(e,n);return r||(r=function(e,n){var r=!1;e.groups&&e.groups.references&&_.forEach(e.groups.references,function(e){_.forEach(e.group.roles.references,function(e){e.role.id===n&&(r=!0)})});return r}(e,n)),r}function p(e,n,r,t,u){var i=function(e,n,r,t,u){var i=!1;e.devicePermissions&&e.devicePermissions[n]&&(i=m(e.devicePermissions[n],r,t,u));return i}(e,n,r,t,u);return i||(i=function(e,n,r,t,u){var i=!1;e.groups&&e.groups.references&&_.forEach(e.groups.references,function(e){e.group.devicePermissions&&e.group.devicePermissions[n]&&(i=m(e.group.devicePermissions[n],r,t,u))});return i}(e,n,r,t,u)),i}function m(e,n,r,t){return _.some(e,_.partial(v,n,r,t))}function v(e,n,r,t){var u=!1,i=_slicedToArray(t.split(":"),3),o=i[0],a=i[1],s=i[2];return d(o,e)&&d(a,n)&&d(s,r)&&(u=!0),u}function d(e,n){return"*"===e||e===n}function h(n,e){return(e?i.when(e):s.current()).then(function(e){return _.some(n,_.partial(f,e))})}function y(n,e){return(e?i.when(e):s.current()).then(function(e){return _.every(n,_.partial(f,e))})}function A(e,n){return i.all(_.map(_.filter(e,_.identity),_.partialRight(E,n))).then(N)}function E(r,e){var t=r.id||r,n=!e;function u(e){return e||g(t,"read")}return(n?s.current():i.when(e)).then(function(e){return h(["ROLE_INVENTORY_READ"],e).then(function(n){return function(e){return e||p(n,t,"MANAGED_OBJECT","*","READ")}}(e)).then(function(n){return function(e){return e||c.isOwnerCached(r,n)}}(e)).then(n?u:_.identity)})}var g=_.memoize(function(e,n){var r=a.url("inventory/managedObjects/".concat(e)),t=R(n);return o({method:t,data:"PUT"===t?{}:void 0,headers:{"content-type":"application/json",accept:void 0},silentError:!0,url:r}).then(_.constant(!0),_.constant(!1))},function(e,n){return e+R(n)});function R(e){return"admin"===e?"PUT":"HEAD"}function O(e,n){return i.all(_.map(_.filter(e,_.identity),_.partialRight(b,n))).then(N)}function b(r,e){var t=r.id||r,n=!e;function u(e){return e||g(t,"admin")}return(n?s.current():i.when(e)).then(function(e){return h(["ROLE_INVENTORY_ADMIN"],e).then(function(n){return function(e){return e||p(n,t,"MANAGED_OBJECT","*","ADMIN")}}(e)).then(function(n){return function(e){return e||c.isOwnerCached(r,n)}}(e)).then(n?u:_.identity)})}function T(e,n){var r=[];return e.anyRole&&r.push(h(e.anyRole,n)),e.allRoles&&r.push(y(e.allRoles,n)),e.readMOs&&r.push(A(P(e.readMOs),n)),e.adminMOs&&r.push(O(P(e.adminMOs),n)),i.all(r).then(N)}function P(e){return _.filter(_.map(e,function(e){return function(e){return _.isString(e)&&/^:/.test(e)}(e)?function(e){return n[e.replace(/^:/,"")]}(e):e}),_.identity)}function M(e){return e.then(function(e){return e?i.when(e):i.reject(e)})}function N(e){return _.every(e)}function I(e,n){var r={groups:[],users:[]};return _.forEach(n.groups,_.partial(D,r,e)),_.forEach(n.users,_.partial(S,r,e)),r}function D(t,e,u){_.forEach(u.devicePermissions[e],function(e){var n=L(e),r={group:{id:u.id,name:u.name},scope:n.scope,type:n.type,access:n.access};t.groups.push(r)})}function S(t,e,u){_.forEach(u.devicePermissions[e],function(e){var n=L(e),r={username:u.userName,scope:n.scope,type:n.type,access:n.access};t.users.push(r)})}function L(e){var n=e.split(":");return{scope:n[0],type:n[1],access:n[2]}}function w(e){return[e.scope,e.type,e.access].join(":")}function C(e){return _.map(e,function(e){var n=e.id.split("_").filter(function(e,n,r){return!("ROLE"===e&&0===n&&1<r.length)}),r=1<n.length?n.pop():void 0,t=n.join("_");return{id:e.id,category:t,access:r}})}return{hasRole:f,hasDevicePermission:p,hasAnyRole:h,mustHaveAnyRole:function(e,n){return M(h(e,n))},hasAllRoles:y,mustHaveAllRoles:function(e,n){return M(y(e,n))},canReadMOs:A,mustHaveReadMOs:function(e,n){return M(A(e,n))},canAdminMOs:O,mustHaveAdminMOs:function(e,n){return M(O(e,n))},isAllowed:T,mustBeAllowed:function(e,n){return M(T(e,n))},getMOPermissions:function(e){var n=e.id||e,r=a.url("".concat(l,"/").concat(n));return _.isObjectLike(n)?i.when({groups:[],users:[]}):o.get(r).then(a.getResData).then(_.partial(I,n))},setMOPermissions:function(e,n){var r=e.id||e,t=a.url("".concat(l,"/").concat(r)),u=function(e,n){var r={groups:[],users:[]};return function(t,u,e){var n=_.groupBy(e,function(e){return e.group.id});_.forEach(n,function(e,n){var r={id:n,devicePermissions:{}};r.devicePermissions[u]=_.map(e,function(e){return w(e)}),t.push(r)})}(r.groups,e,n.groups),function(t,u,e){var n=_.groupBy(e,function(e){return e.userName});_.forEach(n,function(e,n){var r={userName:n,devicePermissions:{}};r.devicePermissions[u]=_.map(e,function(e){return w(e)}),t.push(r)})}(r.users,e,n.users),r}(r,n);return o.put(t,u)},getAccessTypes:function(){return["READ","ADMIN","*"]},convertServerPermissionsToUI:C,listGlobal:function(){return e.listRoles({pageSize:2e3}).then(C)},SCOPES:t,ACCESS_TYPES:u}}e.$inject=["$routeParams","$q","$http","c8yBase","c8yUser","c8yUserGroup","c8yInventory","gettext"],angular.module("c8y.core").factory("c8yPermissions",e)}();