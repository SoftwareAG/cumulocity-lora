"use strict";function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_unsupportedIterableToArray(t,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}function _iterableToArrayLimit(t,e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t)){var n=[],r=!0,o=!1,a=void 0;try{for(var i,u=t[Symbol.iterator]();!(r=(i=u.next()).done)&&(n.push(i.value),!e||n.length!==e);r=!0);}catch(t){o=!0,a=t}finally{try{r||null==u.return||u.return()}finally{if(o)throw a}}return n}}function _arrayWithHoles(t){if(Array.isArray(t))return t}!function(){function t(a,e,n,i,o,u,r,s){var c,l,p,f,h,d,g,y,v,m="_tcy8",k="_ocy8",w="TFAToken",T="Basic",A=i.defer(),S=i.defer(),I=/\.html$/,b=/\.json$/,F=document.createElement("a"),$={hasAuth:!1},P=s.appKey,L=T,C=T;function E(t){var e=t;t.startsWith(T)&&(e=t.replace(T,"").trim());var n=r(e).match(/(([^/]*)\/)?([^/:]+):(.+)/);return{tenant:n[2],user:n[3],password:n[4]}}function O(t,e,n){var r="".concat((n?"".concat(n,"/"):"")+t,":").concat(e);return u(r)}function U(t){return t.headers||(t.headers={}),_.defaults(t.headers,Y.headers()),t}function j(){return h.post(d.url("user/logout"),{},{silentError:!0}).then(function(t){return z(),t.data},function(){return z()})}function z(){x(),_.isFunction(s.logout)&&s.logout()}function R(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:T,n={token:e,type:function(t){return t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()}(t)},r=d.url("user/currentUser?auth");if(p=n.token,C=n.type,window.c8y_testing)return i.when(K(n));s.tokenType=t;var o={url:r,silentError:!0,skipInterceptor:!0,headers:{Authorization:n.token?"".concat(n.type," ").concat(n.token):void 0,tfatoken:f,UseXBasic:!0,Accept:"application/vnd.com.nsn.cumulocity.user+json;"}};return h(o).then(d.getResData).then(function(t){return e?function(t,e){var n=E(t.token);return t.token=O(function(t,e){var n=_slicedToArray(t.user.match(/^(.+\$)?(.+)?$/),3),r=n[1],o=n[2];return"".concat(r||"").concat(o?e.id:"")}(n,e),n.password,function(t){return t.self.match(/\/user\/([\w-]+)\//)[1]}(e)),t}(n,t):B()}).then(K)}function K(t){var e=t.token,n=t.type;s.token=e,c=s.token,L=n,X(s.appKey);var r=!P?g.currentAppCached().then(function(t){s.appConfig=_.defaults(s.appConfig||{},t),X(t.key)}):i.when();return function(){o.sessionStorage&&o.sessionStorage.setItem(m,c);o.localStorage.getItem(m)&&o.localStorage.setItem(m,c)}(),r.then(B)}function B(){A.resolve(),t({hasAuth:!0})}function t(t){_.isEqual(t,$)||($=t,e.$emit("authStateChange",$))}function W(){f=void 0,delete s.TFAToken,D()}function q(t){s.TFAToken=t,G(f=s.TFAToken,!1,w),function(t,e){return n.get("c8ySettings").getSystemOptionValue({category:t,key:e},!1)}("two-factor-authentication","logout-on-browser-termination").then(function(t){G(f,!t,w)})}function x(){W(),delete s.token,A.promise.$$state.status&&(A=i.defer()),t({hasAuth:!1}),M()}function G(t,e,n){o["".concat(e?"local":"session","Storage")].setItem(n,t)}function H(t){return o.localStorage.getItem(t)||o.sessionStorage.getItem(t)||void 0}function X(t){s.appKey=t,P=s.appKey}function M(){o.localStorage.removeItem(m),o.sessionStorage.removeItem(m),o.localStorage.removeItem(k),o.sessionStorage.removeItem(k)}function D(){o.localStorage.removeItem(w),o.sessionStorage.removeItem(w)}function V(){var t=s.token||H(m),e=s.TFAToken||H(w),n=s.tokenType||H(k);return X(s.appKey),e&&q(e),R(t,n).catch(M)}function J(t){l=t}function N(t){var e=t.headers("tfatoken");return e&&q(e),R(p,C)}function Q(t){var e=_.map(t,function(n){var t={};return t[n.prop]=!1,h({url:d.url("tenant/".concat(n.path)),silentError:!0}).then(function(t){var e={};return e[n.prop]=n.checkFn(t),e}).catch(function(){return t})});return i.all(e).then(function(t){return _.reduce(t,function(t,e){return _.assign(t,e)},{})})}S.resolve(),J(s.passResetToken||function(){if(a.search)return a.search();return{}}().token);var Y={decodeToken:E,encodeToken:O,logout:j,updatePassword:function(t){var e=E(c);return K({token:O(e.user,t,e.tenant),type:s.tokenType||T})},request:function(t){var e,n=t.url,r=function(t){var e=s.baseUrl||"/";if(!t)return!0;F.href=t||"";var n=F.host;return 1<e.length&&-1<t.indexOf(e)||!n||n===function(){var t=a.host(),e=a.port();return 80!==e&&443!==e?[t,e].join(":"):t}()}(n);if(!r||I.test(n)||b.test(n)||t.skipInterceptor)return t;e=r&&!function(t){return!(!t.headers||!t.headers.Authorization)}(t)&&function(t){return!c||!t.noAppKey}(t)?Y.initializing.done?A.promise:i.all([Y.initializing,A.promise]):S.promise;var o=r?_.partial(U,t):function(){return t};return c&&window.c8y_testing?o():e.then(o)},responseError:function(t){_.isFunction(t.headers)&&t.headers("tfatokenexpired")&&$.hasAuth&&j();var e=Boolean(s.token);return 401!==t.status||e||function(){var t=d.url("user/currentUser");return h.get(t,{headers:d.contentHeaders("user",!0),silentError:!0}).then(function(){return!0},function(t){return 401!==t.status})}().then(function(t){t||j()}),i.reject(t)},setAuthToken:R,clearTokens:x,setTFAToken:q,clearTFAToken:W,saveAuthToken:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:T;G(c,t,m),G(e,t,k)},checkSavedTokens:V,setAppKey:X,headers:function(){var t={Authorization:c?"".concat(L," ").concat(c):void 0,tfatoken:f,UseXBasic:!0};return t["X-Cumulocity-Application-Key"]=P,t},resetPasword:function(t){var e={method:"POST",url:d.url("user/passwordReset"),params:{tenantId:t.tenant},data:{email:t.email},silentError:!0};return h(e)},changePasswordWithResetToken:function(t){var e={method:"PUT",url:d.url("user/passwordReset"),params:{tenantId:t.tenant},data:{email:t.email,token:l,newPassword:t.newPassword,passwordStrength:(t.passwordStrength||"").toUpperCase()},silentError:!0};return h(e).then(function(t){return l=void 0,a.url(a.path()),t})},setRecoverPassToken:J,verifyTFACode:function(t){D();var e={url:d.url("user/pin"),data:{pin:t},method:"POST",silentError:!0,headers:{Authorization:"".concat(C||T," ").concat(p),"Content-Type":"application/vnd.com.nsn.cumulocity.user+json;"}};return h(e).then(N)},getPassword:function(){return c&&E(c).password},getUserFromToken:function(){return E(c).user},getTenantFromToken:function(){return E(c).tenant},mustEnforcePasswordStrength:function(t){return Q([{path:"system/options/password/enforce.strength",prop:"systemLevel",checkFn:function(t){return"true"===(t.data||{}).value}},{path:"security-options/password/strength.validity",prop:"tenantLevel",checkFn:function(t){return"true"===(t.data||{}).value}}]).then(function(t){return t.systemLevel||t.tenantLevel})},getPasswordMinGreenLength:function(t){return Q([{path:"system/options/password/green.min-length",prop:"minGreenLength",checkFn:function(t){return _.parseInt((t.data||{}).value)}}]).then(function(t){return t.minGreenLength})},onSetToken:K,authReady:B,isSupportUser:function(){var t=E(p);return(t?t.user:"").includes("$")},getLoginOptions:function(){return y},whenAuthorized:function(){return A.promise}};return Y.initializing=i.resolve().then(function(){h=n.get("$http"),d=n.get("c8yBase"),g=n.get("c8yApplication")}).then(window.preventInit?function(){}:function(){if(window.c8y_testing)return i.when();var t=[{type:(v=n.get("c8yLoginOptions",[h,d])).loginOptions.BASIC.value}];return v.list({skipInterceptor:!0,params:{tenantId:d.getParamFromUrl("tenantId",window.location.search)}}).then(function(t){y=t.data.loginOptions},function(){y=t})}).then(function(){return window.c8y_testing?(K({token:s.token,type:s.tokenType||T}),{testing:!0}):s.oauthCode?function(t){M();var e={silentError:!1,url:d.url("tenant/oauth"+"?grant_type=authorization_code".concat(_.get(d.appOption("oauth"),"uriAddition",""))+"&code=".concat(t)),method:"POST",skipInterceptor:!0};return h(e).then(B)}(s.oauthCode):l?(a.search("token",l),x(),{recoverPassword:!0}):s.noSavedTokens?{noSavedTokens:!0}:V()}).finally(function(){Y.initializing.done=!0}),window.c8y_testing&&(o.localStorage||(o.localStorage=window.localStorage),o.sessionStorage||(o.sessionStorage=window.sessionStorage)),Y}t.$inject=["$location","$rootScope","$injector","$q","$window","utoa","atou","info"],angular.module("c8y.core").factory("c8yAuth",t).config(["$httpProvider",function(t){t.interceptors.push("c8yAuth")}])}();