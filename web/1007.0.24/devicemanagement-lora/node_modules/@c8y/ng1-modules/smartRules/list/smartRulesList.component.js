"use strict";!function(){function e(e,i,o,t,n,r,a,c,s,u,l,d,f,h){var m=this,v={},g={},p={done:!1,inProgress:!1},A={true:{text:f("Active`rule`"),icon:"check-circle",cls:"text-success"},false:{text:f("Inactive`rule`"),icon:"ban",cls:"text-warning"}};function R(){return o.when().then(S).then(y).then(C).then(P).then(E).catch(b)}function S(){p.inProgress=!0}function E(){p.inProgress=!1,p.done=!0,p.error=!1}function b(e){e.data&&e.data.message&&c.danger(e.data.message),p.inProgress=!1,p.done=!0,p.error=!0}function y(){return l.list().then(I)}function I(e){_.forEach(e,function(e){v[e.name]=e})}function C(){var e=m.mo?d.listByContext(m.mo):o.resolve([]),t=u.hasPermissions().then(function(e){return e?d.list():o.when([])});return o.all({listByContext:e,list:t}).then(function(e){m.rules=function(e){var t=e;m.mo&&(t=_.reject(t,function(e){var n=new RegExp("".concat(e,"/dashboard"));return function(e){var t=_.get(e,"config.url","");return x(e)&&!n.test(t)}}(m.mo)));m.filter&&(t=_.filter(t,m.filter));return t}(_.concat(e.listByContext,e.list)),"function"==typeof m.onRules&&m.onRules()(m.rules)})}function x(e){return"sendDashboardsViaEmail"===e.ruleTemplateName}function N(e){return d.hasSource(e,m.mo)}function P(){return Array.isArray(m.rules)&&0<m.rules.length?function(){var e=s.getContext(),t=function(e){var t=e.id;return m.mo?_.get(m,"mo.id")||m.mo:t}(e);return null!==e.context?n.childAssets(t,{skipDetail:!0,params:{pageSize:2e3,withChildren:!1}}).then(function(e){m.children=e}).then(function(){m.ruleChildren={},_.forEach(m.rules,function(e){m.ruleChildren[e.id]=M(e)})}):o.resolve()}():o.resolve()}function M(t){return _.filter(m.children,function(e){return t.enabled&&d.hasSource(t,e)})}_.assign(m,{ruleTemplates:v,loadingStatus:p,isOpen:{},listClass:"interact-list",$onInit:function(){e.$on("smartRulesListReload",R),R()},add:function(){d.addNewWithUI().then(R)},edit:function(e){d.editWithUI(e).then(R)},clone:function(e){d.cloneWithUI(e).then(R)},remove:function(e){t({title:f("Delete smart rule"),body:h.getString('You are about to delete smart rule "{{name}}". Do you want to proceed?',e),status:"danger",labels:{ok:f("Delete")}}).then(d.remove.bind(d,e)).then(_.partial(_.pull,m.rules,e)).then(_.partial(_.unary(c.success),f("Smart rule deleted.")))},hasSource:N,getChildrenEnabledForSmartRule:M,toggleRuleActivationForContextMO:function(e){if(e.enabled&&N(e))return d.deactivate(e,m.mo,!1).then(function(){c.success(h.getString('Smart rule "{{name}}" deactivated.',e))});return d.activate(e,m.mo,!1).then(function(){c.success(h.getString('Smart rule "{{name}}" activated.',e))})},toggleRuleActivationForChildrenMOs:function(t,n){var r=[];return _.forEach(n,function(e){!_.find(m.ruleChildren[t.id],{id:e.id})&&r.push(d.activate(t,e,!1))}),_.forEach(m.ruleChildren[t.id],function(e){!_.find(n,{id:e.id})&&r.push(d.deactivate(t,e,!1))}),o.all(r).then(C).then(P).then(function(){c.success(h.getString('Smart rule "{{name}}" activated/deactivated for children.',t))})},tooltip:function(e){var t,n={activate:{"for group":f("Activate for this group."),"for device":f("Activate for this device."),"for object":f("Activate for this object.")},deactivate:{"for group":f("Deactivate for this group."),"for device":f("Deactivate for this device."),"for object":f("Deactivate for this object.")}},r=e.enabled&&N(e)?"deactivate":"activate";t=i.deviceId?"device":i.groupId?"group":"object";return n[r]["for ".concat(t)]},type:function(e){var t,n=v[e.ruleTemplateName];n&&(t="".concat(h.getString(n.label.input)," ").concat(h.getString(n.label.output)));return t},status:function(e){return A[e.enabled].text},statusIcon:function(e){return A[e.enabled].icon},statusClass:function(e){return A[e.enabled].cls},context:s.getContext(),inputIcon:function(e){var t,n=v[e.ruleTemplateName];n&&(t=n.paramGroups.input.icon);return t},outputIcon:function(e){var t,n=v[e.ruleTemplateName];n&&(t=n.paramGroups.output.icon);return t},canAddRules:function(){var e=g.canAddRules;if(_.isUndefined(e)){var t;t=m.context?{adminMOs:[m.context.id]}:{allRoles:["ROLE_INVENTORY_ADMIN"],anyRole:["ROLE_SMARTRULE_ADMIN","ROLE_CEP_MANAGEMENT_ADMIN"]},g.canAddRules=a.isAllowed(t).then(function(e){return g.canAddRules=e,g.canAddRules}),e=!1}return e},canModify:function(t){g.rules=g.rules||{};var n=g.rules,e=n[t.id];_.isUndefined(e)&&(n[t.id]=a.isAllowed({adminMOs:[t.id]}).then(function(e){return n[t.id]=e,n[t.id]}),e=!1);return e},canInspect:function(){var e=g.canInspect;_.isUndefined(e)&&(g.canInspect=o.all({administrationAccess:r.listByUser().then(function(e){return!!_.find(e,{contextPath:"administration"})}),eventProcessingAccess:a.isAllowed({anyRole:["ROLE_CEP_MANAGEMENT_READ","ROLE_CEP_MANAGEMENT_ADMIN"]}),eventProcessingEnabled:d.eventProcessingEnabled()}).then(function(e){return g.canInspect=e.administrationAccess&&e.eventProcessingAccess&&e.eventProcessingEnabled,g.canInspect}),e=!1);return e},canApplyOnChildren:function(e){return!x(e)},canSeeSection:function(){var e=g.canSeeSection;_.isUndefined(e)&&(g.canSeeSection=u.shouldShowLocalSmartRules().then(function(e){return g.canSeeSection=e,g.canSeeSection}),e=!1);return e}}),_.assign(e,{refresh:R,paging:{refresh:R}})}e.$inject=["$scope","$routeParams","$q","c8yModal","c8yInventory","c8yApplication","c8yPermissions","c8yAlert","c8yUiUtil","c8ySmartRulesAvailability","smartRuleTemplatesSvc","smartRulesSvc","gettext","gettextCatalog"],angular.module("c8y.smartRules").component("smartRulesList",{bindings:{mo:"<?",filter:"<?",disableEditAndCreate:"<?",onRules:"&"},templateUrl:":::PLUGIN_PATH:::/list/smartRulesList.html",controller:e,controllerAs:"vm"})}();