"use strict";function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}!function(){function e(m,i,l,e,t,u,c,o,s,d,p,h,f,n,g,y,a){var r=["ROLE_INVENTORY_READ","ROLE_INVENTORY_ADMIN","ROLE_SIMULATOR_ADMIN","ROLE_SMARTRULE_READ","ROLE_SMARTRULE_ADMIN"],v=1,b=3,T=3,S="c8y_DemoStatus",A=[{type:"c8y_Temperature",series:"T",unit:"°C",normalValuesRange:{min:0,max:100},errorValuesRange:{min:100,max:125}}],R=[{name:y.getString("On high temperature raise alarms"),ruleTemplateName:"thresholdSmartRule",kpi:{yellowRangeMin:80,yellowRangeMax:100,redRangeMin:100,redRangeMax:125},config:{fragment:"c8y_Temperature",series:"T",alarmType:"c8y_HighTemperature",alarmText:y.getString("Temperature is higher than expected.")}},{name:y.getString("On very high temperature raise alarms"),ruleTemplateName:"explicitThresholdSmartRule",config:{fragment:"c8y_Temperature",series:"T",alarmType:"c8y_VeryHighTemperature",alarmText:y.getString("Temperature is much higher than expected."),explicitVariant:!0,redRangeMin:100,redRangeMax:125}},{name:y.getString("On very high temperature send email"),ruleTemplateName:"onAlarmSendEmail",config:{alarmType:"c8y_VeryHighTemperature",subject:y.getString("Very high temperature detected."),text:y.getString("Temperature on device #{source.name} (id: #{source.id}) is much higher than expected.")}},{name:y.getString("On very high temperature send SMS"),ruleTemplateName:"onAlarmSendSms",config:{alarmType:"c8y_VeryHighTemperature",text:y.getString("Caution! Temperature on device #{source.name} (ID: #{source.id}) is much higher than expected.")}}];return{checkPermissions:function(){return e.mustHaveAllRoles(r).then(_.constant(!0),_.constant(!1))},getDemoStatus:M,saveDemoStatus:function(e){return u.save(e)},getDemoObjectsList:function(){return M().then(function(e){return m.all(_.flatten([_.map(e.siteGroups,D),_.map(e.buildingGroups,D),_.map(e.simulators,x),_.map(e.devices,k),_.map(e.dashboards,N),_.map(e.binaries,C),_.map(e.kpis,P),_.map(e.smartRules,w),e])).then(_.flatten).then(_.compact).catch(console.error)})},setup:function(e){var t={siteGroups:[],buildingGroups:[],simulators:[],devices:[],dashboards:[],binaries:[],kpis:[],smartRules:[]},n=[function(t){return{label:y.getPlural(v,"Create top level Site group","Create top level Site groups",{}),execute:function(){return function(){var n=[];return _.reduce(_.range(v).map(function(e){return y.getString("Site {{number}}",{number:e+1})}),function(e,t){return e.then(function(){return function(e){return c.create({name:e}).then(l.getResData)}(t).then(function(e){n.push(e)})})},m.resolve()).then(_.constant(n))}().then(function(e){t.siteGroups=e})}}}(t),function(t){return{label:y.getPlural(b,"Create Building subgroup","Create Building subgroups",{}),execute:function(){return function(e){var n=[];return _.reduce(e,function(e,t){return e.then(function(){return function(n){var r=[];return _.reduce(_.range(b).map(function(e){return y.getString("Building {{number}}",{number:e+1})}),function(e,t){return e.then(function(){return function(e){return c.createSubgroup({name:e}).then(l.getResData)}(t).then(function(e){return r.push(e),u.addChildAsset(n,e)})})},m.resolve()).then(_.constant(r))}(t).then(function(e){n.push(e)})})},m.resolve()).then(function(){return _.flatten(n)})}(t.siteGroups).then(function(e){t.buildingGroups=e})}}}(t),function(t){return{label:g("Create simulated devices"),execute:function(){return function(e){var n=[],r=[];return _.reduce(e,function(e,t){return e.then(function(){return function(n){var r=[],t=[];return _.reduce(_.range(T).map(function(e){return y.getString("Simulator {{number}}",{number:e+1})}),function(e,t){return e.then(function(){return o.create(function(e){return{name:e,instances:1,state:"PAUSED",commandQueue:function(e){var t=[],n=function(e){return{type:"builtin",messageId:"110",values:["","c8y_DemoDevice",e]}}(e),r=_.map(A,E);t.push(n);for(var a=0;a<_.max(_.map(r,"length"));a++)t.push(_.map(r,_.property(a))),t.push({type:"sleep",seconds:5});return _.compact(_.flattenDeep(t))}(e)}}(t)).then(function(e){return r.push(e),e}).then(o.run)})},m.resolve()).then(function(){var e=m.defer();return i(e.resolve,5e3),e.promise}).then(function(){return s.listQuery({__filter:{"c8y_Hardware.model":{__eq:"c8y_DemoDevice"}}},{withParents:!0})}).then(function(e){return _.filter(e,function(e){return 0===e.assetParents.references.length})}).then(function(e){t=e}).then(function(){return _.reduce(t,function(e,t){return e.then(function(){return u.addChildAsset(n,t)}).then(function(){return u.save({id:t.id,type:t.c8y_Hardware.model,name:y.getString("Pump {{number}}",{number:t.c8y_Hardware.revision.match(/\d+/)[0]})})})},m.resolve())}).then(function(){return{simulators:_.flatten(r),devices:_.flatten(t)}})}(t).then(function(e){n.push(e.simulators),r.push(e.devices)})})},m.resolve()).then(function(){return{simulators:_.flatten(n),devices:_.flatten(r)}})}(t.buildingGroups).then(function(e){t.simulators=e.simulators,t.devices=e.devices})}}}(t),function(n){return{label:y.getString("Add Overview dashboards for buildings"),execute:function(){return L("building-test.svg").then(d.upload).then(l.getResData).then(function(e){return n.binaries.push(e),function(e,n){var r=[];return _.reduce(e.buildingGroups,function(e,t){return e.then(function(){return function(t,e){var n,r={},a={name:g("Overview"),icon:"bookmark",global:!0,priority:1e4,creationContext:t,children:r};return function(t,n){return u.childAssets(t).then(function(e){return{id:"scada",name:"SCADA",title:"SCADA",config:{device:{name:t.name,id:t.id},deviceIds:{device1Id:e[0].id,device1Name:e[0].id,device1AlarmStatus:e[0].id,device1Measurement:e[0].id,device2Id:e[1].id,device2Name:e[1].id,device2AlarmStatus:e[1].id,device2Measurement:e[1].id,device3Id:e[2].id,device3Name:e[2].id,device3AlarmStatus:e[2].id,device3Measurement:e[2].id},binaryId:n.id,mapping:{device1Id:{id:"c8ySchema!!id",label:"Id",type:"string",keyPath:["id"]},device1Name:{id:"c8ySchema!!name",label:"Name",type:"string",keyPath:["name"]},device1AlarmStatus:{id:"c8ySchema!!c8y_ActiveAlarmsStatus",label:"Active alarms status",type:"object",printFormat:"hidden",keyPath:["c8y_ActiveAlarmsStatus"]},device1Measurement:{id:"c8ySchema!!lastMeasurement",label:"Last measurement",type:"string",computed:!0,configSchema:!0,keyPath:["lastMeasurement_14130876143351778"],config:{_id:"14130876143351778",dp:[{_id:"26840184072968243",label:"c8y_Temperature => T",fragment:"c8y_Temperature",series:"T",unit:"°C",color:"#124257",lineType:"line",renderType:"min",__active:!0,__target:{name:"demoName",id:"demoId"}}],resultType:2}},device2Id:{id:"c8ySchema!!id",label:"Id",type:"string",keyPath:["id"]},device2Name:{id:"c8ySchema!!name",label:"Name",type:"string",keyPath:["name"]},device2AlarmStatus:{id:"c8ySchema!!c8y_ActiveAlarmsStatus",label:"Active alarms status",type:"object",printFormat:"hidden",keyPath:["c8y_ActiveAlarmsStatus"]},device2Measurement:{id:"c8ySchema!!lastMeasurement",label:"Last measurement",type:"string",computed:!0,configSchema:!0,keyPath:["lastMeasurement_14130876143351778"],config:{_id:"14130876143351778",dp:[{_id:"26840184072968243",label:"c8y_Temperature => T",fragment:"c8y_Temperature",series:"T",unit:"°C",color:"#124257",lineType:"line",renderType:"min",__active:!0,__target:{name:"demoName",id:"demoId"}}],resultType:2}},device3Id:{id:"c8ySchema!!id",label:"Id",type:"string",keyPath:["id"]},device3Name:{id:"c8ySchema!!name",label:"Name",type:"string",keyPath:["name"]},device3AlarmStatus:{id:"c8ySchema!!c8y_ActiveAlarmsStatus",label:"Active alarms status",type:"object",printFormat:"hidden",keyPath:["c8y_ActiveAlarmsStatus"]},device3Measurement:{id:"c8ySchema!!lastMeasurement",label:"Last measurement",type:"string",computed:!0,configSchema:!0,keyPath:["lastMeasurement_14130876143351778"],config:{_id:"14130876143351778",dp:[{_id:"26840184072968243",label:"c8y_Temperature => T",fragment:"c8y_Temperature",series:"T",unit:"°C",color:"#124257",lineType:"line",renderType:"min",__active:!0,__target:{name:"demoName",id:"demoId"}}],resultType:2}}}},_x:0,_y:0,_width:12,_height:10}})}(t,e).then(function(e){return r[e.id]=e,p.save(a).then(function(e){return n=e,p.groupAdd(t,e)}).then(function(){return n})})}(t,n).then(function(e){r.push(e)})})},m.resolve()).then(_.constant(r))}(n,e)}).then(function(e){var t;(t=n.dashboards).push.apply(t,_toConsumableArray(e))}).catch(console.error)}}}(t),function(t){return{label:y.getString("Add Overview dashboards for simulated devices"),execute:function(){return L("pump-test.svg").then(d.upload).then(l.getResData).then(function(e){return t.binaries.push(e),function(e){var t={},n={c8y_Global:{},"c8y_Dashboard!type!c8y_DemoDevice":{},c8y_Dashboard:{global:!0,deviceType:!0,deviceTypeValue:"c8y_DemoDevice",icon:"bookmark",name:g("Overview"),priority:1e4,children:t}},r=[function(e){return{id:"scada",name:"SCADA",title:"SCADA",config:{binaryId:e.id,mapping:{name:{id:"c8ySchema!!name",label:"Name",type:"string",keyPath:["name"]},alarmStatus:{id:"c8ySchema!!c8y_ActiveAlarmsStatus",label:"Active alarms status",type:"object",printFormat:"hidden",keyPath:["c8y_ActiveAlarmsStatus"]},measurementIn:V("c8y_Temperature","T","°C"),measurementOut:V("c8y_Temperature","T","°C"),measurementBelow:V("c8y_Temperature","T","°C")}},_x:0,_y:0,_width:5,_height:5}}(e),{id:"alarmsList",name:"Alarm list",title:g("Active alarms"),translateTitle:!0,config:{options:{orderMode:"ACTIVE_FIRST",severity:{CRITICAL:!0,MAJOR:!0,MINOR:!0,WARNING:!0},status:{ACTIVE:!0,ACKNOWLEDGED:!1,CLEARED:!1},types:[]}},_x:9,_y:0,_width:3,_height:5},{id:"dataPointsGraph",name:"Data points graph",title:g("Measurements"),translateTitle:!0,config:{interval:"hours",aggregation:"NONE",realtime:!0,datapoints:[{fragment:"c8y_Temperature",series:"T",label:y.getString("Temperature"),unit:"°C",renderType:"min",lineType:"line",color:"#5e07b3",__active:!0}],alarmsEventsConfigs:[{label:"c8y_VeryHighTemperature",timelineType:"ALARM",color:"#6f6cd0",filters:{type:"c8y_VeryHighTemperature"},__active:!0},{label:"c8y_HighTemperature",timelineType:"ALARM",color:"#375bf2",filters:{type:"c8y_HighTemperature"},__active:!0}]},_x:0,_y:5,_width:12,_height:5},{id:"radialGauge",name:"KPI Radial Gauge",title:g("Radial gauge"),translateTitle:!0,config:{kpi:{label:"Temperature",fragment:"c8y_Temperature",series:"T",min:0,max:125,yellowRangeMin:80,yellowRangeMax:100,redRangeMin:100,redRangeMax:125}},_x:5,_y:0,_width:4,_height:5}];return _.each(r,function(e){t[e.id]=e}),n}(e)}).then(u.create).then(l.getResData).then(function(e){t.dashboards.push(e)})}}}(t),function(t,e){return{label:g("Configure smart rules"),execute:function(){return function(e,c){var o=[],s=[];return _.reduce(e,function(e,u){return e.then(function(){return m.all(_.map(R,function(e){var t=e.ruleTemplateName,n=function(e){return{mo:e,withChildren:{assets:!0,devices:!1}}}(u),r=f.getEmpty({context:"group",id:u.id});r.name=e.name,r.config=e.config,"onAlarmSendEmail"===t&&(r.config.to=c.email),"onAlarmSendSms"===t&&(r.config.to=c.phone);var a=m.resolve(r);if("thresholdSmartRule"===t){var i={c8y_Kpi:{label:y.getString("Data point: {{config.fragment}} => {{config.series}}",e),fragment:e.config.fragment,series:e.config.series,yellowRangeMin:e.kpi.yellowRangeMin,yellowRangeMax:e.kpi.yellowRangeMax,redRangeMin:e.kpi.redRangeMin,redRangeMax:e.kpi.redRangeMax}};a=a.then(function(){return h.save(i)}).then(l.getResData).then(function(e){return r.config.kpiId=e.id,o.push(e),r})}return a.then(_.partial(G,e)).then(function(e){return f.save(r,e,n)}).then(function(e){s.push(e)})}))})},m.resolve()).then(function(){return{kpis:o,rules:s}})}(t.buildingGroups,e).then(function(e){t.kpis=e.kpis,t.smartRules=e.rules})}}}(t,e)],r=_.reduce(n,function(e,t){return e.then(function(){return t.execute.apply(t)}).then(function(){t.completed=!0})},m.resolve()).then(function(){return function(e){return u.create(I(e))}(t)}).then(function(){a.success=!0}).catch(function(e){a.failed=!0,a.errorMessage=e,j(I(t))}).finally(function(){a.inProgress=!1}),a={inProgress:!0,success:!1,failed:!1,demoObjects:t,steps:n,completed:r};return a},replaceMeasurementValues:function(e,i,u,t){var n=_.find(A,{type:i,series:u}),c=O(n,n[t]);return o.detail(e).then(function(e){var a=0;return _.each(e.commandQueue,function(e){var t=200===_.toNumber(_.get(e,"messageId")),n=_.get(e,"values[0]")===i,r=_.get(e,"values[1]")===u;t&&n&&r&&(_.assign(e,c[a%c.length]),a++)}),o.save(e)}).then(o.pause).then(o.run).then(function(){return U(e)}).catch(console.error)},increaseMeasurementValues:function(e,a,i,u){return o.detail(e).then(function(e){return _.each(e.commandQueue,function(e){var t=200===_.toNumber(_.get(e,"messageId")),n=_.get(e,"values[0]")===a,r=_.get(e,"values[1]")===i;t&&n&&r&&(e.values[2]=_.toNumber(e.values[2])+u)}),o.save(e)}).then(o.pause).then(o.run).then(function(){return U(e)}).catch(console.error)},cleanUp:function(){return M().then(j).then(u.remove)}};function M(){return u.list({type:S}).then(_.first)}function I(e){return{type:S,siteGroups:_.map(e.siteGroups,"id"),buildingGroups:_.map(e.buildingGroups,"id"),simulators:_.map(e.simulators,"id"),devices:_.map(e.devices,"id"),dashboards:_.map(e.dashboards,"id"),binaries:_.map(e.binaries,"id"),kpis:_.map(e.kpis,"id"),smartRules:_.map(e.smartRules,"id")}}function D(e){return c.detail(e,{},{silentError:!0}).then(l.getResData,_.constant())}function x(e){return o.detail(e)}function k(e){return s.detail(e).then(l.getResData)}function N(e){return u.detail(e).then(l.getResData)}function C(e){return d.detail(e).then(l.getResData)}function P(e){return h.detail(e).then(l.getResData)}function w(e){return f.detail(e)}function E(e){return O(e,e.normalValuesRange)}function O(t,n){var e=_.random(0,2*Math.PI),r=_.range(e,2*Math.PI+e,.1).map(function(e){return(Math.sin(e)+1)/2}).map(function(e){return Math.floor(e*(n.max-n.min)+n.min)});return _.map(r,function(e){return{type:"builtin",messageId:"200",values:[t.type,t.series,e,t.unit]}})}function G(e){return n.getTemplateByName(e.ruleTemplateName)}function L(t,e){var n=m.defer(),r=new XMLHttpRequest,a=":::PLUGIN_PATH:::/resources/".concat(t),i=e||"image/svg";return r.open("GET",a,!0),_.assign(r,{responseType:"arraybuffer",onload:function(){if(200===r.status){var e=new Blob([r.response],{type:i});e.name=t,n.resolve(e)}else n.reject(r)}}),r.send(),n.promise}function V(e,t,n){var r=H();return{id:"c8ySchema!!lastMeasurement",label:"Last measurement",type:"string",computed:!0,configSchema:!0,keyPath:["lastMeasurement_".concat(r)],config:{_id:r,dp:[{_id:H(),label:"".concat(e," => ").concat(t),fragment:e,series:t,unit:n,color:a.generateColor(),lineType:"line",renderType:"min",__active:!0,__target:{name:"demoName",id:"demoId"}}],resultType:2}}}function H(){return String(Math.random()).substr(2)}function j(e){return m.resolve(e).then(function(e){return B(e,e.kpis,h.remove)}).then(function(e){return B(e,e.smartRules,function(e){return f.detail(e).then(function(e){return _.unset(e,"c8y_Context"),e}).then(f.remove)})}).then(function(e){return B(e,e.binaries,d.removeBinary)}).then(function(e){return B(e,e.dashboards,u.remove)}).then(function(e){return B(e,e.devices,s.remove)}).then(function(e){return B(e,e.simulators,o.remove)}).then(function(e){return B(e,e.buildingGroups,u.remove)}).then(function(e){return B(e,e.siteGroups,u.remove)})}function B(e,t,n){return _.reduce(t,function(e,t){return e.then(function(){return n(t)})},m.resolve()).then(_.constant(e))}function U(e){return t.getExternalId({type:"c8y_Serial",externalId:"simulator_".concat(e,"_0")}).then(l.getResData).then(_.property("managedObject")).then(s.detail).then(l.getResData)}}e.$inject=["$q","$timeout","c8yBase","c8yPermissions","c8yIdentity","c8yInventory","c8yDeviceGroup","c8ySimulators","c8yDevices","c8yBinary","dashboardSvc","c8yKpi","smartRulesSvc","smartRuleTemplatesSvc","gettext","gettextCatalog","c8yUiUtil"],angular.module("c8y.demo").factory("c8yDemo",e)}();