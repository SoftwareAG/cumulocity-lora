"use strict";!function(){function e(i,e,n,o,u,c,a,t,r,s,f,E,d,l,g){var h=this;_.assign(h,{cancel:f.gotoList});var p,R,w,U,T,m=e.userId,A=["business"];function N(){m?u.detail(m).then(function(e){return e.data}).then(v).then(function(){return u.getUserTfaSettings(i.user).then(o.getResData).then(function(e){i.userTfaEnforced=!!e.tfaEnforced})}):(v({enabled:i.isNew=!0}),S(g("New user")))}function v(e){R=e.email,e.devicePermissions=e.devicePermissions||{},i.user=e,i._groups=y(e),i.password.showPassword=i.isNew,i.hasExternalOrigin=u.hasExternalOrigin(e),i.hasExternalOrigin&&a.warning(f.EXTERNAL_ORIGIN_TEXT),i.isNew&&(_.forEach(i.groups,function(e){_.includes(A,e.name)&&(i._groups[e.id]=!0)}),U&&a.warning(f.LOCAL_USER_TEXT))}function y(e){return _.reduce(_.get(e,"groups.references"),function(e,n){return e[n.group.id]=!0,e},{})}function L(e){i.groups=e}function G(e){i.currentUser=e,w=e}function O(e){e?M(i.user):N()}function M(n){i.saving=!0;var e=f.gotoList,t=!(n.id&&!n.groups),r=_(i._groups).map(function(e,n){return e&&parseInt(n,10)}).filter().value(),s=t?_.partialRight(c.updateGroups,r):_.identity;try{u.current().then(function(e){return _.isEqual(e.userName,n.userName)}).then(function(e){return l.isActivatedFor("units-conversion")&&(e&&function(e){var n=_.get(e,"measurementUnit.value");E.set("unit",n)}(n),_.unset(n,"measurementUnit")),e}).then(function(e){return u.save(_.omit(n,"measurementUnit"),e)}).then(o.getResData).then(s).then(function(){return u.setUserTfaSettings(n,{tfaEnforced:!!i.userTfaEnforced})}).then(function(){return a.success(g("User saved."))}).then(e).finally(function(){i.saving=!1})}catch(e){a.danger(e.message),i.saving=!1}}function S(e){e&&t.changeTitle({title:e})}function I(e){return u.hasRole(e,"ROLE_USER_MANAGEMENT_ADMIN")||u.hasRole(e,"ROLE_USER_MANAGEMENT_CREATE")}function P(e){return _.get(i.user,"owner")&&p&&!p[e.id]}i.checkPassword=function(e){i.isNew||!i.password.showPassword&&!function(e){return e.email!==R}(e)?M(i.user):s.askForPassword().then(O)},i.$watch("user.userName",S),i.$watch("user.owner",function(e){e?u.detail(e).then(o.getResData).then(function(e){p=y(e),_.forEach(i._groups,function(e,n){i._groups[n]=e&&p[n]})}):p=null}),i.$watch("_groups",function(e){i.enforcedGroup&&(i.topLevelTfaEnforced=e[i.enforcedGroup.id])},!0),i.canEditUser=function(e,n){return!(!e||!n)&&(!n.id||(e.id!==n.id?u.hasRole(e,"ROLE_USER_MANAGEMENT_ADMIN")||u.hasRole(e,"ROLE_USER_MANAGEMENT_CREATE"):u.hasRole(e,"ROLE_USER_MANAGEMENT_OWN_ADMIN")))},i.canEditUserGroups=I,i.canActivateUser=function(e,n){return!(!e||!n)&&e.id!==n.id},i.forms={},i.password={},i.saving=!1,i.showAcl=function(){var e=_.get(i.user,"devicePermissions"),n=_.keys(e);return o.getFlag("deprecated")||n.length},i.cannotSelectGlobalRole=function(e){return I(w)&&_.get(i.user,"owner")&&P(e)},i.restrictedByOwner=P,i.$on("$destroy",function(){a.remove({text:f.EXTERNAL_ORIGIN_TEXT,type:"warning"}),a.remove({text:f.LOCAL_USER_TEXT,type:"warning"})}),c.list(T).then(L).then(d.isSsoEnabled).then(function(e){U=e}).then(N).then(function(){return r.current().then(function(e){return u.getTenantTfaSettings(i.user,e.name)}).then(function(e){i.enforcedGroup=_.find(i.groups,{name:e.enforcedUsersGroup}),i.topLevelTfaEnforced=u.isEnforcedForUser(i.user,e)})}),u.current().then(G),f.userHierarchyActive().then(function(e){h.FEATURE_USER_HIERARCHY=e})}e.$inject=["$scope","$routeParams","$window","c8yBase","c8yUser","c8yUserGroup","c8yAlert","c8yTitle","c8yTenant","c8yUserUtil","c8yUsersUi","c8yUserPreferences","c8yLoginOptions","c8yBeta","gettext"],angular.module("c8y.users").component("c8yUserDetailView",{templateUrl:":::PLUGIN_PATH:::/userDetailView/userDetailView.html",controller:e,controllerAs:"vm"})}();