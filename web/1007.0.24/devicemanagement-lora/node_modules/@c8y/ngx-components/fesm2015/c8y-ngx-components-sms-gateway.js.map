{"version":3,"file":"c8y-ngx-components-sms-gateway.js","sources":["ng://@c8y/ngx-components/sms-gateway/sms-gateway.service.ts","ng://@c8y/ngx-components/sms-gateway/sms-gateway.component.ts","ng://@c8y/ngx-components/sms-gateway/sms-gateway-navigation.factory.ts","ng://@c8y/ngx-components/sms-gateway/sms-gateway.module.ts","ng://@c8y/ngx-components/sms-gateway/c8y-ngx-components-sms-gateway.ts"],"sourcesContent":["import { Injectable } from '@angular/core';\nimport { FetchClient, IFetchOptions, TenantOptionsService } from '@c8y/client';\n\n@Injectable()\nexport class SmsGatewayService {\n  private readonly category = 'messaging';\n  private readonly basePath = 'service/register/messaging';\n  private providerTemplates = {\n    cepConfig: {\n      'sms.senderAddress': 'cumulocity',\n      'sms.senderName': 'cumulocity'\n    },\n    openit: {\n      provider: 'openit',\n      'openit.baseUrl': 'https://sms.plusserver.com/put.php'\n    },\n    sms77: {\n      provider: 'sms77',\n      'sms77.url': 'https://gateway.sms77.io/api/sms'\n    }\n  };\n\n  constructor(private client: FetchClient, private tenantOptionsService: TenantOptionsService) {}\n\n  getProviderConfig() {\n    return this.tenantOptionsService.detail({ category: this.category, key: '' });\n  }\n\n  async saveProviderConfig(newConfig) {\n    const providerTemplate = this.providerTemplates[newConfig.provider];\n    const { cepConfig } = this.providerTemplates;\n    Object.assign(newConfig, providerTemplate, cepConfig);\n\n    const config: IFetchOptions = {\n      method: 'PUT',\n      headers: { 'content-type': 'application/json' },\n      body: JSON.stringify(newConfig)\n    };\n    return this.client.fetch(this.basePath, config);\n  }\n\n  async deleteProviderConfig(config) {\n    const providerTemplate = this.providerTemplates[config.provider];\n    Object.assign(config, providerTemplate);\n    return this.deleteProviderOptions(config);\n  }\n\n  private async deleteProviderOptions(options) {\n    for (const optionKey of Object.keys(options)) {\n      await this.tenantOptionsService.delete({ category: this.category, key: optionKey });\n    }\n  }\n}\n","import { Component } from '@angular/core';\nimport { SmsConfig } from './sms-config.model';\nimport { ModalService, AlertService, gettext, Status } from '@c8y/ngx-components';\nimport { SmsGatewayService } from './sms-gateway.service';\nimport { pick } from 'lodash-es';\n\n@Component({\n  selector: 'c8y-sms-gateway',\n  templateUrl: './sms-gateway.component.html'\n})\nexport class SmsGatewayComponent {\n  smsConfig: SmsConfig;\n  oldConfig: SmsConfig;\n  readonly smsProviders;\n  readonly pageTitle;\n  private readonly supportedConfigOptions;\n\n  constructor(\n    private modalService: ModalService,\n    private alertService: AlertService,\n    private smsGatewayService: SmsGatewayService\n  ) {\n    this.smsProviders = [\n      { id: 'openit', name: 'OpenIT' },\n      { id: 'sms77', name: 'sms77' }\n    ];\n    this.supportedConfigOptions = [\n      'provider',\n      'openit.username',\n      'credentials.openit.password',\n      'credentials.sms77.api.key'\n    ];\n    this.pageTitle = gettext('SMS provider');\n  }\n\n  async ngOnInit() {\n    this.smsConfig = this.getEmptyConfig();\n    this.oldConfig = this.getEmptyConfig();\n    const res = await this.smsGatewayService.getProviderConfig();\n    if (this.isSupportedProvider(res.data)) {\n      this.smsConfig = this.getConfigurableProperties(res.data);\n      this.oldConfig = this.smsConfig;\n    }\n  }\n\n  getConfigurableProperties(config): SmsConfig {\n    return pick(config, this.supportedConfigOptions);\n  }\n\n  isSupportedProvider(config) {\n    return this.smsProviders.some(prov => prov.id === config.provider);\n  }\n\n  async saveSMSGatewayConfiguration(form) {\n    const res = await this.smsGatewayService.saveProviderConfig(this.smsConfig);\n    if (res && res.status !== 200) {\n      const data = res.json ? await res.json() : undefined;\n      this.alertService.addServerFailure({ data, res });\n    } else {\n      this.alertService.success(gettext('Credentials updated.'));\n      Object.assign(this.oldConfig, this.smsConfig);\n      form.pristine = true;\n    }\n  }\n\n  async deleteSMSGatewayConfiguration() {\n    await this.modalService.confirm(\n      gettext('Delete credentials'),\n      gettext(`You are about to delete SMS provider credentials. Deleting credentials will lock out any users with\n      SMS-based two-factor authentication and deactivate the SMS-based smart rules and device communication.\n      Do you want to proceed?`),\n      Status.DANGER,\n      { ok: gettext('Delete') }\n    );\n    await this.smsGatewayService.deleteProviderConfig(this.oldConfig);\n    this.alertService.success(gettext('Credentials deleted.'));\n    this.smsConfig = this.getEmptyConfig();\n    this.oldConfig = this.getEmptyConfig();\n  }\n\n  getEmptyConfig(): SmsConfig {\n    return {\n      provider: undefined\n    };\n  }\n}\n","import { Injectable } from '@angular/core';\nimport { gettext, NavigatorNode, NavigatorNodeFactory } from '@c8y/ngx-components';\nimport { ApplicationService } from '@c8y/client';\n\n@Injectable()\nexport class SmsGatewayNavigationFactory implements NavigatorNodeFactory {\n  private static readonly applicationName = 'sms-gateway';\n  private nodeItem: NavigatorNode;\n\n  constructor(private applicationService: ApplicationService) {}\n  async get() {\n    if (!this.nodeItem) {\n      const showSMSProvider: boolean = (await this.applicationService.isAvailable(\n        SmsGatewayNavigationFactory.applicationName\n      )).data;\n\n      if (showSMSProvider) {\n        this.nodeItem = new NavigatorNode({\n          label: gettext('SMS provider'),\n          path: 'smsgateway',\n          icon: 'envelope-o',\n          parent: gettext('Settings'),\n          priority: 1000\n        });\n      }\n    }\n    return this.nodeItem;\n  }\n}\n","import { NgModule } from '@angular/core';\nimport { RouterModule } from '@angular/router';\nimport {\n  CoreModule,\n  CommonModule,\n  FormsModule,\n  Route,\n  NavigatorNode,\n  gettext,\n  HOOK_NAVIGATOR_NODES\n} from '@c8y/ngx-components';\nimport { UpgradeModule } from '@c8y/ngx-components/upgrade';\nimport { SmsGatewayComponent } from './sms-gateway.component';\nimport { SmsGatewayService } from './sms-gateway.service';\nimport { SmsGatewayNavigationFactory } from './sms-gateway-navigation.factory';\n\nconst smsGatewayRoutes: Route[] = [{ path: 'smsgateway', component: SmsGatewayComponent }];\n\n@NgModule({\n  declarations: [SmsGatewayComponent],\n  exports: [SmsGatewayComponent],\n  imports: [\n    CoreModule,\n    CommonModule,\n    FormsModule,\n    RouterModule.forRoot(smsGatewayRoutes, { useHash: true }),\n    UpgradeModule\n  ],\n  entryComponents: [SmsGatewayComponent],\n  providers: [\n    SmsGatewayService,\n    { provide: HOOK_NAVIGATOR_NODES, useClass: SmsGatewayNavigationFactory, multi: true }\n  ]\n})\nexport class SmsGatewayModule {}\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './index';\n\nexport {SmsGatewayNavigationFactory as ɵb} from './sms-gateway-navigation.factory';\nexport {SmsGatewayService as ɵa} from './sms-gateway.service';"],"names":[],"mappings":";;;;;;;;IAIa,iBAAiB,GAA9B,MAAa,iBAAiB;IAkB5B,YAAoB,MAAmB,EAAU,oBAA0C;QAAvE,WAAM,GAAN,MAAM,CAAa;QAAU,yBAAoB,GAApB,oBAAoB,CAAsB;QAjB1E,aAAQ,GAAG,WAAW,CAAC;QACvB,aAAQ,GAAG,4BAA4B,CAAC;QACjD,sBAAiB,GAAG;YAC1B,SAAS,EAAE;gBACT,mBAAmB,EAAE,YAAY;gBACjC,gBAAgB,EAAE,YAAY;aAC/B;YACD,MAAM,EAAE;gBACN,QAAQ,EAAE,QAAQ;gBAClB,gBAAgB,EAAE,oCAAoC;aACvD;YACD,KAAK,EAAE;gBACL,QAAQ,EAAE,OAAO;gBACjB,WAAW,EAAE,kCAAkC;aAChD;SACF,CAAC;KAE6F;IAE/F,iBAAiB;QACf,OAAO,IAAI,CAAC,oBAAoB,CAAC,MAAM,CAAC,EAAE,QAAQ,EAAE,IAAI,CAAC,QAAQ,EAAE,GAAG,EAAE,EAAE,EAAE,CAAC,CAAC;KAC/E;IAEK,kBAAkB,CAAC,SAAS;;YAChC,MAAM,gBAAgB,GAAG,IAAI,CAAC,iBAAiB,CAAC,SAAS,CAAC,QAAQ,CAAC,CAAC;YACpE,MAAM,EAAE,SAAS,EAAE,GAAG,IAAI,CAAC,iBAAiB,CAAC;YAC7C,MAAM,CAAC,MAAM,CAAC,SAAS,EAAE,gBAAgB,EAAE,SAAS,CAAC,CAAC;YAEtD,MAAM,MAAM,GAAkB;gBAC5B,MAAM,EAAE,KAAK;gBACb,OAAO,EAAE,EAAE,cAAc,EAAE,kBAAkB,EAAE;gBAC/C,IAAI,EAAE,IAAI,CAAC,SAAS,CAAC,SAAS,CAAC;aAChC,CAAC;YACF,OAAO,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,IAAI,CAAC,QAAQ,EAAE,MAAM,CAAC,CAAC;SACjD;KAAA;IAEK,oBAAoB,CAAC,MAAM;;YAC/B,MAAM,gBAAgB,GAAG,IAAI,CAAC,iBAAiB,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC;YACjE,MAAM,CAAC,MAAM,CAAC,MAAM,EAAE,gBAAgB,CAAC,CAAC;YACxC,OAAO,IAAI,CAAC,qBAAqB,CAAC,MAAM,CAAC,CAAC;SAC3C;KAAA;IAEa,qBAAqB,CAAC,OAAO;;YACzC,KAAK,MAAM,SAAS,IAAI,MAAM,CAAC,IAAI,CAAC,OAAO,CAAC,EAAE;gBAC5C,MAAM,IAAI,CAAC,oBAAoB,CAAC,MAAM,CAAC,EAAE,QAAQ,EAAE,IAAI,CAAC,QAAQ,EAAE,GAAG,EAAE,SAAS,EAAE,CAAC,CAAC;aACrF;SACF;KAAA;CACF,CAAA;;YA9B6B,WAAW;YAAgC,oBAAoB;;AAlBhF,iBAAiB;IAD7B,UAAU,EAAE;GACA,iBAAiB,CAgD7B;;IC1CY,mBAAmB,GAAhC,MAAa,mBAAmB;IAO9B,YACU,YAA0B,EAC1B,YAA0B,EAC1B,iBAAoC;QAFpC,iBAAY,GAAZ,YAAY,CAAc;QAC1B,iBAAY,GAAZ,YAAY,CAAc;QAC1B,sBAAiB,GAAjB,iBAAiB,CAAmB;QAE5C,IAAI,CAAC,YAAY,GAAG;YAClB,EAAE,EAAE,EAAE,QAAQ,EAAE,IAAI,EAAE,QAAQ,EAAE;YAChC,EAAE,EAAE,EAAE,OAAO,EAAE,IAAI,EAAE,OAAO,EAAE;SAC/B,CAAC;QACF,IAAI,CAAC,sBAAsB,GAAG;YAC5B,UAAU;YACV,iBAAiB;YACjB,6BAA6B;YAC7B,2BAA2B;SAC5B,CAAC;QACF,IAAI,CAAC,SAAS,GAAG,OAAO,CAAC,cAAc,CAAC,CAAC;KAC1C;IAEK,QAAQ;;YACZ,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC,cAAc,EAAE,CAAC;YACvC,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC,cAAc,EAAE,CAAC;YACvC,MAAM,GAAG,GAAG,MAAM,IAAI,CAAC,iBAAiB,CAAC,iBAAiB,EAAE,CAAC;YAC7D,IAAI,IAAI,CAAC,mBAAmB,CAAC,GAAG,CAAC,IAAI,CAAC,EAAE;gBACtC,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC,yBAAyB,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;gBAC1D,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC,SAAS,CAAC;aACjC;SACF;KAAA;IAED,yBAAyB,CAAC,MAAM;QAC9B,OAAO,IAAI,CAAC,MAAM,EAAE,IAAI,CAAC,sBAAsB,CAAC,CAAC;KAClD;IAED,mBAAmB,CAAC,MAAM;QACxB,OAAO,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,IAAI,IAAI,IAAI,CAAC,EAAE,KAAK,MAAM,CAAC,QAAQ,CAAC,CAAC;KACpE;IAEK,2BAA2B,CAAC,IAAI;;YACpC,MAAM,GAAG,GAAG,MAAM,IAAI,CAAC,iBAAiB,CAAC,kBAAkB,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;YAC5E,IAAI,GAAG,IAAI,GAAG,CAAC,MAAM,KAAK,GAAG,EAAE;gBAC7B,MAAM,IAAI,GAAG,GAAG,CAAC,IAAI,GAAG,MAAM,GAAG,CAAC,IAAI,EAAE,GAAG,SAAS,CAAC;gBACrD,IAAI,CAAC,YAAY,CAAC,gBAAgB,CAAC,EAAE,IAAI,EAAE,GAAG,EAAE,CAAC,CAAC;aACnD;iBAAM;gBACL,IAAI,CAAC,YAAY,CAAC,OAAO,CAAC,OAAO,CAAC,sBAAsB,CAAC,CAAC,CAAC;gBAC3D,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,SAAS,EAAE,IAAI,CAAC,SAAS,CAAC,CAAC;gBAC9C,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC;aACtB;SACF;KAAA;IAEK,6BAA6B;;YACjC,MAAM,IAAI,CAAC,YAAY,CAAC,OAAO,CAC7B,OAAO,CAAC,oBAAoB,CAAC,EAC7B,OAAO,CAAC;;8BAEgB,CAAC,EACzB,MAAM,CAAC,MAAM,EACb,EAAE,EAAE,EAAE,OAAO,CAAC,QAAQ,CAAC,EAAE,CAC1B,CAAC;YACF,MAAM,IAAI,CAAC,iBAAiB,CAAC,oBAAoB,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;YAClE,IAAI,CAAC,YAAY,CAAC,OAAO,CAAC,OAAO,CAAC,sBAAsB,CAAC,CAAC,CAAC;YAC3D,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC,cAAc,EAAE,CAAC;YACvC,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC,cAAc,EAAE,CAAC;SACxC;KAAA;IAED,cAAc;QACZ,OAAO;YACL,QAAQ,EAAE,SAAS;SACpB,CAAC;KACH;CACF,CAAA;;YAnEyB,YAAY;YACZ,YAAY;YACP,iBAAiB;;AAVnC,mBAAmB;IAJ/B,SAAS,CAAC;QACT,QAAQ,EAAE,iBAAiB;QAC3B,23GAA2C;KAC5C,CAAC;GACW,mBAAmB,CA2E/B;;;IChFY,2BAA2B,mCAAxC,MAAa,2BAA2B;IAItC,YAAoB,kBAAsC;QAAtC,uBAAkB,GAAlB,kBAAkB,CAAoB;KAAI;IACxD,GAAG;;YACP,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE;gBAClB,MAAM,eAAe,GAAY,CAAC,MAAM,IAAI,CAAC,kBAAkB,CAAC,WAAW,CACzE,6BAA2B,CAAC,eAAe,CAC5C,EAAE,IAAI,CAAC;gBAER,IAAI,eAAe,EAAE;oBACnB,IAAI,CAAC,QAAQ,GAAG,IAAI,aAAa,CAAC;wBAChC,KAAK,EAAE,OAAO,CAAC,cAAc,CAAC;wBAC9B,IAAI,EAAE,YAAY;wBAClB,IAAI,EAAE,YAAY;wBAClB,MAAM,EAAE,OAAO,CAAC,UAAU,CAAC;wBAC3B,QAAQ,EAAE,IAAI;qBACf,CAAC,CAAC;iBACJ;aACF;YACD,OAAO,IAAI,CAAC,QAAQ,CAAC;SACtB;KAAA;CACF,CAAA;AAtByB,2CAAe,GAAG,aAAa,CAAC;;YAGhB,kBAAkB;;AAJ/C,2BAA2B;IADvC,UAAU,EAAE;GACA,2BAA2B,CAuBvC;;ACZD,MAAM,gBAAgB,GAAY,CAAC,EAAE,IAAI,EAAE,YAAY,EAAE,SAAS,EAAE,mBAAmB,EAAE,CAAC,CAAC;AAkB3F,IAAa,gBAAgB,GAA7B,MAAa,gBAAgB;CAAG,CAAA;AAAnB,gBAAgB;IAhB5B,QAAQ,CAAC;QACR,YAAY,EAAE,CAAC,mBAAmB,CAAC;QACnC,OAAO,EAAE,CAAC,mBAAmB,CAAC;QAC9B,OAAO,EAAE;YACP,UAAU;YACV,YAAY;YACZ,WAAW;YACX,YAAY,CAAC,OAAO,CAAC,gBAAgB,EAAE,EAAE,OAAO,EAAE,IAAI,EAAE,CAAC;YACzD,aAAa;SACd;QACD,eAAe,EAAE,CAAC,mBAAmB,CAAC;QACtC,SAAS,EAAE;YACT,iBAAiB;YACjB,EAAE,OAAO,EAAE,oBAAoB,EAAE,QAAQ,EAAE,2BAA2B,EAAE,KAAK,EAAE,IAAI,EAAE;SACtF;KACF,CAAC;GACW,gBAAgB,CAAG;;AClChC;;GAEG;;;;"}