import * as tslib_1 from "tslib";
import { Component } from '@angular/core';
import { FormBuilder, FormGroup, Validators } from '@angular/forms';
import { AlertService, gettext, ModalService, Status } from '@c8y/ngx-components';
import { ImpactConnectivityService } from './impact-connectivity.service';
import { TenantConnectionStatus } from './impact.model';
var ImpactProviderSettingsComponent = /** @class */ (function () {
    function ImpactProviderSettingsComponent(impactService, formBuilder, modal, alert) {
        this.impactService = impactService;
        this.formBuilder = formBuilder;
        this.modal = modal;
        this.alert = alert;
        this.isEdit = false;
        this.credentialsExist = false;
    }
    ImpactProviderSettingsComponent.prototype.ngOnInit = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var response, _a;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        this.initForm();
                        return [4 /*yield*/, this.impactService.getOptions()];
                    case 1:
                        response = _b.sent();
                        _a = this;
                        return [4 /*yield*/, response.json()];
                    case 2:
                        _a.connectionStatus = _b.sent();
                        if (this.connectionStatus && this.connectionStatus.options) {
                            this.formGroup.patchValue(tslib_1.__assign({}, this.connectionStatus.options));
                            this.credentialsExist = true;
                        }
                        else {
                            this.isEdit = true;
                        }
                        return [2 /*return*/];
                }
            });
        });
    };
    ImpactProviderSettingsComponent.prototype.replaceCredentials = function () {
        this.isEdit = true;
    };
    ImpactProviderSettingsComponent.prototype.saveCredentials = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var updated, response, _a;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        if (!this.formGroup.valid) return [3 /*break*/, 5];
                        this.connectionStatus.status = TenantConnectionStatus.CONNECTING_IN_PROGRESS;
                        return [4 /*yield*/, this.safelyUpdateCredentials(this.formGroup.value)];
                    case 1:
                        updated = _b.sent();
                        if (!updated) return [3 /*break*/, 4];
                        return [4 /*yield*/, this.impactService.getOptions()];
                    case 2:
                        response = _b.sent();
                        _a = this;
                        return [4 /*yield*/, response.json()];
                    case 3:
                        _a.connectionStatus = _b.sent();
                        if (this.connectionStatus.status === TenantConnectionStatus.CONNECTED_SUCCESSFULLY) {
                            this.isEdit = false;
                        }
                        this.alert.success(gettext('Credentials saved.'));
                        return [3 /*break*/, 5];
                    case 4:
                        this.connectionStatus.status = TenantConnectionStatus.UNKNOWN;
                        _b.label = 5;
                    case 5: return [2 /*return*/];
                }
            });
        });
    };
    ImpactProviderSettingsComponent.prototype.deleteCredentials = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var ex_1;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 3, , 4]);
                        return [4 /*yield*/, this.modal.confirm(gettext('Delete credentials'), gettext('You are about to delete your IMPACT credentials. Deleting credentials will break connection to IMPACT instance. Do you want to proceed?'), Status.DANGER, { ok: gettext('Delete'), cancel: gettext('Cancel') })];
                    case 1:
                        _a.sent();
                        return [4 /*yield*/, this.safelyDeleteCredentials()];
                    case 2:
                        _a.sent();
                        return [3 /*break*/, 4];
                    case 3:
                        ex_1 = _a.sent();
                        return [3 /*break*/, 4];
                    case 4: return [2 /*return*/];
                }
            });
        });
    };
    ImpactProviderSettingsComponent.prototype.initForm = function () {
        this.formGroup = this.formBuilder.group({
            baseUrl: [],
            user: ['', Validators.required],
            password: ['', Validators.required],
            groupName: [],
            initializeDevices: [false]
        });
    };
    ImpactProviderSettingsComponent.prototype.resetForm = function () {
        this.formGroup.reset();
    };
    ImpactProviderSettingsComponent.prototype.safelyUpdateCredentials = function (options) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var res, data, _a, ex_2;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        _b.trys.push([0, 7, , 8]);
                        return [4 /*yield*/, this.impactService.updateOptions(options)];
                    case 1:
                        res = _b.sent();
                        if (!(res && res.status !== 200)) return [3 /*break*/, 5];
                        if (!res.json) return [3 /*break*/, 3];
                        return [4 /*yield*/, res.json()];
                    case 2:
                        _a = _b.sent();
                        return [3 /*break*/, 4];
                    case 3:
                        _a = undefined;
                        _b.label = 4;
                    case 4:
                        data = _a;
                        this.alert.addServerFailure({ data: data, res: res });
                        return [2 /*return*/, Promise.resolve(false)];
                    case 5: return [2 /*return*/, Promise.resolve(true)];
                    case 6: return [3 /*break*/, 8];
                    case 7:
                        ex_2 = _b.sent();
                        this.alert.addServerFailure(ex_2);
                        return [2 /*return*/, Promise.resolve(false)];
                    case 8: return [2 /*return*/];
                }
            });
        });
    };
    ImpactProviderSettingsComponent.prototype.safelyDeleteCredentials = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var res, data, _a, ex_3;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        _b.trys.push([0, 7, , 8]);
                        return [4 /*yield*/, this.impactService.deleteOptions()];
                    case 1:
                        res = _b.sent();
                        if (!(res && res.status !== 200)) return [3 /*break*/, 5];
                        if (!res.json) return [3 /*break*/, 3];
                        return [4 /*yield*/, res.json()];
                    case 2:
                        _a = _b.sent();
                        return [3 /*break*/, 4];
                    case 3:
                        _a = undefined;
                        _b.label = 4;
                    case 4:
                        data = _a;
                        this.alert.addServerFailure({ data: data, res: res });
                        return [3 /*break*/, 6];
                    case 5:
                        this.credentialsExist = false;
                        this.resetForm();
                        this.connectionStatus = null;
                        this.alert.success(gettext('Credentials deleted.'));
                        _b.label = 6;
                    case 6: return [3 /*break*/, 8];
                    case 7:
                        ex_3 = _b.sent();
                        this.alert.addServerFailure(ex_3);
                        return [3 /*break*/, 8];
                    case 8: return [2 /*return*/];
                }
            });
        });
    };
    ImpactProviderSettingsComponent.ctorParameters = function () { return [
        { type: ImpactConnectivityService },
        { type: FormBuilder },
        { type: ModalService },
        { type: AlertService }
    ]; };
    ImpactProviderSettingsComponent = tslib_1.__decorate([
        Component({
            selector: 'c8y-impact-provider-settings',
            template: "<div class=\"row\">\n  <div class=\"col-xs-12 col-md-8 col-lg-6\">\n    <form class=\"card\" [formGroup]=\"formGroup\" novalidate>\n      <div class=\"card-header separator\">\n        <h4 class=\"card-title\" translate>Credentials</h4>\n      </div>\n      <div class=\"card-block\" *ngIf=\"isEdit\">\n        <c8y-form-group>\n          <label for=\"baseUrl\" translate>\n            Base URL\n          </label>\n          <input\n            id=\"baseUrl\"\n            name=\"baseUrl\"\n            type=\"text\"\n            class=\"form-control\"\n            placeholder=\"{{ 'e.g. https://impact.example.com' | translate }}\"\n            autocomplete=\"off\"\n            formControlName=\"baseUrl\"\n          />\n        </c8y-form-group>\n        <c8y-form-group>\n          <label for=\"user\" translate>\n            User\n          </label>\n          <input\n            id=\"user\"\n            name=\"user\"\n            type=\"text\"\n            class=\"form-control\"\n            placeholder=\"{{ 'e.g. joe`LOCALIZE`' | translate }}\"\n            required\n            autocomplete=\"off\"\n            formControlName=\"user\"\n          />\n          <c8y-messages>\n            <c8y-message *ngIf=\"formGroup?.controls?.user?.errors?.required\" translate>\n              This field is required.\n            </c8y-message>\n          </c8y-messages>\n        </c8y-form-group>\n        <c8y-form-group>\n          <label for=\"password\" translate>\n            Password\n          </label>\n          <input\n            id=\"password\"\n            name=\"password\"\n            type=\"password\"\n            class=\"form-control\"\n            placeholder=\"{{ 'e.g. my_password' | translate }}\"\n            required\n            autocomplete=\"off\"\n            formControlName=\"password\"\n          />\n          <c8y-messages>\n            <c8y-message *ngIf=\"formGroup?.controls?.password?.errors?.required\" translate>\n              This field is required.\n            </c8y-message>\n          </c8y-messages>\n        </c8y-form-group>\n        <c8y-form-group>\n          <label for=\"groupName\" translate>\n            IMPACT group name prefix\n          </label>\n          <input\n            id=\"groupName\"\n            name=\"groupName\"\n            type=\"text\"\n            class=\"form-control\"\n            placeholder=\"{{ 'e.g. Europe.Nokia`LOCALIZE`' | translate }}\"\n            formControlName=\"groupName\"\n          />\n        </c8y-form-group>\n      </div>\n      <div class=\"card-block bg-gray-white\">\n        <div class=\"d-flex\">\n          <c8y-status-display\n            [status]=\"connectionStatus?.status\"\n            [baseUrl]=\"connectionStatus?.options?.baseUrl\"\n          ></c8y-status-display>\n\n          <div class=\"d-flex flex-item-middle flex-item-right\">\n            <label class=\"c8y-switch\">\n              <input type=\"checkbox\" formControlName=\"initializeDevices\" />\n              <span></span> {{ 'Refresh devices' | translate }}\n            </label>\n            <a\n              container=\"body\"\n              class=\"btn-clean m-l-4 flex-item-middle\"\n              popover=\"{{ 'Refresh device resources as part of connecting' | translate }}\"\n              placement=\"right\"\n              outsideClick=\"false\"\n            >\n              <i c8yIcon=\"question-circle-o text-primary\"></i>\n            </a>\n          </div>\n        </div>\n      </div>\n      <div class=\"card-block\" *ngIf=\"credentialsExist && !isEdit\">\n        <p translate>\n          Credentials already provided.<br />\n          Click \"Replace credentials\" below to overwrite them.\n        </p>\n      </div>\n      <div class=\"card-footer\">\n        <button\n          title=\"{{ 'Replace credentials' | translate }}\"\n          type=\"submit\"\n          class=\"btn btn-default\"\n          translate\n          *ngIf=\"!isEdit\"\n          (click)=\"replaceCredentials()\"\n        >\n          Replace credentials\n        </button>\n        <button\n          title=\"{{ 'Delete credentials' | translate }}\"\n          type=\"button\"\n          class=\"btn btn-danger\"\n          translate\n          *ngIf=\"credentialsExist && isEdit\"\n          (click)=\"deleteCredentials()\"\n        >\n          Delete credentials\n        </button>\n        <button\n          title=\"{{ 'Save credentials & connect' | translate }}\"\n          type=\"button\"\n          class=\"btn btn-primary\"\n          translate\n          *ngIf=\"isEdit\"\n          [disabled]=\"formGroup.invalid\"\n          (click)=\"saveCredentials()\"\n        >\n          Save credentials & connect\n        </button>\n      </div>\n    </form>\n  </div>\n</div>\n"
        })
    ], ImpactProviderSettingsComponent);
    return ImpactProviderSettingsComponent;
}());
export { ImpactProviderSettingsComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1wYWN0LXByb3ZpZGVyLXNldHRpbmdzLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvY29ubmVjdGl2aXR5LyIsInNvdXJjZXMiOlsiaW1wYWN0L2ltcGFjdC1wcm92aWRlci1zZXR0aW5ncy5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQVUsTUFBTSxlQUFlLENBQUM7QUFDbEQsT0FBTyxFQUFFLFdBQVcsRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFcEUsT0FBTyxFQUFFLFlBQVksRUFBRSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ2xGLE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBQzFFLE9BQU8sRUFFTCxzQkFBc0IsRUFFdkIsTUFBTSxnQkFBZ0IsQ0FBQztBQU14QjtJQU9FLHlDQUNVLGFBQXdDLEVBQ3hDLFdBQXdCLEVBQ3hCLEtBQW1CLEVBQ25CLEtBQW1CO1FBSG5CLGtCQUFhLEdBQWIsYUFBYSxDQUEyQjtRQUN4QyxnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUN4QixVQUFLLEdBQUwsS0FBSyxDQUFjO1FBQ25CLFVBQUssR0FBTCxLQUFLLENBQWM7UUFQN0IsV0FBTSxHQUFZLEtBQUssQ0FBQztRQUN4QixxQkFBZ0IsR0FBWSxLQUFLLENBQUM7SUFPL0IsQ0FBQztJQUVFLGtEQUFRLEdBQWQ7Ozs7Ozt3QkFDRSxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7d0JBQ2lCLHFCQUFNLElBQUksQ0FBQyxhQUFhLENBQUMsVUFBVSxFQUFFLEVBQUE7O3dCQUFoRSxRQUFRLEdBQW1CLFNBQXFDO3dCQUN0RSxLQUFBLElBQUksQ0FBQTt3QkFBb0IscUJBQU0sUUFBUSxDQUFDLElBQUksRUFBRSxFQUFBOzt3QkFBN0MsR0FBSyxnQkFBZ0Is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LENBQUMsU0FBUyxFQUFFLENBQUM7d0JBQ2pCLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLENBQUM7d0JBQzdCLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDLENBQUM7Ozs7O3dCQUd0RCxJQUFJLENBQUMsS0FBSyxDQUFDLGdCQUFnQixDQUFDLElBQUUsQ0FBQyxDQUFDOzs7Ozs7S0FFbkM7O2dCQTFHd0IseUJBQXlCO2dCQUMzQixXQUFXO2dCQUNqQixZQUFZO2dCQUNaLFlBQVk7O0lBWGxCLCtCQUErQjtRQUozQyxTQUFTLENBQUM7WUFDVCxRQUFRLEVBQUUsOEJBQThCO1lBQ3hDLDRxSkFBd0Q7U0FDekQsQ0FBQztPQUNXLCtCQUErQixDQW1IM0M7SUFBRCxzQ0FBQztDQUFBLEFBbkhELElBbUhDO1NBbkhZLCtCQUErQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgT25Jbml0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBGb3JtQnVpbGRlciwgRm9ybUdyb3VwLCBWYWxpZGF0b3JzIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHsgSUZldGNoUmVzcG9uc2UgfSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBBbGVydFNlcnZpY2UsIGdldHRleHQsIE1vZGFsU2VydmljZSwgU3RhdHVzIH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQgeyBJbXBhY3RDb25uZWN0aXZpdHlTZXJ2aWNlIH0gZnJvbSAnLi9pbXBhY3QtY29ubmVjdGl2aXR5LnNlcnZpY2UnO1xuaW1wb3J0IHtcbiAgSW1wYWN0T3B0aW9ucyxcbiAgVGVuYW50Q29ubmVjdGlvblN0YXR1cyxcbiAgVGVuYW50Q29ubmVjdGlvblN0YXR1c1Jlc3BvbnNlXG59IGZyb20gJy4vaW1wYWN0Lm1vZGVsJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LWltcGFjdC1wcm92aWRlci1zZXR0aW5ncycsXG4gIHRlbXBsYXRlVXJsOiAnLi9pbXBhY3QtcHJvdmlkZXItc2V0dGluZ3MuY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIEltcGFjdFByb3ZpZGVyU2V0dGluZ3NDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xuICBjb25uZWN0aW9uU3RhdHVzOiBUZW5hbnRDb25uZWN0aW9uU3RhdHVzUmVzcG9uc2U7XG4gIGZvcm1Hcm91cDogRm9ybUdyb3VwO1xuXG4gIGlzRWRpdDogYm9vbGVhbiA9IGZhbHNlO1xuICBjcmVkZW50aWFsc0V4aXN0OiBib29sZWFuID0gZmFsc2U7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBpbXBhY3RTZXJ2aWNlOiBJbXBhY3RDb25uZWN0aXZpdHlTZXJ2aWNlLFxuICAgIHByaXZhdGUgZm9ybUJ1aWxkZXI6IEZvcm1CdWlsZGVyLFxuICAgIHByaXZhdGUgbW9kYWw6IE1vZGFsU2VydmljZSxcbiAgICBwcml2YXRlIGFsZXJ0OiBBbGVydFNlcnZpY2VcbiAgKSB7fVxuXG4gIGFzeW5jIG5nT25Jbml0KCkge1xuICAgIHRoaXMuaW5pdEZvcm0oKTtcbiAgICBjb25zdCByZXNwb25zZTogSUZldGNoUmVzcG9uc2UgPSBhd2FpdCB0aGlzLmltcGFjdFNlcnZpY2UuZ2V0T3B0aW9ucygpO1xuICAgIHRoaXMuY29ubmVjdGlvblN0YXR1cyA9IGF3YWl0IHJlc3BvbnNlLmpzb24oKTtcblxuICAgIGlmICh0aGlzLmNvbm5lY3Rpb25TdGF0dXMgJiYgdGhpcy5jb25uZWN0aW9uU3RhdHVzLm9wdGlvbnMpIHtcbiAgICAgIHRoaXMuZm9ybUdyb3VwLnBhdGNoVmFsdWUoeyAuLi50aGlzLmNvbm5lY3Rpb25TdGF0dXMub3B0aW9ucyB9KTtcbiAgICAgIHRoaXMuY3JlZGVudGlhbHNFeGlzdCA9IHRydWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuaXNFZGl0ID0gdHJ1ZTtcbiAgICB9XG4gIH1cblxuICByZXBsYWNlQ3JlZGVudGlhbHMoKTogdm9pZCB7XG4gICAgdGhpcy5pc0VkaXQgPSB0cnVlO1xuICB9XG5cbiAgYXN5bmMgc2F2ZUNyZWRlbnRpYWxzKCkge1xuICAgIGlmICh0aGlzLmZvcm1Hcm91cC52YWxpZCkge1xuICAgICAgdGhpcy5jb25uZWN0aW9uU3RhdHVzLnN0YXR1cyA9IFRlbmFudENvbm5lY3Rpb25TdGF0dXMuQ09OTkVDVElOR19JTl9QUk9HUkVTUztcbiAgICAgIGNvbnN0IHVwZGF0ZWQ6IGJvb2xlYW4gPSBhd2FpdCB0aGlzLnNhZmVseVVwZGF0ZUNyZWRlbnRpYWxzKHRoaXMuZm9ybUdyb3VwLnZhbHVlKTtcblxuICAgICAgaWYgKHVwZGF0ZWQpIHtcbiAgICAgICAgY29uc3QgcmVzcG9uc2U6IElGZXRjaFJlc3BvbnNlID0gYXdhaXQgdGhpcy5pbXBhY3RTZXJ2aWNlLmdldE9wdGlvbnMoKTtcbiAgICAgICAgdGhpcy5jb25uZWN0aW9uU3RhdHVzID0gYXdhaXQgcmVzcG9uc2UuanNvbigpO1xuXG4gICAgICAgIGlmICh0aGlzLmNvbm5lY3Rpb25TdGF0dXMuc3RhdHVzID09PSBUZW5hbnRDb25uZWN0aW9uU3RhdHVzLkNPTk5FQ1RFRF9TVUNDRVNTRlVMTFkpIHtcbiAgICAgICAgICB0aGlzLmlzRWRpdCA9IGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5hbGVydC5zdWNjZXNzKGdldHRleHQoJ0NyZWRlbnRpYWxzIHNhdmVkLicpKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuY29ubmVjdGlvblN0YXR1cy5zdGF0dXMgPSBUZW5hbnRDb25uZWN0aW9uU3RhdHVzLlVOS05PV047XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZGVsZXRlQ3JlZGVudGlhbHMoKSB7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMubW9kYWwuY29uZmlybShcbiAgICAgICAgZ2V0dGV4dCgnRGVsZXRlIGNyZWRlbnRpYWxzJyksXG4gICAgICAgIGdldHRleHQoXG4gICAgICAgICAgJ1lvdSBhcmUgYWJvdXQgdG8gZGVsZXRlIHlvdXIgSU1QQUNUIGNyZWRlbnRpYWxzLiBEZWxldGluZyBjcmVkZW50aWFscyB3aWxsIGJyZWFrIGNvbm5lY3Rpb24gdG8gSU1QQUNUIGluc3RhbmNlLiBEbyB5b3Ugd2FudCB0byBwcm9jZWVkPydcbiAgICAgICAgKSxcbiAgICAgICAgU3RhdHVzLkRBTkdFUixcbiAgICAgICAgeyBvazogZ2V0dGV4dCgnRGVsZXRlJyksIGNhbmNlbDogZ2V0dGV4dCgnQ2FuY2VsJykgfVxuICAgICAgKTtcbiAgICAgIGF3YWl0IHRoaXMuc2FmZWx5RGVsZXRlQ3JlZGVudGlhbHMoKTtcbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgLy8gSW50ZW50aW9uYWxseSBlbXB0eVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaW5pdEZvcm0oKTogdm9pZCB7XG4gICAgdGhpcy5mb3JtR3JvdXAgPSB0aGlzLmZvcm1CdWlsZGVyLmdyb3VwKHtcbiAgICAgIGJhc2VVcmw6IFtdLFxuICAgICAgdXNlcjogWycnLCBWYWxpZGF0b3JzLnJlcXVpcmVkXSxcbiAgICAgIHBhc3N3b3JkOiBbJycsIFZhbGlkYXRvcnMucmVxdWlyZWRdLFxuICAgICAgZ3JvdXBOYW1lOiBbXSxcbiAgICAgIGluaXRpYWxpemVEZXZpY2VzOiBbZmFsc2VdXG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIHJlc2V0Rm9ybSgpOiB2b2lkIHtcbiAgICB0aGlzLmZvcm1Hcm91cC5yZXNldCgpO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBzYWZlbHlVcGRhdGVDcmVkZW50aWFscyhvcHRpb25zOiBJbXBhY3RPcHRpb25zKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMuaW1wYWN0U2VydmljZS51cGRhdGVPcHRpb25zKG9wdGlvbnMpO1xuICAgICAgaWYgKHJlcyAmJiByZXMuc3RhdHVzICE9PSAyMDApIHtcbiAgICAgICAgY29uc3QgZGF0YSA9IHJlcy5qc29uID8gYXdhaXQgcmVzLmpzb24oKSA6IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5hbGVydC5hZGRTZXJ2ZXJGYWlsdXJlKHsgZGF0YSwgcmVzIH0pO1xuXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoZmFsc2UpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh0cnVlKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgdGhpcy5hbGVydC5hZGRTZXJ2ZXJGYWlsdXJlKGV4KTtcblxuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShmYWxzZSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBzYWZlbHlEZWxldGVDcmVkZW50aWFscygpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzID0gYXdhaXQgdGhpcy5pbXBhY3RTZXJ2aWNlLmRlbGV0ZU9wdGlvbnMoKTtcbiAgICAgIGlmIChyZXMgJiYgcmVzLnN0YXR1cyAhPT0gMjAwKSB7XG4gICAgICAgIGNvbnN0IGRhdGEgPSByZXMuanNvbiA/IGF3YWl0IHJlcy5qc29uKCkgOiB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMuYWxlcnQuYWRkU2VydmVyRmFpbHVyZSh7IGRhdGEsIHJlcyB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuY3JlZGVudGlhbHNFeGlzdCA9IGZhbHNlO1xuICAgICAgICB0aGlzLnJlc2V0Rm9ybSgpO1xuICAgICAgICB0aGlzLmNvbm5lY3Rpb25TdGF0dXMgPSBudWxsO1xuICAgICAgICB0aGlzLmFsZXJ0LnN1Y2Nlc3MoZ2V0dGV4dCgnQ3JlZGVudGlhbHMgZGVsZXRlZC4nKSk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgIHRoaXMuYWxlcnQuYWRkU2VydmVyRmFpbHVyZShleCk7XG4gICAgfVxuICB9XG59XG4iXX0=