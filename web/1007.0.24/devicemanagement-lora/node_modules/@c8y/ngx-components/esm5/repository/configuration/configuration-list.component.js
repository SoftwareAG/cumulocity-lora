import * as tslib_1 from "tslib";
import { Component, ViewChild } from '@angular/core';
import { IManagedObject, InventoryBinaryService, InventoryService, IResultList } from '@c8y/client';
import { AlertService, FilterInputComponent, gettext, memoize, ModalService, Status } from '@c8y/ngx-components';
import { TranslateService } from '@ngx-translate/core';
import { BsModalService } from 'ngx-bootstrap/modal';
import { of, pipe } from 'rxjs';
import { map } from 'rxjs/operators';
import { RepositoryType } from '../repository.model';
import { RepositoryService } from '../repository.service';
import { ConfigurationDetailComponent } from './configuration-detail.component';
import { property } from 'lodash-es';
import { saveAs } from 'file-saver';
var ConfigurationListComponent = /** @class */ (function () {
    function ConfigurationListComponent(alert, repositoryService, bsModalService, modalService, translateService, inventoryBinaryService, inventoryService) {
        this.alert = alert;
        this.repositoryService = repositoryService;
        this.bsModalService = bsModalService;
        this.modalService = modalService;
        this.translateService = translateService;
        this.inventoryBinaryService = inventoryBinaryService;
        this.inventoryService = inventoryService;
        this.filterTerm = '';
        this.reloading = false;
        this.DELETED_SUCCESS_MSG = gettext('Configuration deleted.');
    }
    ConfigurationListComponent.prototype.ngOnInit = function () {
        this.loadConfigurations();
    };
    ConfigurationListComponent.prototype.loadConfigurations = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var _a, _b;
            return tslib_1.__generator(this, function (_c) {
                switch (_c.label) {
                    case 0:
                        this.reloading = true;
                        _a = this;
                        _b = of;
                        return [4 /*yield*/, this.repositoryService.listRepositoryEntries(RepositoryType.CONFIGURATION)];
                    case 1:
                        _a.configurations$ = _b.apply(void 0, [_c.sent()]);
                        this.reloading = false;
                        this.reset();
                        return [2 /*return*/];
                }
            });
        });
    };
    ConfigurationListComponent.prototype.add = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var ex_1;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 3, , 4]);
                        return [4 /*yield*/, this.bsModalService.show(ConfigurationDetailComponent, {
                                class: 'modal-sm',
                                ignoreBackdropClick: true
                            }).content.result];
                    case 1:
                        _a.sent();
                        return [4 /*yield*/, this.loadConfigurations()];
                    case 2:
                        _a.sent();
                        return [3 /*break*/, 4];
                    case 3:
                        ex_1 = _a.sent();
                        return [3 /*break*/, 4];
                    case 4: return [2 /*return*/];
                }
            });
        });
    };
    ConfigurationListComponent.prototype.edit = function (configuration) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var fileBinary, modal, ex_2;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.repositoryService.getBinaryFile(configuration.url, {
                            allowExternal: false
                        })];
                    case 1:
                        fileBinary = _a.sent();
                        _a.label = 2;
                    case 2:
                        _a.trys.push([2, 5, , 6]);
                        modal = this.bsModalService.show(ConfigurationDetailComponent, {
                            class: 'modal-sm',
                            ignoreBackdropClick: true,
                            initialState: {
                                selected: { id: configuration.id, configurationType: configuration.configurationType },
                                version: configuration.name,
                                deviceType: configuration.deviceType,
                                description: configuration.description,
                                binary: { file: fileBinary, url: configuration.url }
                            }
                        }).content;
                        modal.mo = configuration;
                        return [4 /*yield*/, modal.result];
                    case 3:
                        _a.sent();
                        return [4 /*yield*/, this.loadConfigurations()];
                    case 4:
                        _a.sent();
                        return [3 /*break*/, 6];
                    case 5:
                        ex_2 = _a.sent();
                        return [3 /*break*/, 6];
                    case 6: return [2 /*return*/];
                }
            });
        });
    };
    ConfigurationListComponent.prototype.isBinaryFile = function (configuration) {
        var id = this.inventoryBinaryService.getIdFromUrl(configuration.url);
        return id ? true : false;
    };
    ConfigurationListComponent.prototype.getBinaryName = function (configuration) {
        return this.repositoryService.getBinaryName$(configuration.url);
    };
    ConfigurationListComponent.prototype.download = function (configuration) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var fileBinary;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.repositoryService.getBinaryFile(configuration.url, {
                            allowExternal: false
                        })];
                    case 1:
                        fileBinary = _a.sent();
                        saveAs(fileBinary);
                        return [2 /*return*/];
                }
            });
        });
    };
    ConfigurationListComponent.prototype.delete = function (configuration) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var title, confirmationText, hint, proceed, body, labels, ex_3;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 4, , 5]);
                        title = gettext('Delete configuration snapshot');
                        confirmationText = gettext('You are about to delete the configuration snapshot {{ name }}.');
                        hint = gettext('This operation is irreversible.');
                        proceed = gettext('Do you want to proceed?');
                        body = [
                            this.translateService.instant(confirmationText, {
                                name: configuration.name
                            }),
                            this.translateService.instant(hint),
                            this.translateService.instant(proceed)
                        ].join(' ');
                        labels = {
                            ok: gettext('Delete')
                        };
                        return [4 /*yield*/, this.modalService.confirm(title, body, Status.DANGER, labels)];
                    case 1:
                        _a.sent();
                        return [4 /*yield*/, this.repositoryService.delete(configuration)];
                    case 2:
                        _a.sent();
                        this.alert.success(this.DELETED_SUCCESS_MSG);
                        return [4 /*yield*/, this.loadConfigurations()];
                    case 3:
                        _a.sent();
                        return [3 /*break*/, 5];
                    case 4:
                        ex_3 = _a.sent();
                        if (ex_3) {
                            this.alert.addServerFailure(ex_3);
                        }
                        return [3 /*break*/, 5];
                    case 5: return [2 /*return*/];
                }
            });
        });
    };
    ConfigurationListComponent.prototype.setPipe = function (filterTerm) {
        var _this = this;
        this.filterTerm = filterTerm;
        this.filterPipe = pipe(map(function (data) {
            return filterTerm.trim().length === 0
                ? data
                : data.filter(function (mo) {
                    return _this.filterContainString(mo.name, filterTerm) ||
                        _this.filterContainString(mo.configurationType, filterTerm) ||
                        _this.filterContainString(mo.deviceType, filterTerm);
                });
        }));
    };
    ConfigurationListComponent.prototype.reset = function () {
        this.filter.filterTerm = '';
        this.setPipe('');
    };
    ConfigurationListComponent.prototype.filterContainString = function (name, filterTerm) {
        var term = filterTerm.toLowerCase().trim();
        return name && name.toLowerCase().indexOf(term) > -1;
    };
    ConfigurationListComponent.ctorParameters = function () { return [
        { type: AlertService },
        { type: RepositoryService },
        { type: BsModalService },
        { type: ModalService },
        { type: TranslateService },
        { type: InventoryBinaryService },
        { type: InventoryService }
    ]; };
    tslib_1.__decorate([
        ViewChild(FilterInputComponent, { static: false })
    ], ConfigurationListComponent.prototype, "filter", void 0);
    tslib_1.__decorate([
        memoize(property('id'))
    ], ConfigurationListComponent.prototype, "getBinaryName", null);
    ConfigurationListComponent = tslib_1.__decorate([
        Component({
            selector: 'c8y-configuration-list',
            template: "<c8y-title>\n  <span translate>Configuration snapshots repository</span>&nbsp;\n  <small *ngIf=\"(configurations$ | async)?.paging.totalPages === 1 && !filterTerm\"\n    >{{ (configurations$ | async).data.length }} <span translate>snapshots</span></small\n  >\n  <small\n    *ngIf=\"(configurations$ | async)?.paging.totalPages > 1 && !filterTerm\"\n    [tooltip]=\"'More data available. Scroll to the bottom of the list to load it.' | translate\"\n    container=\"body\"\n    >{{ (configurations$ | async).paging.pageSize }}+ <span translate>snapshots</span></small\n  >\n  <small *ngIf=\"filterTerm\"\n    ><span translate>Search results for</span>&nbsp;\"{{ this.filterTerm }}\"</small\n  >\n</c8y-title>\n\n<c8y-action-bar-item itemClass=\"navbar-form\">\n  <c8y-filter [icon]=\"'search'\" (onSearch)=\"setPipe($event)\"></c8y-filter>\n</c8y-action-bar-item>\n\n<c8y-action-bar-item [placement]=\"'right'\">\n  <button class=\"btn btn-link\" (click)=\"add()\">\n    <i c8yIcon=\"plus-circle\"></i> {{ 'Add configuration snapshot' | translate }}\n  </button>\n</c8y-action-bar-item>\n\n<c8y-action-bar-item [placement]=\"'right'\">\n  <button class=\"btn btn-link\" title=\"{{ 'Reload' | translate }}\" (click)=\"loadConfigurations()\">\n    <i c8yIcon=\"refresh\" [ngClass]=\"{ 'fa-spin': reloading }\"></i>\n    {{ 'Reload' | translate }}\n  </button>\n</c8y-action-bar-item>\n\n<div\n  class=\"c8y-empty-state text-center\"\n  *ngIf=\"!filterTerm && (configurations$ | async)?.data.length === 0\"\n>\n  <h1 c8yIcon=\"gears\"></h1>\n  <h3 translate>There are no configuration snapshots defined</h3>\n  <p translate>Add a configuration snapshot first.</p>\n  <div>\n    <button (click)=\"add()\" class=\"btn btn-primary\" translate>\n      Add configuration snapshot\n    </button>\n  </div>\n  <p c8y-guide-docs>\n    <small translate\n      >Find out more in the\n      <a c8y-guide-href=\"users-guide/device-management/#configuration-repository\"\n        >User guide`KEEP_ORIGINAL`</a\n      >.</small\n    >\n  </p>\n</div>\n\n<ng-template #notFound>\n  <c8y-li class=\"p-8 text-center\">\n    <p>\n      <span translate>No more entries found for filter:</span>&nbsp;<strong>{{\n        filterTerm\n      }}</strong>\n    </p>\n    <button class=\"btn btn-primary btn-xs m-t-8\" translate (click)=\"setPipe(''); reset()\">\n      Reset filter\n    </button>\n  </c8y-li>\n</ng-template>\n<div class=\"p-b-32\">\n  <c8y-list-group>\n    <c8y-li\n      *c8yFor=\"\n        let configuration of configurations$;\n        pipe: filterPipe;\n        notFound: this.filterTerm ? notFound : undefined\n      \"\n    >\n      <c8y-li-icon icon=\"gears\"></c8y-li-icon>\n      <div class=\"row flex-row\">\n        <div class=\"col-xs-2\">\n          <div class=\"text-truncate\" title=\"{{ configuration.name || '-' }}\">\n            <c8y-highlight\n              [text]=\"configuration.name || '-'\"\n              elementClass=\"text-info\">\n            </c8y-highlight>\n          </div>\n        </div>\n        <div class=\"col-xs-3\">\n          <span class=\"text-muted text-truncate\" [title]=\"configuration.description\">\n            {{ configuration.description }}\n          </span>\n        </div>\n        <div class=\"col-xs-3\">\n          <span class=\"text-truncate\">\n            <small translate class=\"text-label-small m-r-4\">File</small>\n            <span\n              *ngIf=\"isBinaryFile(configuration); else noFile\"\n              title=\"{{ getBinaryName(configuration) | async }}\"\n            >\n              {{ getBinaryName(configuration) | async }}\n            </span>\n            <ng-template #noFile>\n              <span title=\"{{ configuration.url }}\">{{ configuration.url }}</span>\n            </ng-template>\n          </span>\n        </div>\n        <div class=\"col-xs-2\">\n          <div class=\"text-truncate\" title=\"{{'Device type' | translate}}: {{ configuration.deviceType || '-' }}\">\n            <small translate class=\"text-muted text-uppercase\">Device type</small>&nbsp;\n            <c8y-highlight\n              [text]=\"configuration.deviceType || '-'\"\n              elementClass=\"text-info\"\n              [pattern]=\"filterTerm\">\n            </c8y-highlight>\n          </div>\n        </div>\n        <div class=\"col-xs-2\">\n          <div class=\"text-right text-truncate\" title=\"{{ configuration.configurationType }}\">\n            <span class=\"label label-primary\" *ngIf=\"configuration.configurationType\">\n              <c8y-highlight\n                [text]=\"configuration.configurationType\"\n                elementClass=\"text-info\"\n                [pattern]=\"filterTerm\">\n              </c8y-highlight>\n            </span>\n          </div>\n        </div>\n      </div>\n      <c8y-li-action\n        (click)=\"edit(configuration)\"\n        icon=\"pencil\"\n        label=\"{{ 'Edit' | translate }}\"\n      ></c8y-li-action>\n      <c8y-li-action\n        (click)=\"delete(configuration)\"\n        icon=\"trash-o\"\n        label=\"{{ 'Delete' | translate }}\"\n      >\n      </c8y-li-action>\n      <c8y-li-action\n        *ngIf=\"isBinaryFile(configuration)\"\n        (click)=\"download(configuration)\"\n        icon=\"download\"\n        label=\"{{ 'Download' | translate }}\"\n      >\n      </c8y-li-action>\n    </c8y-li>\n  </c8y-list-group>\n</div>\n"
        })
    ], ConfigurationListComponent);
    return ConfigurationListComponent;
}());
export { ConfigurationListComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uZmlndXJhdGlvbi1saXN0LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvcmVwb3NpdG9yeS8iLCJzb3VyY2VzIjpbImNvbmZpZ3VyYXRpb24vY29uZmlndXJhdGlvbi1saXN0LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBZ0IsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ25FLE9BQU8sRUFBQyxjQUFjLEVBQUUsc0JBQXNCLEVBQUUsZ0JBQWdCLEVBQUUsV0FBVyxFQUFDLE1BQU0sYUFBYSxDQUFDO0FBQ2xHLE9BQU8sRUFDTCxZQUFZLEVBQ1osb0JBQW9CLEVBQ3BCLE9BQU8sRUFBRSxPQUFPLEVBQ2hCLFlBQVksRUFDWixNQUFNLEVBQ1AsTUFBTSxxQkFBcUIsQ0FBQztBQUM3QixPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN2RCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDckQsT0FBTyxFQUFjLEVBQUUsRUFBRSxJQUFJLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDNUMsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3JDLE9BQU8sRUFBYyxjQUFjLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNqRSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUMxRCxPQUFPLEVBQUUsNEJBQTRCLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQztBQUNoRixPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ3JDLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFNcEM7SUFRRSxvQ0FDVSxLQUFtQixFQUNuQixpQkFBb0MsRUFDcEMsY0FBOEIsRUFDOUIsWUFBMEIsRUFDMUIsZ0JBQWtDLEVBQ2xDLHNCQUE4QyxFQUM5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LE1BQU0sQ0FBQyxVQUFVLEdBQUcsRUFBRSxDQUFDO1FBQzVCLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDbkIsQ0FBQztJQUVPLHdEQUFtQixHQUEzQixVQUE0QixJQUFZLEVBQUUsVUFBa0I7UUFDMUQsSUFBTSxJQUFJLEdBQUcsVUFBVSxDQUFDLFdBQVcsRUFBRSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQzdDLE9BQU8sSUFBSSxJQUFJLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDdkQsQ0FBQzs7Z0JBaElnQixZQUFZO2dCQUNBLGlCQUFpQjtnQkFDcEIsY0FBYztnQkFDaEIsWUFBWTtnQkFDUixnQkFBZ0I7Z0JBQ1Ysc0JBQXNCO2dCQUM1QixnQkFBZ0I7O0lBZFE7UUFBbkQsU0FBUyxDQUFDLG9CQUFvQixFQUFFLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxDQUFDOzhEQUE4QjtJQXdFakY7UUFEQyxPQUFPLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO21FQUd2QjtJQTNFVSwwQkFBMEI7UUFKdEMsU0FBUyxDQUFDO1lBQ1QsUUFBUSxFQUFFLHdCQUF3QjtZQUNsQywyd0tBQWtEO1NBQ25ELENBQUM7T0FDVywwQkFBMEIsQ0EwSXRDO0lBQUQsaUNBQUM7Q0FBQSxBQTFJRCxJQTBJQztTQTFJWSwwQkFBMEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIE9uSW5pdCwgUGlwZSwgVmlld0NoaWxkIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge0lNYW5hZ2VkT2JqZWN0LCBJbnZlbnRvcnlCaW5hcnlTZXJ2aWNlLCBJbnZlbnRvcnlTZXJ2aWNlLCBJUmVzdWx0TGlzdH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHtcbiAgQWxlcnRTZXJ2aWNlLFxuICBGaWx0ZXJJbnB1dENvbXBvbmVudCxcbiAgZ2V0dGV4dCwgbWVtb2l6ZSxcbiAgTW9kYWxTZXJ2aWNlLFxuICBTdGF0dXNcbn0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQgeyBUcmFuc2xhdGVTZXJ2aWNlIH0gZnJvbSAnQG5neC10cmFuc2xhdGUvY29yZSc7XG5pbXBvcnQgeyBCc01vZGFsU2VydmljZSB9IGZyb20gJ25neC1ib290c3RyYXAvbW9kYWwnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YsIHBpcGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IE1vZGFsTW9kZWwsIFJlcG9zaXRvcnlUeXBlIH0gZnJvbSAnLi4vcmVwb3NpdG9yeS5tb2RlbCc7XG5pbXBvcnQgeyBSZXBvc2l0b3J5U2VydmljZSB9IGZyb20gJy4uL3JlcG9zaXRvcnkuc2VydmljZSc7XG5pbXBvcnQgeyBDb25maWd1cmF0aW9uRGV0YWlsQ29tcG9uZW50IH0gZnJvbSAnLi9jb25maWd1cmF0aW9uLWRldGFpbC5jb21wb25lbnQnO1xuaW1wb3J0IHsgcHJvcGVydHkgfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgc2F2ZUFzIH0gZnJvbSAnZmlsZS1zYXZlcic7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2M4eS1jb25maWd1cmF0aW9uLWxpc3QnLFxuICB0ZW1wbGF0ZVVybDogJy4vY29uZmlndXJhdGlvbi1saXN0LmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBDb25maWd1cmF0aW9uTGlzdENvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCB7XG4gIEBWaWV3Q2hpbGQoRmlsdGVySW5wdXRDb21wb25lbnQsIHsgc3RhdGljOiBmYWxzZSB9KSBmaWx0ZXI6IEZpbHRlcklucHV0Q29tcG9uZW50O1xuICBjb25maWd1cmF0aW9ucyQ6IE9ic2VydmFibGU8SVJlc3VsdExpc3Q8SU1hbmFnZWRPYmplY3Q+PjtcbiAgZmlsdGVyUGlwZTogUGlwZTtcbiAgZmlsdGVyVGVybSA9ICcnO1xuICByZWxvYWRpbmc6IGJvb2xlYW4gPSBmYWxzZTtcbiAgcHJpdmF0ZSByZWFkb25seSBERUxFVEVEX1NVQ0NFU1NfTVNHID0gZ2V0dGV4dCgnQ29uZmlndXJhdGlvbiBkZWxldGVkLicpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgYWxlcnQ6IEFsZXJ0U2VydmljZSxcbiAgICBwcml2YXRlIHJlcG9zaXRvcnlTZXJ2aWNlOiBSZXBvc2l0b3J5U2VydmljZSxcbiAgICBwcml2YXRlIGJzTW9kYWxTZXJ2aWNlOiBCc01vZGFsU2VydmljZSxcbiAgICBwcml2YXRlIG1vZGFsU2VydmljZTogTW9kYWxTZXJ2aWNlLFxuICAgIHByaXZhdGUgdHJhbnNsYXRlU2VydmljZTogVHJhbnNsYXRlU2VydmljZSxcbiAgICBwcml2YXRlIGludmVudG9yeUJpbmFyeVNlcnZpY2U6IEludmVudG9yeUJpbmFyeVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBpbnZlbnRvcnlTZXJ2aWNlOiBJbnZlbnRvcnlTZXJ2aWNlXG4gICkge31cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLmxvYWRDb25maWd1cmF0aW9ucygpO1xuICB9XG5cbiAgYXN5bmMgbG9hZENvbmZpZ3VyYXRpb25zKCkge1xuICAgIHRoaXMucmVsb2FkaW5nID0gdHJ1ZTtcbiAgICB0aGlzLmNvbmZpZ3VyYXRpb25zJCA9IG9mKFxuICAgICAgYXdhaXQgdGhpcy5yZXBvc2l0b3J5U2VydmljZS5saXN0UmVwb3NpdG9yeUVudHJpZXMoUmVwb3NpdG9yeVR5cGUuQ09ORklHVVJBVElPTilcbiAgICApO1xuICAgIHRoaXMucmVsb2FkaW5nID0gZmFsc2U7XG4gICAgdGhpcy5yZXNldCgpO1xuICB9XG5cbiAgYXN5bmMgYWRkKCkge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCAodGhpcy5ic01vZGFsU2VydmljZS5zaG93KENvbmZpZ3VyYXRpb25EZXRhaWxDb21wb25lbnQsIHtcbiAgICAgICAgY2xhc3M6ICdtb2RhbC1zbScsXG4gICAgICAgIGlnbm9yZUJhY2tkcm9wQ2xpY2s6IHRydWVcbiAgICAgIH0pLmNvbnRlbnQgYXMgQ29uZmlndXJhdGlvbkRldGFpbENvbXBvbmVudCkucmVzdWx0O1xuICAgICAgYXdhaXQgdGhpcy5sb2FkQ29uZmlndXJhdGlvbnMoKTtcbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgLy8gaW50ZW5kZWQgZW1wdHlcbiAgICB9XG4gIH1cblxuICBhc3luYyBlZGl0KGNvbmZpZ3VyYXRpb246IElNYW5hZ2VkT2JqZWN0KSB7XG4gICAgY29uc3QgZmlsZUJpbmFyeTogRmlsZSA9IGF3YWl0IHRoaXMucmVwb3NpdG9yeVNlcnZpY2UuZ2V0QmluYXJ5RmlsZShjb25maWd1cmF0aW9uLnVybCwge1xuICAgICAgYWxsb3dFeHRlcm5hbDogZmFsc2VcbiAgICB9KTtcbiAgICB0cnkge1xuICAgICAgY29uc3QgbW9kYWwgPSB0aGlzLmJzTW9kYWxTZXJ2aWNlLnNob3coQ29uZmlndXJhdGlvbkRldGFpbENvbXBvbmVudCwge1xuICAgICAgICBjbGFzczogJ21vZGFsLXNtJyxcbiAgICAgICAgaWdub3JlQmFja2Ryb3BDbGljazogdHJ1ZSxcbiAgICAgICAgaW5pdGlhbFN0YXRlOiB7XG4gICAgICAgICAgc2VsZWN0ZWQ6IHsgaWQ6IGNvbmZpZ3VyYXRpb24uaWQsIGNvbmZpZ3VyYXRpb25UeXBlOiBjb25maWd1cmF0aW9uLmNvbmZpZ3VyYXRpb25UeXBlIH0sXG4gICAgICAgICAgdmVyc2lvbjogY29uZmlndXJhdGlvbi5uYW1lLFxuICAgICAgICAgIGRldmljZVR5cGU6IGNvbmZpZ3VyYXRpb24uZGV2aWNlVHlwZSxcbiAgICAgICAgICBkZXNjcmlwdGlvbjogY29uZmlndXJhdGlvbi5kZXNjcmlwdGlvbixcbiAgICAgICAgICBiaW5hcnk6IHsgZmlsZTogZmlsZUJpbmFyeSwgdXJsOiBjb25maWd1cmF0aW9uLnVybCB9XG4gICAgICAgIH0gYXMgTW9kYWxNb2RlbFxuICAgICAgfSkuY29udGVudCBhcyBDb25maWd1cmF0aW9uRGV0YWlsQ29tcG9uZW50O1xuICAgICAgbW9kYWwubW8gPSBjb25maWd1cmF0aW9uO1xuICAgICAgYXdhaXQgbW9kYWwucmVzdWx0O1xuICAgICAgYXdhaXQgdGhpcy5sb2FkQ29uZmlndXJhdGlvbnMoKTtcbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgLy8gaW50ZW5kZWQgZW1wdHlcbiAgICB9XG4gIH1cblxuICBpc0JpbmFyeUZpbGUoY29uZmlndXJhdGlvbjogSU1hbmFnZWRPYmplY3QpIHtcbiAgICBjb25zdCBpZDogc3RyaW5nID0gdGhpcy5pbnZlbnRvcnlCaW5hcnlTZXJ2aWNlLmdldElkRnJvbVVybChjb25maWd1cmF0aW9uLnVybCk7XG4gICAgcmV0dXJuIGlkID8gdHJ1ZSA6IGZhbHNlO1xuICB9XG5cbiAgQG1lbW9pemUocHJvcGVydHkoJ2lkJykpXG4gIGdldEJpbmFyeU5hbWUoY29uZmlndXJhdGlvbjogSU1hbmFnZWRPYmplY3QpIHtcbiAgICByZXR1cm4gdGhpcy5yZXBvc2l0b3J5U2VydmljZS5nZXRCaW5hcnlOYW1lJChjb25maWd1cmF0aW9uLnVybCk7XG4gIH1cblxuICBhc3luYyBkb3dubG9hZChjb25maWd1cmF0aW9uOiBJTWFuYWdlZE9iamVjdCkge1xuICAgIGNvbnN0IGZpbGVCaW5hcnk6IEZpbGUgPSBhd2FpdCB0aGlzLnJlcG9zaXRvcnlTZXJ2aWNlLmdldEJpbmFyeUZpbGUoY29uZmlndXJhdGlvbi51cmwsIHtcbiAgICAgIGFsbG93RXh0ZXJuYWw6IGZhbHNlXG4gICAgfSk7XG4gICAgc2F2ZUFzKGZpbGVCaW5hcnkpO1xuICB9XG5cbiAgYXN5bmMgZGVsZXRlKGNvbmZpZ3VyYXRpb246IElNYW5hZ2VkT2JqZWN0KSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHRpdGxlID0gZ2V0dGV4dCgnRGVsZXRlIGNvbmZpZ3VyYXRpb24gc25hcHNob3QnKTtcbiAgICAgIGNvbnN0IGNvbmZpcm1hdGlvblRleHQgPSBnZXR0ZXh0KFxuICAgICAgICAnWW91IGFyZSBhYm91dCB0byBkZWxldGUgdGhlIGNvbmZpZ3VyYXRpb24gc25hcHNob3Qge3sgbmFtZSB9fS4nXG4gICAgICApO1xuICAgICAgY29uc3QgaGludCA9IGdldHRleHQoJ1RoaXMgb3BlcmF0aW9uIGlzIGlycmV2ZXJzaWJsZS4nKTtcbiAgICAgIGNvbnN0IHByb2NlZWQgPSBnZXR0ZXh0KCdEbyB5b3Ugd2FudCB0byBwcm9jZWVkPycpO1xuICAgICAgY29uc3QgYm9keSA9IFtcbiAgICAgICAgdGhpcy50cmFuc2xhdGVTZXJ2aWNlLmluc3RhbnQoY29uZmlybWF0aW9uVGV4dCwge1xuICAgICAgICAgIG5hbWU6IGNvbmZpZ3VyYXRpb24ubmFtZVxuICAgICAgICB9KSxcbiAgICAgICAgdGhpcy50cmFuc2xhdGVTZXJ2aWNlLmluc3RhbnQoaGludCksXG4gICAgICAgIHRoaXMudHJhbnNsYXRlU2VydmljZS5pbnN0YW50KHByb2NlZWQpXG4gICAgICBdLmpvaW4oJyAnKTtcbiAgICAgIGNvbnN0IGxhYmVscyA9IHtcbiAgICAgICAgb2s6IGdldHRleHQoJ0RlbGV0ZScpXG4gICAgICB9O1xuICAgICAgYXdhaXQgdGhpcy5tb2RhbFNlcnZpY2UuY29uZmlybSh0aXRsZSwgYm9keSwgU3RhdHVzLkRBTkdFUiwgbGFiZWxzKTtcbiAgICAgIGF3YWl0IHRoaXMucmVwb3NpdG9yeVNlcnZpY2UuZGVsZXRlKGNvbmZpZ3VyYXRpb24pO1xuICAgICAgdGhpcy5hbGVydC5zdWNjZXNzKHRoaXMuREVMRVRFRF9TVUNDRVNTX01TRyk7XG4gICAgICBhd2FpdCB0aGlzLmxvYWRDb25maWd1cmF0aW9ucygpO1xuICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICBpZiAoZXgpIHtcbiAgICAgICAgdGhpcy5hbGVydC5hZGRTZXJ2ZXJGYWlsdXJlKGV4KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBzZXRQaXBlKGZpbHRlclRlcm06IHN0cmluZykge1xuICAgIHRoaXMuZmlsdGVyVGVybSA9IGZpbHRlclRlcm07XG4gICAgdGhpcy5maWx0ZXJQaXBlID0gcGlwZShcbiAgICAgIG1hcCgoZGF0YTogW10pID0+XG4gICAgICAgIGZpbHRlclRlcm0udHJpbSgpLmxlbmd0aCA9PT0gMFxuICAgICAgICAgID8gZGF0YVxuICAgICAgICAgIDogZGF0YS5maWx0ZXIoXG4gICAgICAgICAgICAgIChtbzogSU1hbmFnZWRPYmplY3QpID0+XG4gICAgICAgICAgICAgICAgdGhpcy5maWx0ZXJDb250YWluU3RyaW5nKG1vLm5hbWUsIGZpbHRlclRlcm0pIHx8XG4gICAgICAgICAgICAgICAgdGhpcy5maWx0ZXJDb250YWluU3RyaW5nKG1vLmNvbmZpZ3VyYXRpb25UeXBlLCBmaWx0ZXJUZXJtKSB8fFxuICAgICAgICAgICAgICAgIHRoaXMuZmlsdGVyQ29udGFpblN0cmluZyhtby5kZXZpY2VUeXBlLCBmaWx0ZXJUZXJtKVxuICAgICAgICAgICAgKVxuICAgICAgKVxuICAgICk7XG4gIH1cblxuICByZXNldCgpIHtcbiAgICB0aGlzLmZpbHRlci5maWx0ZXJUZXJtID0gJyc7XG4gICAgdGhpcy5zZXRQaXBlKCcnKTtcbiAgfVxuXG4gIHByaXZhdGUgZmlsdGVyQ29udGFpblN0cmluZyhuYW1lOiBzdHJpbmcsIGZpbHRlclRlcm06IHN0cmluZykge1xuICAgIGNvbnN0IHRlcm0gPSBmaWx0ZXJUZXJtLnRvTG93ZXJDYXNlKCkudHJpbSgpO1xuICAgIHJldHVybiBuYW1lICYmIG5hbWUudG9Mb3dlckNhc2UoKS5pbmRleE9mKHRlcm0pID4gLTE7XG4gIH1cbn1cbiJdfQ==