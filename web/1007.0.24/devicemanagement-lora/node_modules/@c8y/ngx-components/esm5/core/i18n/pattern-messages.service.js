import * as tslib_1 from "tslib";
import { Injectable, Inject } from '@angular/core';
import { mapValues, each } from 'lodash-es';
import { HOOK_PATTERN_MESSAGES } from './patterns-message.hook';
import { formatDate } from '@angular/common';
import * as i0 from "@angular/core";
import * as i1 from "./patterns-message.hook";
/**
 * A service to translate messages by using regexp patterns.
 */
var PatternMessagesService = /** @class */ (function () {
    function PatternMessagesService(patterns) {
        var _this = this;
        this.patterns = {};
        this.pipes = {
            absoluteDate: function (date) {
                return formatDate(date, 'medium', _this.translateService.currentLang);
            },
            translate: function (key) {
                return _this.translateService.instant(key);
            }
        };
        each(patterns, function (pattern) {
            Object.assign(_this.patterns, pattern);
        });
    }
    PatternMessagesService.prototype.translate = function (message) {
        var translation = this.translateWithPatterns(message);
        return (translation !== message) ? translation : '';
    };
    PatternMessagesService.prototype.translateWithPatterns = function (message, patterns) {
        var _this = this;
        if (patterns === void 0) { patterns = this.patterns; }
        var translatedMessage = message;
        each(patterns, function (patternCfg, pattern) {
            var globalRegExp = new RegExp(pattern, 'g');
            var globalMatch;
            if (!globalRegExp.test(translatedMessage)) {
                return;
            }
            globalRegExp.test(''); // reset the regexp
            globalMatch = globalRegExp.exec(translatedMessage);
            var _loop_1 = function () {
                var _a = tslib_1.__read(globalMatch, 1), localMatch = _a[0];
                var placeholderValues = mapValues(patternCfg.placeholders, function (placeholder) {
                    var expr = placeholder.capture || placeholder;
                    var replacement = localMatch.replace(new RegExp(pattern, 'g'), expr);
                    if (placeholder.translate) {
                        replacement = _this.translateWithPatterns(replacement, placeholder.translate);
                    }
                    return replacement;
                });
                translatedMessage = translatedMessage.replace(localMatch, _this.translateWithParams(patternCfg, placeholderValues));
                globalMatch = globalRegExp.exec(translatedMessage);
            };
            while (globalMatch !== null) {
                _loop_1();
            }
        });
        return translatedMessage;
    };
    PatternMessagesService.prototype.translateWithParams = function (patternCfg, params) {
        if (params === void 0) { params = {}; }
        var _a = this.translateService, defaultLang = _a.defaultLang, currentLang = _a.currentLang, compiler = _a.compiler;
        var translations = this.translateService.store.translations[currentLang];
        var defaultTranslations = this.translateService.store.translations[defaultLang];
        var originalKey = patternCfg.gettext;
        var originalValue = originalKey;
        if (translations) {
            if (translations[originalKey]) {
                originalValue = translations[originalKey];
            }
            else if (defaultTranslations) {
                if (defaultTranslations[originalKey]) {
                    originalValue = defaultTranslations[originalKey];
                }
            }
        }
        var key = originalKey;
        var value = originalValue;
        var interpolateParams = tslib_1.__assign({}, params, { noPatternMessages: true });
        var match;
        var pipeRegex = RegExp('{{\\s*([^\\s]+)\\s*\\|\\s*([^\\s]+)\\s*}}', 'g');
        // tslint:disable-next-line:no-conditional-assignment
        while ((match = pipeRegex.exec(originalKey)) !== null) {
            var _b = tslib_1.__read(match, 3), placeholder = _b[0], paramName = _b[1], pipeName = _b[2];
            if (this.pipes[pipeName]) {
                key = key.replace(placeholder, "{{" + paramName + "}}");
                value = value.replace(placeholder, "{{" + paramName + "}}");
                interpolateParams[paramName] = this.pipes[pipeName](params[paramName]);
            }
        }
        if (translations) {
            translations[key] = compiler.compile(value, currentLang);
        }
        return this.translateService.instant(key, interpolateParams);
    };
    PatternMessagesService.ctorParameters = function () { return [
        { type: undefined, decorators: [{ type: Inject, args: [HOOK_PATTERN_MESSAGES,] }] }
    ]; };
    PatternMessagesService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function PatternMessagesService_Factory() { return new PatternMessagesService(i0.ɵɵinject(i1.HOOK_PATTERN_MESSAGES)); }, token: PatternMessagesService, providedIn: "root" });
    PatternMessagesService = tslib_1.__decorate([
        Injectable({
            providedIn: 'root'
        }),
        tslib_1.__param(0, Inject(HOOK_PATTERN_MESSAGES))
    ], PatternMessagesService);
    return PatternMessagesService;
}());
export { PatternMessagesService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGF0dGVybi1tZXNzYWdlcy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGM4eS9uZ3gtY29tcG9uZW50cy8iLCJzb3VyY2VzIjpbImNvcmUvaTE4bi9wYXR0ZXJuLW1lc3NhZ2VzLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRW5ELE9BQU8sRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQzVDLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQ2hFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQzs7O0FBRTdDOztHQUVHO0FBSUg7SUFVRSxnQ0FDaUMsUUFBUTtRQUR6QyxpQkFNQztRQWRELGFBQVEsR0FBUSxFQUFFLENBQUM7UUFDbkIsVUFBSyxHQUFHO1lBQ04sWUFBWSxFQUFFLFVBQUMsSUFBd0I7Z0JBQ3JDLE9BQUEsVUFBVSxDQUFDLElBQUksRUFBRSxRQUFRLEVBQUUsS0FBSSxDQUFDLGdCQUFnQixDQUFDLFdBQVcsQ0FBQztZQUE3RCxDQUE2RDtZQUMvRCxTQUFTLEVBQUUsVUFBQyxHQUFHO2dCQUNiLE9BQUEsS0FBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUM7WUFBbEMsQ0FBa0M7U0FDckMsQ0FBQztRQUtBLElBQUksQ0FBQyxRQUFRLEVBQUUsVUFBQyxPQUFPO1lBQ3JCLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSSxDQUFDLFFBQVEsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUN4QyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCwwQ0FBUyxHQUFULFVBQVUsT0FBZTtRQUN2QixJQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMscUJBQXFCLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDeEQsT0FBTyxDQUFDLFdBQVcsS0FBSyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7SUFDdEQsQ0FBQztJQUVPLHNEQUFxQixHQUE3QixVQUE4QixPQUFPLEVBQUUsUUFBd0I7UUFBL0QsaUJBa0NDO1FBbENzQyx5QkFBQSxFQUFBLFdBQVcsSUFBSSxDQUFDLFFBQVE7UUFDN0QsSUFBSSxpQkFBaUIsR0FBRyxPQUFPLENBQUM7UUFFaEMsSUFBSSxDQUFDLFFBQVEsRUFBRSxVQUFDLFVBQVUsRUFBRSxPQUFPO1lBQ2pDLElBQU0sWUFBWSxHQUFHLElBQUksTUFBTSxDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUMsQ0FBQztZQUM5QyxJQUFJLFdBQVcsQ0FBQztZQUVoQixJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFO2dCQUN6QyxPQUFPO2FBQ1I7WUFDRCxZQUFZLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsbUJBQW1CO1lBQzFDLFdBQVcsR0FBRyxZQUFZLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUM7O2dCQUUzQyxJQUFBLG1DQUE0QixFQUExQixrQkFBMEIsQ0FBQztnQkFFbkMsSUFBTSxpQkFBaUIsR0FBRyxTQUFTLENBQUMsVUFBVSxDQUFDLFlBQVksRUFBRSxVQUFDLFdBQVc7b0JBQ3ZFLElBQU0sSUFBSSxHQUFHLFdBQVcsQ0FBQyxPQUFPLElBQUksV0FBVyxDQUFDO29CQUNoRCxJQUFJLFdBQVcsR0FBRyxVQUFVLENBQUMsT0FBTyxDQUFDLElBQUksTUFBTSxDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQztvQkFFckUsSUFBSSxXQUFXLENBQUMsU0FBUyxFQUFFO3dCQUN6QixXQUFXLEdBQUcsS0FBSSxDQUFDLHFCQUFxQixDQUFDLFdBQVcsRUFBRSxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUM7cUJBQzlFO29CQUVELE9BQU8sV0FBVyxDQUFDO2dCQUNyQixDQUFDLENBQUMsQ0FBQztnQkFDSCxpQkFBaUIsR0FBRyxpQkFBaUIsQ0FBQyxPQUFPLENBQzNDLFVBQVUsRUFDVixLQUFJLENBQUMsbUJBQW1CLENBQUMsVUFBVSxFQUFFLGlCQUFpQixDQUFDLENBQ3hELENBQUM7Z0JBRUYsV0FBVyxHQUFHLFlBQVksQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQzs7WUFsQnJELE9BQU8sV0FBVyxLQUFLLElBQUk7O2FBbUIxQjtRQUNILENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxpQkFBaUIsQ0FBQztJQUMzQixDQUFDO0lBRU8sb0RBQW1CLEdBQTNCLFVBQTRCLFVBQWUsRUFBRSxNQUFnQjtRQUFoQix1QkFBQSxFQUFBLFdBQWdCO1FBQ3JELElBQUEsMEJBQThELEVBQTVELDRCQUFXLEVBQUUsNEJBQVcsRUFBRSxzQkFBa0MsQ0FBQztRQUNyRSxJQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUMzRSxJQUFNLG1CQUFtQixHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ2xGLElBQU0sV0FBVyxHQUFHLFVBQVUsQ0FBQyxPQUFPLENBQUM7UUFFdkMsSUFBSSxhQUFhLEdBQUcsV0FBVyxDQUFDO1FBQ2hDLElBQUksWUFBWSxFQUFFO1lBQ2hCLElBQUksWUFBWSxDQUFDLFdBQVcsQ0FBQyxFQUFFO2dCQUM3QixhQUFhLEdBQUcsWUFBWSxDQUFDLFdBQVcsQ0FBQyxDQUFDO2FBQzNDO2lCQUFNLElBQUksbUJBQW1CLEVBQUU7Z0JBQzlCLElBQUksbUJBQW1CLENBQUMsV0FBVyxDQUFDLEVBQUU7b0JBQ3BDLGFBQWEsR0FBRyxtQkFBbUIsQ0FBQyxXQUFXLENBQUMsQ0FBQztpQkFDbEQ7YUFDRjtTQUNGO1FBRUQsSUFBSSxHQUFHLEdBQUcsV0FBVyxDQUFDO1FBQ3RCLElBQUksS0FBSyxHQUFHLGFBQWEsQ0FBQztRQUMxQixJQUFNLGlCQUFpQix3QkFDbEIsTUFBTSxJQUNULGlCQUFpQixFQUFFLElBQUksR0FDeEIsQ0FBQztRQUVGLElBQUksS0FBSyxDQUFDO1FBQ1YsSUFBTSxTQUFTLEdBQUcsTUFBTSxDQUFDLDJDQUEyQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQzNFLHFEQUFxRDtRQUNyRCxPQUFPLENBQUMsS0FBSyxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsS0FBSyxJQUFJLEVBQUU7WUFDL0MsSUFBQSw2QkFBMEMsRUFBekMsbUJBQVcsRUFBRSxpQkFBUyxFQUFFLGdCQUFpQixDQUFDO1lBQ2pELElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsRUFBRTtnQkFDeEIsR0FBRyxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsV0FBVyxFQUFFLE9BQUssU0FBUyxPQUFJLENBQUMsQ0FBQztnQkFDbkQsS0FBSyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsV0FBVyxFQUFFLE9BQUssU0FBUyxPQUFJLENBQUMsQ0FBQztnQkFDdkQsaUJBQWlCLENBQUMsU0FBUyxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQzthQUN4RTtTQUNGO1FBRUQsSUFBSSxZQUFZLEVBQUU7WUFDaEIsWUFBWSxDQUFDLEdBQUcsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLFdBQVcsQ0FBQyxDQUFDO1NBQzFEO1FBQ0QsT0FBTyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxpQkFBaUIsQ0FBQyxDQUFDO0lBQy9ELENBQUM7O2dEQXhGRSxNQUFNLFNBQUMscUJBQXFCOzs7SUFYcEIsc0JBQXNCO1FBSGxDLFVBQVUsQ0FBQztZQUNWLFVBQVUsRUFBRSxNQUFNO1NBQ25CLENBQUM7UUFZRyxtQkFBQSxNQUFNLENBQUMscUJBQXFCLENBQUMsQ0FBQTtPQVhyQixzQkFBc0IsQ0FvR2xDO2lDQWhIRDtDQWdIQyxBQXBHRCxJQW9HQztTQXBHWSxzQkFBc0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3QgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFRyYW5zbGF0ZVNlcnZpY2UgfSBmcm9tICdAbmd4LXRyYW5zbGF0ZS9jb3JlJztcbmltcG9ydCB7IG1hcFZhbHVlcywgZWFjaCB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBIT09LX1BBVFRFUk5fTUVTU0FHRVMgfSBmcm9tICcuL3BhdHRlcm5zLW1lc3NhZ2UuaG9vayc7XG5pbXBvcnQgeyBmb3JtYXREYXRlIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcblxuLyoqXG4gKiBBIHNlcnZpY2UgdG8gdHJhbnNsYXRlIG1lc3NhZ2VzIGJ5IHVzaW5nIHJlZ2V4cCBwYXR0ZXJucy5cbiAqL1xuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgUGF0dGVybk1lc3NhZ2VzU2VydmljZSB7XG4gIHRyYW5zbGF0ZVNlcnZpY2U6IFRyYW5zbGF0ZVNlcnZpY2U7XG4gIHBhdHRlcm5zOiBhbnkgPSB7fTtcbiAgcGlwZXMgPSB7XG4gICAgYWJzb2x1dGVEYXRlOiAoZGF0ZTogc3RyaW5nfG51bWJlcnxEYXRlKSA9PlxuICAgICAgZm9ybWF0RGF0ZShkYXRlLCAnbWVkaXVtJywgdGhpcy50cmFuc2xhdGVTZXJ2aWNlLmN1cnJlbnRMYW5nKSxcbiAgICB0cmFuc2xhdGU6IChrZXkpID0+XG4gICAgICB0aGlzLnRyYW5zbGF0ZVNlcnZpY2UuaW5zdGFudChrZXkpXG4gIH07XG5cbiAgY29uc3RydWN0b3IoXG4gICAgQEluamVjdChIT09LX1BBVFRFUk5fTUVTU0FHRVMpIHBhdHRlcm5zXG4gICkge1xuICAgIGVhY2gocGF0dGVybnMsIChwYXR0ZXJuKSA9PiB7XG4gICAgICBPYmplY3QuYXNzaWduKHRoaXMucGF0dGVybnMsIHBhdHRlcm4pO1xuICAgIH0pO1xuICB9XG5cbiAgdHJhbnNsYXRlKG1lc3NhZ2U6IHN0cmluZykge1xuICAgIGNvbnN0IHRyYW5zbGF0aW9uID0gdGhpcy50cmFuc2xhdGVXaXRoUGF0dGVybnMobWVzc2FnZSk7XG4gICAgcmV0dXJuICh0cmFuc2xhdGlvbiAhPT0gbWVzc2FnZSkgPyB0cmFuc2xhdGlvbiA6ICcnO1xuICB9XG5cbiAgcHJpdmF0ZSB0cmFuc2xhdGVXaXRoUGF0dGVybnMobWVzc2FnZSwgcGF0dGVybnMgPSB0aGlzLnBhdHRlcm5zKSB7XG4gICAgbGV0IHRyYW5zbGF0ZWRNZXNzYWdlID0gbWVzc2FnZTtcblxuICAgIGVhY2gocGF0dGVybnMsIChwYXR0ZXJuQ2ZnLCBwYXR0ZXJuKSA9PiB7XG4gICAgICBjb25zdCBnbG9iYWxSZWdFeHAgPSBuZXcgUmVnRXhwKHBhdHRlcm4sICdnJyk7XG4gICAgICBsZXQgZ2xvYmFsTWF0Y2g7XG5cbiAgICAgIGlmICghZ2xvYmFsUmVnRXhwLnRlc3QodHJhbnNsYXRlZE1lc3NhZ2UpKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGdsb2JhbFJlZ0V4cC50ZXN0KCcnKTsgLy8gcmVzZXQgdGhlIHJlZ2V4cFxuICAgICAgZ2xvYmFsTWF0Y2ggPSBnbG9iYWxSZWdFeHAuZXhlYyh0cmFuc2xhdGVkTWVzc2FnZSk7XG4gICAgICB3aGlsZSAoZ2xvYmFsTWF0Y2ggIT09IG51bGwpIHtcbiAgICAgICAgY29uc3QgWyBsb2NhbE1hdGNoIF0gPSBnbG9iYWxNYXRjaDtcblxuICAgICAgICBjb25zdCBwbGFjZWhvbGRlclZhbHVlcyA9IG1hcFZhbHVlcyhwYXR0ZXJuQ2ZnLnBsYWNlaG9sZGVycywgKHBsYWNlaG9sZGVyKSA9PiB7XG4gICAgICAgICAgY29uc3QgZXhwciA9IHBsYWNlaG9sZGVyLmNhcHR1cmUgfHwgcGxhY2Vob2xkZXI7XG4gICAgICAgICAgbGV0IHJlcGxhY2VtZW50ID0gbG9jYWxNYXRjaC5yZXBsYWNlKG5ldyBSZWdFeHAocGF0dGVybiwgJ2cnKSwgZXhwcik7XG5cbiAgICAgICAgICBpZiAocGxhY2Vob2xkZXIudHJhbnNsYXRlKSB7XG4gICAgICAgICAgICByZXBsYWNlbWVudCA9IHRoaXMudHJhbnNsYXRlV2l0aFBhdHRlcm5zKHJlcGxhY2VtZW50LCBwbGFjZWhvbGRlci50cmFuc2xhdGUpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiByZXBsYWNlbWVudDtcbiAgICAgICAgfSk7XG4gICAgICAgIHRyYW5zbGF0ZWRNZXNzYWdlID0gdHJhbnNsYXRlZE1lc3NhZ2UucmVwbGFjZShcbiAgICAgICAgICBsb2NhbE1hdGNoLFxuICAgICAgICAgIHRoaXMudHJhbnNsYXRlV2l0aFBhcmFtcyhwYXR0ZXJuQ2ZnLCBwbGFjZWhvbGRlclZhbHVlcylcbiAgICAgICAgKTtcblxuICAgICAgICBnbG9iYWxNYXRjaCA9IGdsb2JhbFJlZ0V4cC5leGVjKHRyYW5zbGF0ZWRNZXNzYWdlKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gdHJhbnNsYXRlZE1lc3NhZ2U7XG4gIH1cblxuICBwcml2YXRlIHRyYW5zbGF0ZVdpdGhQYXJhbXMocGF0dGVybkNmZzogYW55LCBwYXJhbXM6IGFueSA9IHt9KSB7XG4gICAgY29uc3QgeyBkZWZhdWx0TGFuZywgY3VycmVudExhbmcsIGNvbXBpbGVyIH0gPSB0aGlzLnRyYW5zbGF0ZVNlcnZpY2U7XG4gICAgY29uc3QgdHJhbnNsYXRpb25zID0gdGhpcy50cmFuc2xhdGVTZXJ2aWNlLnN0b3JlLnRyYW5zbGF0aW9uc1tjdXJyZW50TGFuZ107XG4gICAgY29uc3QgZGVmYXVsdFRyYW5zbGF0aW9ucyA9IHRoaXMudHJhbnNsYXRlU2VydmljZS5zdG9yZS50cmFuc2xhdGlvbnNbZGVmYXVsdExhbmddO1xuICAgIGNvbnN0IG9yaWdpbmFsS2V5ID0gcGF0dGVybkNmZy5nZXR0ZXh0O1xuXG4gICAgbGV0IG9yaWdpbmFsVmFsdWUgPSBvcmlnaW5hbEtleTtcbiAgICBpZiAodHJhbnNsYXRpb25zKSB7XG4gICAgICBpZiAodHJhbnNsYXRpb25zW29yaWdpbmFsS2V5XSkge1xuICAgICAgICBvcmlnaW5hbFZhbHVlID0gdHJhbnNsYXRpb25zW29yaWdpbmFsS2V5XTtcbiAgICAgIH0gZWxzZSBpZiAoZGVmYXVsdFRyYW5zbGF0aW9ucykge1xuICAgICAgICBpZiAoZGVmYXVsdFRyYW5zbGF0aW9uc1tvcmlnaW5hbEtleV0pIHtcbiAgICAgICAgICBvcmlnaW5hbFZhbHVlID0gZGVmYXVsdFRyYW5zbGF0aW9uc1tvcmlnaW5hbEtleV07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBsZXQga2V5ID0gb3JpZ2luYWxLZXk7XG4gICAgbGV0IHZhbHVlID0gb3JpZ2luYWxWYWx1ZTtcbiAgICBjb25zdCBpbnRlcnBvbGF0ZVBhcmFtcyA9IHtcbiAgICAgIC4uLnBhcmFtcyxcbiAgICAgIG5vUGF0dGVybk1lc3NhZ2VzOiB0cnVlXG4gICAgfTtcblxuICAgIGxldCBtYXRjaDtcbiAgICBjb25zdCBwaXBlUmVnZXggPSBSZWdFeHAoJ3t7XFxcXHMqKFteXFxcXHNdKylcXFxccypcXFxcfFxcXFxzKihbXlxcXFxzXSspXFxcXHMqfX0nLCAnZycpO1xuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1jb25kaXRpb25hbC1hc3NpZ25tZW50XG4gICAgd2hpbGUgKChtYXRjaCA9IHBpcGVSZWdleC5leGVjKG9yaWdpbmFsS2V5KSkgIT09IG51bGwpIHtcbiAgICAgIGNvbnN0IFtwbGFjZWhvbGRlciwgcGFyYW1OYW1lLCBwaXBlTmFtZV0gPSBtYXRjaDtcbiAgICAgIGlmICh0aGlzLnBpcGVzW3BpcGVOYW1lXSkge1xuICAgICAgICBrZXkgPSBrZXkucmVwbGFjZShwbGFjZWhvbGRlciwgYHt7JHtwYXJhbU5hbWV9fX1gKTtcbiAgICAgICAgdmFsdWUgPSB2YWx1ZS5yZXBsYWNlKHBsYWNlaG9sZGVyLCBge3ske3BhcmFtTmFtZX19fWApO1xuICAgICAgICBpbnRlcnBvbGF0ZVBhcmFtc1twYXJhbU5hbWVdID0gdGhpcy5waXBlc1twaXBlTmFtZV0ocGFyYW1zW3BhcmFtTmFtZV0pO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICh0cmFuc2xhdGlvbnMpIHtcbiAgICAgIHRyYW5zbGF0aW9uc1trZXldID0gY29tcGlsZXIuY29tcGlsZSh2YWx1ZSwgY3VycmVudExhbmcpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy50cmFuc2xhdGVTZXJ2aWNlLmluc3RhbnQoa2V5LCBpbnRlcnBvbGF0ZVBhcmFtcyk7XG4gIH1cbn1cbiJdfQ==